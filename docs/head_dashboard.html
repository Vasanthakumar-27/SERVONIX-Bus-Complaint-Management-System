<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SERVONIX - Head Control Center</title>
    <link rel="icon" type="image/png" href="assets/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Purple/Cyan Light Theme (Default - Image 1) */
            --bg-900: #21004B;
            --bg-800: #2D0B5A;
            --bg-700: #3D1B69;
            --card-bg: rgba(33, 0, 75, 0.94);
            --border: rgba(0, 255, 255, 0.4);
            --primary: #00FFFF;
            --primary-soft: rgba(0, 255, 255, 0.15);
            --gold: #FFD700;
            --gold-soft: rgba(255, 215, 0, 0.15);
            --green: #16c782;
            --red: #ef5b5b;
            --blue: #1976D2;
            --text-100: #FFFFFF;
            --text-200: #C0C0C0;
            --text-400: #A0AEC0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --radius-lg: 18px;
            --radius-md: 12px;
            --transition: all 0.25s ease;
        }

        body.dark-mode {
            /* Black/Gold Dark Theme (Image 2) */
            --bg-900: #000000;
            --bg-800: #0a0a0a;
            --bg-700: #1a1a1a;
            --card-bg: rgba(20, 20, 20, 0.95);
            --border: rgba(255, 215, 0, 0.3);
            --primary: #FFD700;
            --primary-soft: rgba(255, 215, 0, 0.15);
            --gold: #FFD700;
            --gold-soft: rgba(255, 215, 0, 0.15);
            --text-100: #FFFFFF;
            --text-200: #C0C0C0;
            --text-400: #808080;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
            overflow-x: hidden;
        }

        body {
            margin: 0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-900);
            color: var(--text-100);
            min-height: 100vh;
            display: flex;
            transition: background 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            width: 100%;
        }

        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 99999;
            display: grid;
            gap: 12px;
        }

        .toast {
            min-width: 280px;
            max-width: 360px;
            padding: 14px 18px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow);
            background: var(--card-bg);
            border-left: 4px solid var(--primary);
            animation: slideIn 0.25s ease;
        }

        .toast.success { border-left-color: var(--green); }
        .toast.error { border-left-color: var(--red); }
        .toast.warning { border-left-color: #f5a623; }

        @keyframes slideIn {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .dashboard-shell {
            display: flex;
            width: 100%;
            max-width: 100vw;
            background: var(--bg-900);
            overflow-x: hidden;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--bg-900) 0%, rgba(var(--bg-900), 0.98) 100%);
            backdrop-filter: blur(20px);
            border-right: 2px solid var(--border);
            padding: 32px 24px;
            display: flex;
            flex-direction: column;
            gap: 32px;
            position: sticky;
            top: 0;
            height: 100vh;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            padding: 0;
            border-radius: var(--radius-lg);
        }

        .brand i {
            font-size: 48px;
            color: var(--primary);
        }
        
        body.dark-mode .brand i {
            color: #D5A846;
        }

        .brand h1 {
            margin: 0;
            font-size: 26px;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #FFFFFF;
        }

        .brand span {
            display: block;
            margin-top: 6px;
            color: #C0C0C0;
            font-size: 11px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .head-chip {
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(213,168,70,0.35), rgba(255,215,0,0.25));
            backdrop-filter: blur(10px);
            border-radius: var(--radius-md);
            border: 2px solid rgba(213, 168, 70, 0.4);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            max-width: fit-content;
        }
        
        body.dark-mode .head-chip {
            background: linear-gradient(135deg, rgba(213,168,70,0.25), rgba(255,215,0,0.15));
            border: 2px solid #D5A846;
        }

        .head-chip i {
            background: linear-gradient(135deg, rgba(0,0,0,0.5), rgba(0,0,0,0.3));
            padding: 10px;
            border-radius: 50%;
            color: var(--primary);
            font-size: 1rem;
        }
        
        body.dark-mode .head-chip i {
            color: #D5A846;
        }

        .nav-section {
            display: grid;
            gap: 8px;
        }

        .nav-section h2 {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #A0AEC0;
            margin: 0 0 8px 12px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            border-radius: var(--radius-md);
            color: #E2E8F0;
            cursor: pointer;
            font-weight: 500;
        }

        .nav-link i {
            width: 24px;
            text-align: center;
            color: #CBD5E0;
            font-size: 18px;
        }

        .nav-link.active,
        .nav-link:hover {
            background: var(--primary-soft);
            color: #FFFFFF;
        }

        .nav-link.active i,
        .nav-link:hover i {
            color: var(--primary);
        }
        
        /* Gold accent for active nav in both modes */
        .nav-link.active {
            border-left: 3px solid var(--gold);
            color: var(--primary);
        }

        .nav-link.active {
            border-left: 3px solid var(--primary);
            font-weight: 600;
        }

        .logout-btn {
            margin-top: auto;
            padding: 12px 18px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(239,91,91,0.4);
            color: var(--red);
            background: rgba(239,91,91,0.12);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            letter-spacing: 0.4px;
        }

        .main {
            flex: 1;
            padding: 32px 40px;
            overflow-y: auto;
            overflow-x: hidden;
            max-width: calc(100vw - 280px);
            width: 100%;
            box-sizing: border-box;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(var(--card-bg), 0.95) 100%);
            backdrop-filter: blur(20px);
            padding: 24px 32px;
            border-radius: var(--radius-lg);
            border: 2px solid var(--primary);
            margin-bottom: 32px;
        }

        .top-bar h2 {
            margin: 0;
            font-size: 26px;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #FFFFFF;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--green);
            position: relative;
        }

        .status-dot::after {
            content: "";
            position: absolute;
            inset: -6px;
            border-radius: 50%;
            border: 1px solid rgba(22,199,130,0.5);
            animation: pulse 1.6s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.6; }
            50% { transform: scale(1.2); opacity: 0.15; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        @keyframes slideDown {
            from { 
                opacity: 0; 
                transform: translateY(-30px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
        #lastRefresh {
            transition: opacity 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .section {
            display: none;
            gap: 24px;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .section.active {
            display: grid;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            padding: 24px 28px;
            border-radius: var(--radius-lg);
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(var(--card-bg), 0.9) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
        }

        .card h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 12px;
            color: #CBD5E0;
            letter-spacing: 0.8px;
            text-transform: uppercase;
        }

        .card strong {
            display: block;
            font-size: 34px;
            font-weight: 700;
            margin-bottom: 6px;
            color: #FFFFFF;
            transition: opacity 0.2s ease;
        }

        .split-panel {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
        }

        .panel {
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(var(--card-bg), 0.9) 100%);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            padding: 24px 28px;
            margin-bottom: 24px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        .panel h3 {
            margin: 0 0 12px;
            font-size: 18px;
            color: #FFFFFF;
            font-weight: 700;
        }

        .panel p {
            margin: 0;
            color: var(--text-400);
            font-size: 14px;
        }

        .form-grid {
            display: grid;
            gap: 16px;
        }

        .form-grid label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-200);
            letter-spacing: 0.4px;
        }

        .form-grid input,
        .form-grid textarea {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(17, 13, 27, 0.75);
            color: var(--text-100);
            font-size: 14px;
        }

        .form-grid textarea {
            min-height: 92px;
            resize: vertical;
        }

        .form-grid small {
            color: var(--text-400);
            font-size: 12px;
        }

        .btn {
            border: none;
            border-radius: 50px;
            padding: 14px 32px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 15px;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(120deg, #e0b75d, #d1983a);
            color: #1c1431;
            border: 3px solid #d1983a;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .btn-primary:hover::before {
            opacity: 0;
        }

        body.dark-mode .btn-primary {
            background: linear-gradient(135deg, #D4AF37, #B8922D);
            color: #000000;
            border: 3px solid #B8922D;
        }

        body.dark-mode .btn-primary::before {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }

        .btn-secondary {
            background: linear-gradient(120deg, #e0b75d, #d1983a);
            color: #1c1431;
            border: 3px solid #d1983a;
            position: relative;
            overflow: hidden;
        }

        .btn-secondary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(79,155,255,0.9) 0%, rgba(59,130,246,0.9) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .btn-secondary:hover::before {
            opacity: 1;
        }

        .btn-secondary:hover {
            color: #ffffff;
        }

        .btn-danger {
            background: linear-gradient(120deg, #e0b75d, #d1983a);
            color: #1c1431;
            border: 3px solid #d1983a;
            position: relative;
            overflow: hidden;
        }

        .btn-danger::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ef5b5b 0%, #dc2626 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .btn-danger:hover::before {
            opacity: 1;
        }

        .btn-danger:hover {
            color: #ffffff;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-lg);
            border: 2px solid var(--border);
            max-width: 100%;
        }

        /* Custom Scrollbar for Table Wrapper - Enhanced Visibility */
        .table-wrapper::-webkit-scrollbar {
            height: 14px;
        }
        
        .table-wrapper::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 7px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .table-wrapper::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, #FFD700 0%, #FFA500 50%, #FFD700 100%);
            border-radius: 7px;
            border: 2px solid rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(90deg, #FFA500 0%, #FFD700 50%, #FFA500 100%);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
        }
        
        /* Ensure table has minimum width for scrolling - removed min-width to prevent overflow */
        .table-wrapper table {
            width: 100%;
            table-layout: auto;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: linear-gradient(135deg, rgba(12, 9, 20, 0.8) 0%, rgba(20, 15, 30, 0.7) 100%);
            backdrop-filter: blur(10px);
            box-sizing: border-box;
        }

        thead {
            background: linear-gradient(135deg, rgba(44, 31, 74, 0.95) 0%, rgba(33, 0, 75, 0.9) 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th, td {
            padding: 16px 20px;
            text-align: left;
            font-size: 14px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            word-wrap: break-word;
            overflow-wrap: break-word;
            color: #E2E8F0;
        }

        th:last-child, td:last-child {
            text-align: center;
        }

        th {
            font-size: 12px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #00FFFF;
            font-weight: 700;
        }

        tbody tr {
            transition: var(--transition);
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            background: rgba(79,155,255,0.12);
            color: var(--blue);
        }

        .status-pill.success { background: rgba(22,199,130,0.12); color: var(--green); }
        .status-pill.muted { background: rgba(255,255,255,0.08); color: var(--text-400); }
        .status-pill.danger { background: rgba(239,91,91,0.12); color: var(--red); }

        .action-group {
            display: flex;
            gap: 8px;
        }

        .action-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 10px;
            border: none;
            background: rgba(255,255,255,0.08);
            cursor: pointer;
            color: var(--text-200);
        }

        .link-btn {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            color: var(--blue);
            cursor: pointer;
            font-size: 14px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .section-header h3 {
            margin: 0;
            font-size: 20px;
            color: #FFFFFF;
            font-weight: 700;
        }

        .filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .filters input,
        .filters select {
            padding: 9px 14px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(17, 13, 27, 0.75);
            color: #FFFFFF;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(7, 4, 16, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            place-items: center;
            z-index: 10000;
            padding: 40px 24px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        /* Higher z-index for stacked modals */
        .modal.stacked {
            z-index: 10010;
        }

        .modal.active { 
            display: grid; 
            opacity: 1;
        }
        
        /* Dynamic Modal Overlay for stacking modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10010;
            animation: fadeIn 0.25s ease;
        }
        
        .modal-overlay .modal-content {
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.2);
            animation: slideDown 0.3s ease;
            color: #1a1a2e;
        }

        body.dark-mode .modal-overlay .modal-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #0f0f1a 100%);
            border: 2px solid rgba(0, 200, 255, 0.3);
            box-shadow: 0 25px 80px rgba(0, 200, 255, 0.2), 0 0 40px rgba(0, 200, 255, 0.1);
            color: #fff;
        }
        
        .modal-overlay .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        body.dark-mode .modal-overlay .modal-header {
            background: linear-gradient(135deg, rgba(0, 200, 255, 0.1), rgba(0, 150, 255, 0.05));
            border-bottom: 1px solid rgba(0, 200, 255, 0.2);
        }

        .modal-overlay .modal-header h3 {
            color: #1a1a2e;
        }

        body.dark-mode .modal-overlay .modal-header h3 {
            color: #00C8FF;
        }
        
        .modal-overlay .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(85vh - 140px);
            background: #ffffff;
        }

        body.dark-mode .modal-overlay .modal-body {
            background: transparent;
        }

        .modal-overlay .modal-body p,
        .modal-overlay .modal-body span,
        .modal-overlay .modal-body td {
            color: #4a5568;
        }

        body.dark-mode .modal-overlay .modal-body p,
        body.dark-mode .modal-overlay .modal-body span,
        body.dark-mode .modal-overlay .modal-body td {
            color: #C0C0C0;
        }

        .modal-overlay .modal-body input,
        .modal-overlay .modal-body textarea,
        .modal-overlay .modal-body select {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #1a1a2e;
            border-radius: 8px;
            padding: 10px 12px;
        }

        body.dark-mode .modal-overlay .modal-body input,
        body.dark-mode .modal-overlay .modal-body textarea,
        body.dark-mode .modal-overlay .modal-body select {
            background: rgba(45, 45, 68, 0.8);
            border: 1px solid rgba(0, 200, 255, 0.3);
            color: #fff;
        }
        
        .modal-overlay .modal-footer {
            padding: 18px 24px;
            border-top: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f8f9fa;
        }

        body.dark-mode .modal-overlay .modal-footer {
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(0, 200, 255, 0.2);
        }
        
        .modal-overlay .close-btn {
            background: rgba(0,0,0,0.1);
            border: none;
            color: #1a1a2e;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        body.dark-mode .modal-overlay .close-btn {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .modal-overlay .close-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: rotate(90deg);
        }

        .modal-card {
            background: linear-gradient(135deg, var(--bg-800) 0%, rgba(var(--bg-800), 0.95) 100%);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            border: 2px solid var(--border);
            width: min(720px, 100%);
            max-height: calc(100vh - 80px);
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        
        .modal.active .modal-card {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 22px 24px;
            max-height: calc(100vh - 220px);
            overflow-y: auto;
            overflow-x: hidden;
            display: grid;
            gap: 16px;
        }
        
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        .modal-body::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 255, 0.5);
        }

        .modal-footer {
            padding: 18px 24px;
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
        }

        .detail-tile {
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.1);
            padding: 14px 16px;
        }

        body.dark-mode .detail-tile {
            background: rgba(21,16,37,0.9);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .detail-tile span {
            display: block;
            font-size: 12px;
            color: #64748b;
            letter-spacing: 0.6px;
            text-transform: uppercase;
        }

        body.dark-mode .detail-tile span {
            color: var(--text-400);
        }

        .detail-tile strong {
            display: block;
            margin-top: 8px;
            font-size: 15px;
            color: #1a1a2e;
        }

        body.dark-mode .detail-tile strong {
            color: #fff;
        }

        .message-thread {
            display: grid;
            gap: 16px;
            max-height: 340px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .message-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 14px 16px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        body.dark-mode .message-item {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .message-item h4 {
            margin: 0 0 8px;
            font-size: 13px;
            color: #64748b;
            display: flex;
            justify-content: space-between;
            gap: 14px;
        }

        body.dark-mode .message-item h4 {
            color: var(--text-400);
        }

        .message-item p {
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
            color: #1a1a2e;
        }

        body.dark-mode .message-item p {
            color: #C0C0C0;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        body.dark-mode .empty-state {
            color: var(--text-400);
        }

        .empty-state i {
            font-size: 36px;
            margin-bottom: 12px;
            color: rgba(79, 70, 229, 0.45);
        }

        body.dark-mode .empty-state i {
            color: rgba(213,168,70,0.45);
        }

        .checkbox {
            accent-color: var(--primary);
            transform: scale(1.1);
        }

        .badge {
            display: inline-block;
            background: rgba(255,255,255,0.08);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            margin: 2px;
        }

        .badge-success {
            background: rgba(22, 199, 130, 0.2);
            color: #16c782;
            border: 1px solid rgba(22, 199, 130, 0.4);
        }

        .badge-warning {
            background: rgba(245, 166, 35, 0.2);
            color: #f5a623;
            border: 1px solid rgba(245, 166, 35, 0.4);
        }

        .badge-info {
            background: rgba(79, 155, 255, 0.2);
            color: #4f9bff;
            border: 1px solid rgba(79, 155, 255, 0.4);
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 255, 0.8);
        }

        /* ========================================
           RESPONSIVE DESIGN FOR ALL DEVICES
           ======================================== */
        
        /* Tablet and below */
        @media (max-width: 1120px) {
            .split-panel { grid-template-columns: 1fr; }
            .sidebar { 
                position: fixed;
                left: -280px;
                z-index: 9999;
                transition: left 0.3s ease;
                height: 100vh;
                overflow-y: auto;
            }
            .sidebar.mobile-open { left: 0; }
            .main { 
                padding: 20px 16px; 
                max-width: 100vw;
            }
            .cards { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
            .top-bar { padding: 16px 20px; flex-direction: column; gap: 16px; }
            .table-wrapper { overflow-x: auto; }
            table { min-width: 800px; }
        }
        
        /* Mobile */
        @media (max-width: 768px) {
            body { font-size: 14px; }
            .main { padding: 16px 12px; }
            .cards { grid-template-columns: 1fr; gap: 12px; }
            .card { padding: 20px; }
            .top-bar h2 { font-size: 20px; }
            .section-header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .section-header > div { width: 100%; flex-wrap: wrap; }
            .btn { padding: 10px 16px; font-size: 13px; }
            .modal-card { width: 95% !important; margin: 10px; }
            .table-wrapper { font-size: 13px; }
            table th, table td { padding: 10px 8px; }
            .filters { flex-direction: column; gap: 10px; }
            .filters input, .filters select { width: 100%; }
        }
        
        /* Small mobile */
        @media (max-width: 480px) {
            .main { padding: 12px 8px; }
            .card h3 { font-size: 12px; }
            .card strong { font-size: 24px; }
            .btn { padding: 8px 12px; font-size: 12px; min-width: auto; }
            .section-header h3 { font-size: 18px; }
            table { min-width: 600px; font-size: 12px; }
            .modal-card { max-height: 90vh; }
        }
        
        /* Mobile menu toggle button */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10000;
            background: var(--primary);
            color: var(--bg-900);
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        .mobile-menu-toggle:active { transform: scale(0.95); }
        
        @media (max-width: 1120px) {
            .mobile-menu-toggle { display: flex; align-items: center; justify-content: center; font-size: 20px; }
            .dashboard-shell { padding-top: 80px; }
        }
        
        /* Mobile overlay for sidebar */
        .mobile-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9998;
            backdrop-filter: blur(4px);
        }
        @media (max-width: 1120px) {
            .mobile-overlay.active { display: block; }
        }

        /* Dark Mode - Pure Black with Crystal Blue Accents */
        body.dark-mode {
            --bg-900: #000000;
            --bg-800: #1F1F1F;
            --bg-700: #2a2a2a;
            --card-bg: rgba(31, 31, 31, 0.95);
            --border: rgba(0, 200, 255, 0.25);
            --text-100: #C0C0C0;
            --text-200: #C0C0C0;
            --text-400: #808080;
            background: linear-gradient(135deg, #000000 0%, #0a0a0a 100%);
            color: #C0C0C0;
        }
        body.dark-mode .dashboard-shell { background: linear-gradient(135deg, #000000 0%, #0a0a0a 100%); }
        body.dark-mode .sidebar { background: rgba(31, 31, 31, 0.95); border-right: 1px solid rgba(213, 168, 70, 0.3); color: #C0C0C0; }
        body.dark-mode .main { background: rgba(0, 0, 0, 0.5); color: #C0C0C0; }
        body.dark-mode .top-bar { background: rgba(31, 31, 31, 0.95); border: 2px solid #D5A846; color: #C0C0C0; }
        body.dark-mode .card { background: linear-gradient(135deg, #1F1F1F 0%, #2a2a2a 100%); border: 1px solid rgba(213, 168, 70, 0.3); color: #C0C0C0; }
        body.dark-mode .panel { background: linear-gradient(135deg, #1F1F1F 0%, #2a2a2a 100%); border: 1px solid rgba(213, 168, 70, 0.3); color: #C0C0C0; }
        body.dark-mode .stat-card { background: linear-gradient(135deg, #1F1F1F 0%, #2a2a2a 100%); border: 1px solid rgba(213, 168, 70, 0.3); color: #C0C0C0; border-left: 4px solid #D5A846; }
        body.dark-mode .complaint-item { background: rgba(31, 31, 31, 0.8); border: 1px solid rgba(0, 200, 255, 0.25); color: #C0C0C0; }
        body.dark-mode .admin-card { background: linear-gradient(135deg, #1F1F1F 0%, #2a2a2a 100%); border: 1px solid rgba(0, 200, 255, 0.25); color: #C0C0C0; }
        body.dark-mode input, body.dark-mode textarea, body.dark-mode select { background: rgba(31, 31, 31, 0.95); border: 1px solid rgba(0, 200, 255, 0.25); color: #C0C0C0; }
        body.dark-mode input::placeholder, body.dark-mode textarea::placeholder { color: #808080; }
        body.dark-mode table thead { background: rgba(31, 31, 31, 0.5); }
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode h4 { color: #FFFFFF; }
        body.dark-mode .brand h1 { color: #FFFFFF; }
        body.dark-mode .nav-link { color: #E2E8F0; }
        body.dark-mode .nav-link.active { color: #D5A846; background: rgba(213,168,70,0.1); border-left: 3px solid #D5A846; }
        body.dark-mode .theme-toggle-btn { background: rgba(42, 42, 42, 0.95) !important; border: 2px solid rgba(169, 169, 169, 0.3) !important; color: #c0c0c0 !important; box-shadow: 0 2px 8px rgba(10, 10, 10, 0.3) !important; }
        body.dark-mode .theme-toggle-btn:hover { background: rgba(58, 58, 58, 0.95) !important; box-shadow: 0 4px 16px rgba(10, 10, 10, 0.5) !important; }
        body.dark-mode #logoutBtn { background: rgba(239, 68, 68, 0.15) !important; border-color: rgba(239, 68, 68, 0.4) !important; }
        body.dark-mode #logoutBtn:hover { background: rgba(239, 68, 68, 0.25) !important; border-color: rgba(239, 68, 68, 0.6) !important; }

        /* Dark Mode - Message Modal */
        body.dark-mode .modal-card { background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); border: 1px solid rgba(169, 169, 169, 0.25); }
        body.dark-mode .modal-header { border-bottom: 1px solid rgba(169, 169, 169, 0.25); }
        body.dark-mode .modal-footer { border-top: 1px solid rgba(169, 169, 169, 0.25); }
        body.dark-mode .form-group label { color: #c0c0c0; font-weight: 600; }
        body.dark-mode .form-group select, body.dark-mode .form-group input, body.dark-mode .form-group textarea { background: rgba(42, 42, 42, 0.95); border: 1px solid rgba(169, 169, 169, 0.25); color: #c0c0c0; }
        body.dark-mode .form-group select:focus, body.dark-mode .form-group input:focus, body.dark-mode .form-group textarea:focus { border-color: #808080; box-shadow: 0 0 0 3px rgba(128, 128, 128, 0.2); }
        body.dark-mode .form-group input::placeholder, body.dark-mode .form-group textarea::placeholder { color: #808080; }
        body.dark-mode .btn-cancel { background: rgba(42, 42, 42, 0.95); color: #c0c0c0; }
        body.dark-mode .btn-cancel:hover { background: rgba(58, 58, 58, 0.95); }
        
        /* Light Mode - Message Modal */
        body.light-mode .message-modal-content { background: linear-gradient(135deg, hsl(226, 71%, 40%) 0%, #2563eb 100%); border: 1px solid rgba(213, 168, 70, 0.35); }
        body.light-mode .message-modal-header { border-bottom: 1px solid rgba(213, 168, 70, 0.35); }
        body.light-mode .message-modal-footer { border-top: 1px solid rgba(213, 168, 70, 0.35); }
        
        /* Light Mode - All Modal Popups */
        body.light-mode .modal-card { 
            background: linear-gradient(135deg, hsl(226, 71%, 40%) 0%, #2563eb 100%) !important; 
            border: 2px solid rgba(139, 92, 246, 0.4) !important; 
        }
        body.light-mode .modal-header { 
            border-bottom: 1px solid rgba(255, 255, 255, 0.2) !important; 
            color: #ffffff;
        }
        body.light-mode .modal-header h3 { 
            color: #ffffff !important; 
        }
        body.light-mode .modal-header .action-icon { 
            color: #ffffff !important; 
            background: rgba(255, 255, 255, 0.15) !important;
        }
        body.light-mode .modal-footer { 
            border-top: 1px solid rgba(255, 255, 255, 0.2) !important; 
        }
        body.light-mode .modal-body {
            color: #ffffff;
        }
        body.light-mode .modal-body label,
        body.light-mode .modal-body p,
        body.light-mode .modal-body div {
            color: #ffffff !important;
        }

        /* Notification Bar with Gold Theme */
        .notification-bar { display: flex; align-items: center; gap: 18px; padding: 0 20px; }
        .notification-item { position: relative; cursor: pointer; transition: all 0.3s ease; }        .notification-icon { width: 46px; height: 46px; background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.15) 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--text-100); font-size: 19px; transition: all 0.3s ease; backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.4); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        body:not(.dark-theme) .notification-icon { color: #1c1431; background: rgba(255,255,255,0.7); }
        .notification-item:hover .notification-icon { transform: scale(1.08); background: linear-gradient(135deg, rgba(255, 255, 255, 0.35) 0%, rgba(255, 255, 255, 0.25) 100%); box-shadow: 0 4px 14px rgba(0, 0, 0, 0.3); }        .theme-toggle-btn:hover { background: rgba(255, 255, 255, 0.35) !important; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25) !important; transform: scale(1.05); }
        .notification-badge { position: absolute; top: -6px; right: -6px; background: linear-gradient(135deg, #ff4d4d 0%, #ff1744 100%); color: white; font-size: 11px; font-weight: 700; min-width: 22px; height: 22px; border-radius: 11px; display: flex; align-items: center; justify-content: center; padding: 0 7px; box-shadow: 0 3px 10px rgba(255, 77, 77, 0.6); border: 2px solid var(--bg-800); }
        .notification-badge.pulse { animation: badgePulseGold 2s ease-in-out infinite; }
        .notification-badge.super { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000; font-weight: 800; box-shadow: 0 3px 12px rgba(255, 215, 0, 0.7); }
        @keyframes badgePulseGold { 0%, 100% { transform: scale(1); box-shadow: 0 3px 10px rgba(255, 77, 77, 0.6); } 50% { transform: scale(1.2); box-shadow: 0 5px 20px rgba(255, 77, 77, 0.9), 0 0 20px rgba(255, 215, 0, 0.5); } }
        .notification-tooltip { position: absolute; bottom: -38px; left: 50%; transform: translateX(-50%) scale(0.9); background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(30, 30, 30, 0.95) 100%); color: #FFD700; padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; white-space: nowrap; opacity: 0; pointer-events: none; transition: all 0.2s ease; z-index: 1000; border: 1px solid rgba(255, 215, 0, 0.3); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); }
        .notification-item:hover .notification-tooltip { opacity: 1; transform: translateX(-50%) scale(1); }
        .notification-dropdown { position: absolute; top: 70px; right: 20px; width: 400px; max-height: 520px; background: linear-gradient(135deg, rgba(30, 30, 40, 0.98) 0%, rgba(40, 40, 50, 0.98) 100%); border-radius: 18px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 215, 0, 0.1); backdrop-filter: blur(20px); opacity: 0; transform: translateY(-10px); pointer-events: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; border: 2px solid rgba(255, 215, 0, 0.2); overflow: hidden; }
        .notification-dropdown.active { opacity: 1; transform: translateY(0); pointer-events: all; }
        .dropdown-header { padding: 20px 22px; border-bottom: 1px solid rgba(255, 215, 0, 0.15); background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(218, 165, 32, 0.15) 100%); color: #FFD700; }
        .dropdown-header h3 { margin: 0; font-size: 17px; font-weight: 700; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }
        .dropdown-content { max-height: 420px; overflow-y: auto; padding: 10px; }
        .dropdown-item { padding: 16px 18px; border-radius: 12px; margin-bottom: 8px; background: rgba(50, 50, 60, 0.6); border: 1px solid rgba(255, 215, 0, 0.1); transition: all 0.2s ease; cursor: pointer; }
        .dropdown-item:hover { background: rgba(60, 60, 70, 0.8); transform: translateX(5px); box-shadow: 0 4px 12px rgba(255, 215, 0, 0.15); border-color: rgba(255, 215, 0, 0.3); }
        .dropdown-item-title { font-weight: 700; font-size: 14px; color: #FFD700; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); }
        .dropdown-item-subtitle { font-size: 12px; color: #bbb; }
        .dropdown-empty { padding: 50px 20px; text-align: center; color: #888; font-size: 14px; }
        .dropdown-empty i { font-size: 52px; opacity: 0.25; margin-bottom: 14px; color: #FFD700; }
        @media (max-width: 768px) { .notification-bar { gap: 14px; padding: 0 12px; } .notification-icon { width: 40px; height: 40px; font-size: 17px; } .notification-dropdown { width: 95vw; right: 2.5vw; } }

        /* Messaging System Styles */
        .mail-item { cursor: pointer; position: relative; }
        .close-modal { background: none; border: none; color: var(--text-400); font-size: 24px; cursor: pointer; transition: var(--transition); padding: 8px; border-radius: 8px; }
        .close-modal:hover { background: rgba(239, 91, 91, 0.15); color: var(--red); }
        .message-modal-body { padding: 24px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-200); font-weight: 600; font-size: 14px; }
        .form-group select, .form-group input, .form-group textarea { width: 100%; padding: 12px 16px; background: var(--bg-900); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--text-100); font-size: 14px; font-family: inherit; transition: var(--transition); }
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(213, 168, 70, 0.15); }
        .form-group textarea { resize: vertical; min-height: 120px; }
        .btn-cancel, .btn-send { padding: 12px 24px; font-size: 14px; }
        .btn-cancel { background: rgba(143, 127, 180, 0.15); color: var(--text-200); }
        .btn-cancel:hover { background: rgba(143, 127, 180, 0.25); }
        .btn-send { background: linear-gradient(135deg, var(--primary) 0%, #c89a3d 100%); color: var(--bg-900); display: flex; align-items: center; gap: 8px; }
        .btn-send:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(213, 168, 70, 0.35); }
        .btn-send i { font-size: 14px; }
        
        /* Print Styles */
        @media print {
            .sidebar, .top-bar, .notification-bar, .theme-toggle-btn, .logout-btn, .btn, button, .nav-link, .action-icon { display: none !important; }
            .main { padding: 20px; }
            body { background: white; color: black; }
            .modal-card { box-shadow: none; border: 1px solid #000; }
            .card, .panel { border: 1px solid #000; background: white; color: black; }
            h1, h2, h3, h4, p, td, th { color: black !important; }
        }
        
        /* Checkbox for print selection */
        .print-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Selected row highlighting for complaints */
        .selected-row {
            background: rgba(255, 215, 0, 0.15) !important;
            border-left: 4px solid var(--primary) !important;
        }
        
        body.dark-mode .selected-row {
            background: rgba(213, 168, 70, 0.2) !important;
            border-left: 4px solid #D5A846 !important;
        }
        
        /* Complaint dropdown styling - matches theme */
        .complaint-dropdown {
            animation: dropdownFadeIn 0.2s ease;
            background: var(--card-bg) !important;
            border-color: var(--border) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .complaint-dropdown button {
            transition: all 0.2s ease;
            background: var(--primary-soft) !important;
            color: var(--primary) !important;
            border-color: var(--border) !important;
        }
        
        .complaint-dropdown button:hover {
            transform: translateX(3px);
            background: var(--primary) !important;
            color: var(--bg-900) !important;
        }
        
        .print-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        /* Dark Mode Additional Styles */
        body.dark-mode .sidebar { background: var(--bg-900); border-right-color: var(--border); }
        body.dark-mode .nav-link { color: var(--text-100); }
        body.dark-mode .nav-link.active { background: var(--primary-soft); color: var(--primary); }
        body.dark-mode .panel, body.dark-mode .card { background: var(--card-bg); border: 1px solid var(--border); }
        body.dark-mode table { background: rgba(0, 0, 0, 0.5); }
        body.dark-mode thead { background: rgba(10, 10, 10, 0.7); }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background: rgba(0, 0, 0, 0.4); color: var(--text-100); border-color: #333333; }
        body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode textarea:focus { border-color: var(--primary); }
        body.dark-mode .modal-card { background: var(--card-bg); }
        body.dark-mode .head-chip { background: linear-gradient(120deg, rgba(212, 175, 55, 0.3), rgba(31, 31, 31, 0.5)); border-color: rgba(212, 175, 55, 0.4); }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle Menu">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="closeMobileMenu()"></div>

    <div class="dashboard-shell">
        <aside class="sidebar">
            <div class="brand">
                <img src="assets/logo.png" alt="Logo" style="width: 140px; height: 140px; object-fit: contain; margin: 0 auto; display: block;">
            </div>

            <nav class="nav-section">
                <h2>Overview</h2>
                <div class="nav-link active" data-target="overview">
                    <i class="fas fa-chart-line"></i>
                    <span>Control Center</span>
                </div>
            </nav>

            <nav class="nav-section">
                <h2>Monitoring</h2>
                <div class="nav-link" data-target="admin-management">
                    <i class="fas fa-user-shield"></i>
                    <span>Admin Management</span>
                </div>
                <div class="nav-link" data-target="users-management">
                    <i class="fas fa-users"></i>
                    <span>Users Management</span>
                </div>
                <div class="nav-link" data-target="complaints-log">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Complaints</span>
                </div>
                <div class="nav-link" data-target="feedback-log">
                    <i class="fas fa-comments"></i>
                    <span>Feedback</span>
                </div>
            </nav>

            <button class="theme-toggle-btn" data-theme-toggle title="Toggle Dark/Light Mode" style="margin: 0 16px 16px; padding: 12px; background: rgba(255, 255, 255, 0.25); border: 2px solid rgba(0, 255, 255, 0.4); border-radius: 10px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 255, 255, 0.15);">
                <i class="fas fa-sun"></i>
                <span style="font-size: 14px; color: var(--text-100);">Theme</span>
            </button>
        </aside>

        <main class="main">
            <header class="top-bar">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 1.1rem; font-weight: 700; color: #FFD700; letter-spacing: 0.8px; text-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);">
                        HEAD ADMINISTRATOR
                    </div>
                </div>
                
                <!-- Head Notification Bar -->
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div class="notification-bar">
                    <div class="notification-item mail-item" id="headMailBtn" title="Messages" data-type="mail">
                        <div class="notification-icon"><i class="fas fa-envelope"></i></div>
                        <span class="notification-badge" id="headMailBadge" style="display: none;">0</span>
                        <div class="notification-tooltip">Messages</div>
                    </div>
                    <div class="notification-item" data-type="notifications">
                        <div class="notification-icon"><i class="fas fa-bell"></i></div>
                        <span class="notification-badge super pulse" id="notificationBadge">0</span>
                        <div class="notification-tooltip">All Notifications</div>
                    </div>
                    <div class="notification-item" id="refreshBtn" title="Refresh Data" style="cursor: pointer;" data-type="refresh">
                        <div class="notification-icon"><i class="fas fa-sync-alt"></i></div>
                        <div class="notification-tooltip">Refresh Data</div>
                    </div>
                </div>

                <button class="theme-toggle-btn" id="themeToggle" title="Toggle Dark/Light Mode">
                    <i class="fas fa-moon"></i>
                </button>

                <div id="autoRefreshIndicator" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; font-size: 0.85rem; color: #22c55e;">
                    <i class="fas fa-sync-alt" style="animation: spin 2s linear infinite;"></i>
                    <span>Auto-refresh: <strong>ON</strong></span>
                </div>

                <button id="logoutBtn" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.2s;">
                    <i class="fas fa-sign-out-alt" style="margin-right: 6px;"></i>Logout
                </button>

                <div style="display: flex; align-items: center; gap: 12px; color: var(--text-400); font-size: 13px;">
                    <span class="status-dot"></span>
                    <span id="lastRefresh">Live</span>
                </div>
            </header>

            <!-- Admin Assignment Info Banner (appears when admin is clicked) -->
            <div id="adminAssignmentBanner" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; display: none; box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <i class="fas fa-user-shield" style="font-size: 1.3rem;"></i>
                            <h4 id="adminAssignmentName" style="margin: 0; font-size: 1.1rem; font-weight: 600;">Admin Name</h4>
                        </div>
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 16px; font-size: 0.95rem;">
                            <div style="opacity: 0.9;"><i class="fas fa-map-marker-alt"></i> <strong>Districts:</strong></div>
                            <div id="adminAssignmentDistricts">Not assigned</div>
                            <div style="opacity: 0.9;"><i class="fas fa-route"></i> <strong>Routes:</strong></div>
                            <div id="adminAssignmentRoutes">Not assigned</div>
                        </div>
                    </div>
                    <button onclick="hideAdminAssignmentBanner()" style="background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <section class="section active" id="overview">
                <div class="cards" id="overviewCards">
                    <div class="card">
                        <h3>Total Users</h3>
                        <strong id="cardTotalUsers">0</strong>
                        <p>Registered across the platform</p>
                    </div>
                    <div class="card">
                        <h3>Active Admins</h3>
                        <strong id="cardActiveAdmins">0</strong>
                        <p>Currently enabled accounts</p>
                    </div>
                    <div class="card">
                        <h3>Total Complaints</h3>
                        <strong id="cardTotalComplaints">0</strong>
                        <p>Logged by passengers</p>
                    </div>
                    <div class="card">
                        <h3>Pending Complaints</h3>
                        <strong id="cardPendingComplaints">0</strong>
                        <p>Awaiting resolution</p>
                    </div>
                </div>
            </section>

            <section class="section" id="admin-management">
                <div class="panel" style="margin-bottom: 24px;">
                    <button class="btn btn-primary" id="toggleCreateAdminBtn" style="width: 100%;">
                        <i class="fas fa-plus"></i>
                        Create New Admin
                    </button>
                </div>

                <div class="panel" style="margin-top: 24px;">
                    <div class="section-header">
                        <h3>All Admin Accounts</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" id="toggleAdminSelectionBtn" onclick="toggleAdminSelectionMode()" title="Toggle selection mode">
                                <i class="fas fa-check-square"></i> Select
                            </button>
                            <button class="btn btn-danger" id="deleteSelectedAdminsBtn" onclick="deleteSelectedAdmins()" style="display: none;" title="Delete selected admins">
                                <i class="fas fa-trash"></i> Delete Selected
                            </button>
                            <button class="btn btn-success" id="printSelectedAdminsBtn" onclick="printSelectedAdmins()" style="display: none;" title="Print selected admins to PDF">
                                <i class="fas fa-file-pdf"></i> Print Selected
                            </button>
                            <button class="btn btn-success" id="printAdminsBtn" title="Export to PDF">
                                <i class="fas fa-file-pdf"></i> Export All
                            </button>
                            <button class="btn btn-secondary" id="refreshAdminsBtn" title="Refresh" style="width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-rotate"></i>
                            </button>
                        </div>
                    </div>
                    <div class="filters">
                        <input type="text" id="adminSearch" placeholder="Search by name, email, district...">
                        <select id="adminStatusFilter">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="table-wrapper" id="adminTableWrapper" style="overflow-x: auto; max-width: 100%;">
                        <div style="text-align: center; padding: 40px; color: #888;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 12px;"></i>
                            <p>Loading administrators...</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="section" id="users-management">
                <div class="panel">
                    <div class="section-header">
                        <h3>Users Management</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" id="toggleUserSelectionBtn" onclick="toggleUserSelectionMode()" title="Toggle selection mode">
                                <i class="fas fa-check-square"></i> Select
                            </button>
                            <button class="btn btn-danger" id="deleteSelectedUsersBtn" onclick="deleteSelectedUsers()" style="display: none;" title="Delete selected users">
                                <i class="fas fa-trash"></i> Delete Selected
                            </button>
                            <button class="btn btn-success" id="printSelectedUsersBtn" onclick="printSelectedUsers()" style="display: none;" title="Print selected users to PDF">
                                <i class="fas fa-file-pdf"></i> Print Selected
                            </button>
                            <button class="btn btn-success" id="printUsersBtn" title="Export to PDF">
                                <i class="fas fa-file-pdf"></i> Export All
                            </button>
                            <button class="btn btn-secondary" id="refreshUsersBtn" title="Refresh" style="width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-rotate"></i>
                            </button>
                        </div>
                    </div>
                    <div class="filters">
                        <input type="text" id="userSearch" placeholder="Search by name or email...">
                    </div>
                    <div class="table-wrapper" id="usersTableWrapper" style="overflow-x: auto; max-width: 100%;">
                        <div style="text-align: center; padding: 40px; color: #888;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 12px;"></i>
                            <p>Loading users...</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="section" id="complaints-log">
                <div class="panel">
                    <div class="section-header">
                        <h3>Complaints</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" id="printComplaintsBtn" title="Export to PDF">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                            <button class="btn btn-secondary" id="refreshComplaintsBtn" title="Refresh" style="width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-rotate"></i>
                            </button>
                        </div>
                    </div>
                    <div class="table-wrapper" id="complaintsTableWrapper" style="overflow-x: auto; max-width: 100%;">
                        <div style="text-align: center; padding: 40px; color: #888;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 12px;"></i>
                            <p>Loading complaints...</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="section" id="feedback-log">
                <div class="panel">
                    <div class="section-header">
                        <h3>Feedback Log</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" id="refreshFeedbackBtn" title="Refresh" style="width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-rotate"></i>
                            </button>
                        </div>
                    </div>
                    <div class="filters">
                        <input type="text" id="feedbackSearch" placeholder="Search by user or email...">
                        <select id="feedbackStatusFilter">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="reviewed">Reviewed</option>
                            <option value="archived">Archived</option>
                        </select>
                        <select id="feedbackRatingFilter">
                            <option value="">All Ratings</option>
                            <option value="5">5 Stars</option>
                            <option value="4">4 Stars</option>
                            <option value="3">3 Stars</option>
                            <option value="2">2 Stars</option>
                            <option value="1">1 Star</option>
                        </select>
                    </div>
                    <div class="table-wrapper" id="feedbackTableWrapper"></div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal" id="adminProfileModal">
        <div class="modal-card" style="width: min(720px, 90%);">
            <div class="modal-header">
                <h3>Admin Information</h3>
                <button class="action-icon" data-close="adminProfileModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="adminProfileBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close="adminProfileModal">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="adminMessageModal">
        <div class="modal-card" style="width: min(640px, 100%);">
            <div class="modal-header">
                <h3 id="messageModalTitle">Message Admin</h3>
                <button class="action-icon" data-close="adminMessageModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="messageRecipientMeta" style="color: var(--text-400); font-size: 13px;"></div>
                <div class="message-thread" id="messageThread"></div>
                <div class="form-grid">
                    <label for="messageInput">Message</label>
                    <textarea id="messageInput" placeholder="Type a message for the admin..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close="adminMessageModal">Cancel</button>
                <button class="btn btn-primary" id="sendMessageBtn">
                    <i class="fas fa-paper-plane"></i>
                    Send Message
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="complaintDetailModal">
        <div class="modal-card" style="width: min(720px, 90%);">
            <div class="modal-header">
                <h3>Complaint Details</h3>
                <button class="action-icon" data-close="complaintDetailModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="complaintDetailBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close="complaintDetailModal">Close</button>
            </div>
        </div>
    </div>

    <!-- Custom Delete Confirmation Modal -->
    <div class="modal" id="deleteConfirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 10000;">
        <div class="modal-content" style="background: linear-gradient(135deg, #1a0a4a, #2a1a60); border: 2px solid #FFD100; border-radius: 20px; padding: 0; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div class="modal-header" style="background: linear-gradient(135deg, #FFD100, #FFA500); padding: 20px; border-radius: 18px 18px 0 0; border-bottom: 2px solid #FFD100;">
                <h3 style="color: #1a0a4a; margin: 0; font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-exclamation-triangle" style="color: #dc2626;"></i>
                    Delete Complaint
                </h3>
            </div>
            <div class="modal-body" style="padding: 25px; text-align: center;">
                <div style="font-size: 48px; color: #dc2626; margin-bottom: 16px;">
                    <i class="fas fa-trash-alt"></i>
                </div>
                <p style="color: #C0C0C0; font-size: 16px; margin-bottom: 12px; line-height: 1.6;">Are you sure you want to delete this complaint?</p>
                <p style="color: #FFD700; font-size: 18px; font-weight: 700; margin-bottom: 12px;">
                    Complaint <span id="deleteComplaintId"></span>
                </p>
                <p style="color: #ef4444; font-size: 14px; font-weight: 500;">
                    <i class="fas fa-exclamation-circle"></i> This action cannot be undone!
                </p>
            </div>
            <div class="modal-footer" style="padding: 20px; display: flex; gap: 12px; justify-content: flex-end; border-top: 1px solid rgba(255,209,0,0.2);">
                <button type="button" class="btn btn-secondary" onclick="event.preventDefault(); closeDeleteModal(); return false;" style="
                    background: #6b7280;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 15px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" onclick="event.preventDefault(); confirmDelete(); return false;" style="
                    background: linear-gradient(135deg, #ef5b5b, #dc2626);
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 15px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='linear-gradient(135deg, #dc2626, #b91c1c)'" onmouseout="this.style.background='linear-gradient(135deg, #ef5b5b, #dc2626)'">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="userInfoModal">
        <div class="modal-card" style="width: min(680px, 90%);">
            <div class="modal-header">
                <h3>User Information</h3>
                <button class="action-icon" data-close="userInfoModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="userInfoBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close="userInfoModal">Close</button>
            </div>
        </div>
    </div>

    <!-- User Complaints Modal -->
    <div class="modal" id="userComplaintsModal">
        <div class="modal-card" style="width: min(900px, 95%); max-height: 90vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary), var(--gold));">
                <h3 style="display: flex; align-items: center; gap: 10px; color: var(--bg-900);">
                    <i class="fas fa-clipboard-list"></i>
                    <span id="userComplaintsModalTitle">User Complaints</span>
                </h3>
                <button class="action-icon" onclick="closeUserComplaintsModal()" style="color: var(--bg-900);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="userComplaintsBody" style="max-height: 70vh; overflow-y: auto; padding: 24px;">
                <div style="text-align: center; padding: 40px; color: #888;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 12px;"></i>
                    <p>Loading complaints...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUserComplaintsModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Media Gallery Modal (replaces right side preview) -->
    <div class="modal" id="mediaGalleryModal">
        <div class="modal-card" style="width: min(1100px, 95%); max-height: 90vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(26,10,74,0.95), rgba(42,26,96,0.95));">
                <h3 style="display: flex; align-items: center; gap: 10px; margin: 0; color: #FFD700;">
                    <i class="fas fa-images"></i>
                    <span id="mediaGalleryTitle">Media Gallery</span>
                </h3>
                <button class="action-icon" onclick="closeMediaGalleryModal()" style="color: white;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="mediaGalleryBody" style="padding: 24px; max-height: 70vh; overflow-y: auto; background: rgba(0,0,0,0.3);">
                <!-- Media items will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMediaGalleryModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="complaintDetailsModal">
        <div class="modal-card" style="width: min(800px, 95%);">
            <div class="modal-header">
                <h3>Complaint Details</h3>
                <button class="action-icon" data-close="complaintDetailsModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="complaintDetailsBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close="complaintDetailsModal">Close</button>
            </div>
        </div>
    </div>

    <!-- Complaint Details from User Info Modal -->
    <div class="modal" id="complaintDetailsFromUserModal">
        <div class="modal-card" style="width: min(800px, 95%);">
            <div class="modal-header">
                <h3>Complaint Details</h3>
                <button class="action-icon" onclick="closeComplaintDetailsFromUser()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="complaintDetailsFromUserBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeComplaintDetailsFromUser()">Close</button>
            </div>
        </div>
    </div>

    <!-- Modern Confirmation Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-card" style="width: min(500px, 90%); animation: slideDown 0.3s ease;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                <h3 style="display: flex; align-items: center; gap: 10px; margin: 0;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="confirmTitle">Confirm Action</span>
                </h3>
                <button class="action-icon" onclick="closeConfirmModal()" style="color: white;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding: 30px; text-align: center;">
                <p id="confirmMessage" style="font-size: 1.1rem; color: var(--text-100); line-height: 1.7; margin: 0; font-weight: 500;"></p>
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: center; padding: 20px;">
                <button class="btn btn-secondary" onclick="closeConfirmModal()" style="min-width: 100px;">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary" id="confirmBtn" style="min-width: 100px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <i class="fas fa-check"></i> Confirm
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="feedbackModal">
        <div class="modal-card" style="width: min(560px, 90%);">
            <div class="modal-header">
                <h3>User Feedback</h3>
                <button class="action-icon" data-close="feedbackModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="feedbackBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close="feedbackModal">Close</button>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div class="modal" id="userDetailsModal">
        <div class="modal-card" style="width: min(900px, 95%);">
            <div class="modal-header">
                <h3>User Details & Complaint History</h3>
                <button class="action-icon" data-close="userDetailsModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="userDetailsBody" style="padding: 0;"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close="userDetailsModal">Close</button>
            </div>
        </div>
    </div>

    <!-- Complaint Detail Modal (from User History) -->
    <div class="modal" id="complaintFromUserModal">
        <div class="modal-card" style="width: min(720px, 90%);">
            <div class="modal-header">
                <h3>Complaint Details</h3>
                <button class="action-icon" data-close="complaintFromUserModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="complaintFromUserBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close="complaintFromUserModal">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="proofViewerModal">
        <div class="modal-card" style="width: min(800px, 95%);">
            <div class="modal-header">
                <h3>Complaint Proof</h3>
                <button class="action-icon" data-close="proofViewerModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="proofViewerBody" style="text-align: center;"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close="proofViewerModal">Close</button>
            </div>
        </div>
    </div>

    <!-- Media Viewer Modal -->
    <div class="modal" id="mediaViewerModal" style="display: none;">
        <div class="modal-card" style="width: min(900px, 95%); max-height: 90vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(26,10,74,0.95), rgba(42,26,96,0.95));">
                <h3 style="display: flex; align-items: center; gap: 10px; margin: 0; color: #FFD700;">
                    <i class="fas fa-image"></i>
                    <span id="mediaViewerTitle">Media Viewer</span>
                </h3>
                <button class="action-icon" onclick="closeMediaViewer()" style="color: white;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="mediaViewerBody" style="padding: 0; text-align: center; max-height: 70vh; overflow: auto; background: rgba(0,0,0,0.5);">
                <!-- Media content will be loaded here -->
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px; justify-content: space-between;">
                <div id="mediaViewerInfo" style="font-size: 12px; color: var(--text-300);"></div>
                <button class="btn btn-secondary" onclick="closeMediaViewer()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Context Menu for Print Options -->
    <div id="printContextMenu" style="display: none; position: fixed; background: var(--bg-800); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; min-width: 200px;">
        <div style="padding: 8px;">
            <button id="contextSelectThis" style="width: 100%; padding: 10px; background: transparent; border: none; color: var(--text-100); text-align: left; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-check-square"></i>
                <span>Select This</span>
            </button>
            <button id="contextSelectAll" style="width: 100%; padding: 10px; background: transparent; border: none; color: var(--text-100); text-align: left; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-check-double"></i>
                <span>Select All</span>
            </button>
            <button id="contextUnselectAll" style="width: 100%; padding: 10px; background: transparent; border: none; color: var(--text-100); text-align: left; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-square"></i>
                <span>Unselect All</span>
            </button>
        </div>
    </div>

    <!-- Head Notification Dropdowns -->
    <div class="notification-dropdown" id="notificationsDropdown" data-type="notifications">
        <div class="dropdown-header"><h3><i class="fas fa-crown"></i> Super Admin Alerts</h3></div>
        <div class="dropdown-content" id="notificationsContent"></div>
    </div>
    <div class="notification-dropdown" id="complaintsDropdown" data-type="complaints">
        <div class="dropdown-header"><h3><i class="fas fa-exclamation-circle"></i> All Complaints</h3></div>
        <div class="dropdown-content" id="complaintsContent"></div>
    </div>
    <div class="notification-dropdown" id="mailDropdown">
        <div class="dropdown-header"><h3><i class="fas fa-envelope"></i> Messages</h3></div>
        <div class="dropdown-content" id="mailContent"></div>
    </div>
    <div class="notification-dropdown" id="activityDropdown" data-type="activity">
        <div class="dropdown-header"><h3><i class="fas fa-chart-bar"></i> System Activity</h3></div>
        <div class="dropdown-content" id="activityContent"></div>
    </div>

    <script>
        // Modal Z-Index Management System
        let modalZIndexCounter = 10000;
        const modalStack = [];

        // Function to set modal z-index dynamically
        function setModalZIndex(modalElement) {
            if (!modalElement) return;
            modalZIndexCounter += 10;
            modalElement.style.zIndex = modalZIndexCounter;
            modalStack.push(modalElement);
            console.log('[MODAL] Set z-index', modalZIndexCounter, 'for modal:', modalElement.id);
        }

        // Function to remove modal from stack
        function removeModalFromStack(modalElement) {
            const index = modalStack.indexOf(modalElement);
            if (index > -1) {
                modalStack.splice(index, 1);
            }
        }

        // Override modal open functions to apply z-index
        const originalModalDisplay = {};

        // Monitor all modals for display changes (FIXED: Prevent infinite loop)
        document.addEventListener('DOMContentLoaded', () => {
            const allModals = document.querySelectorAll('.modal, [id*="Modal"]');
            allModals.forEach(modal => {
                let isSettingZIndex = false; // Flag to prevent infinite loop
                
                // Watch for style changes
                const observer = new MutationObserver((mutations) => {
                    // Skip if we're in the middle of setting z-index
                    if (isSettingZIndex) return;
                    
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'style') {
                            const display = window.getComputedStyle(modal).display;
                            if (display !== 'none' && display !== '') {
                                // Set flag to prevent re-triggering
                                isSettingZIndex = true;
                                setModalZIndex(modal);
                                // Reset flag after a short delay
                                setTimeout(() => { isSettingZIndex = false; }, 100);
                            } else if (display === 'none') {
                                removeModalFromStack(modal);
                            }
                        }
                    });
                });
                observer.observe(modal, { attributes: true, attributeFilter: ['style'] });
            });
        });

        // Head Notification Bar with Gold Theme
        class HeadNotificationBar {
            constructor() {
                this.activeDropdown = null;
                this.updateInterval = null;
                this.notificationItems = document.querySelectorAll('.notification-item');
                this.dropdowns = document.querySelectorAll('.notification-dropdown');
                
                console.log('[HEAD NOTIF] Notification bar initialized');
                console.log('[HEAD NOTIF] Found', this.notificationItems.length, 'notification items');
                console.log('[HEAD NOTIF] Found', this.dropdowns.length, 'dropdowns');
                
                if (this.notificationItems.length > 0) {
                    this.init();
                } else {
                    console.warn('[HEAD NOTIF] No notification items found, skipping init');
                }
            }

            init() {
                try {
                    this.notificationItems.forEach(item => {
                        item.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const dropdownType = item.closest('.notification-item').dataset.type;
                            this.toggleDropdown(dropdownType);
                        });
                    });

                    document.addEventListener('click', () => this.closeAllDropdowns());
                    this.dropdowns.forEach(dropdown => {
                        dropdown.addEventListener('click', (e) => e.stopPropagation());
                    });
                    
                    this.updateCounts();
                    // Prevent multiple intervals
                    if (this.updateInterval) clearInterval(this.updateInterval);
                    this.updateInterval = setInterval(() => this.updateCounts(), 30000); // 30 seconds
                    console.log('[HEAD NOTIF] Initialization complete');
                } catch (error) {
                    console.error('[HEAD NOTIF] Error during init:', error);
                }
            }

            toggleDropdown(type) {
                // Refresh button doesn't have a dropdown - it refreshes data instead
                if (type === 'refresh') {
                    console.log('[HEAD NOTIF] Refresh button clicked - refreshing data without page reload');
                    // Animate the icon
                    const refreshIcon = document.querySelector('#refreshBtn i');
                    if (refreshIcon) {
                        refreshIcon.style.animation = 'spin 1s linear';
                        setTimeout(() => { refreshIcon.style.animation = ''; }, 1000);
                    }
                    // Call data refresh functions if available
                    if (typeof loadDashboardStats === 'function') loadDashboardStats();
                    if (typeof loadAdminList === 'function') loadAdminList();
                    if (typeof loadAllUsers === 'function') loadAllUsers();
                    if (typeof loadComplaints === 'function') loadComplaints();
                    if (typeof loadAllFeedback === 'function') loadAllFeedback();
                    if (typeof showToast === 'function') showToast('Data refreshed successfully', 'success');
                    return;
                }
                
                const dropdown = document.getElementById(`${type}Dropdown`);
                if (!dropdown) {
                    console.error(`Dropdown element not found: ${type}Dropdown`);
                    return;
                }
                if (this.activeDropdown === type) {
                    this.closeAllDropdowns();
                    return;
                }
                this.closeAllDropdowns();
                dropdown.classList.add('active');
                this.activeDropdown = type;
                this.loadDropdownContent(type);
                
                // Mark notifications as read and update count immediately
                if (type === 'notifications') {
                    this.markAsRead();
                }
            }

            closeAllDropdowns() {
                this.dropdowns.forEach(d => d.classList.remove('active'));
                this.activeDropdown = null;
            }

            markAsRead() {
                this.updateBadge('notificationBadge', 0);
                localStorage.setItem('lastHeadNotificationRead', Date.now());
            }

            async updateCounts() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        console.warn('[HEAD NOTIF] No auth token found');
                        return;
                    }

                    const lastRead = parseInt(localStorage.getItem('lastHeadNotificationRead')) || 0;

                    // Fetch all complaints with error handling
                    const apiBase = window.API_BASE || 'http://127.0.0.1:5000';
                    
                    let response;
                    try {
                        response = await fetch(`${apiBase}/api/complaints`, {
                            headers: { 
                                'Authorization': 'Bearer ' + token,
                                'Content-Type': 'application/json'
                            }
                        });
                    } catch (fetchError) {
                        // Silently handle blocked requests (ad blockers, network errors)
                        console.warn('[HEAD NOTIF] Fetch blocked or failed, likely by browser extension');
                        this.updateBadge('notificationBadge', 0, false);
                        return;
                    }
                    
                    let totalCount = 0;
                    
                    if (response && response.ok) {
                        const data = await response.json();
                        const complaints = data.complaints || [];
                        
                        // Count only new items after lastRead timestamp
                        complaints.forEach(complaint => {
                            const complaintTime = new Date(complaint.created_at).getTime();
                            
                            if (complaintTime > lastRead) {
                                totalCount++;
                            }
                            
                            // Check for updates
                            if (complaint.updated_at) {
                                const updateTime = new Date(complaint.updated_at).getTime();
                                if (updateTime > lastRead && updateTime !== complaintTime) {
                                    totalCount++;
                                }
                            }
                        });
                    }
                    
                    this.updateBadge('notificationBadge', totalCount, true);

                } catch (error) {
                    // Silently handle errors - don't spam console
                    // This is typically caused by ad blockers or network issues
                    this.updateBadge('notificationBadge', 0, false);
                }
            }

            updateBadge(badgeId, count, isSuper = false) {
                const badge = document.getElementById(badgeId); // This is fine as it's a unique ID
                if (!badge) return;
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = count > 0 ? 'flex' : 'none';
                if (isSuper && count > 0) {
                    badge.classList.add('super', 'pulse');
                } else if (count > 0 && badgeId === 'notificationBadge') {
                    badge.classList.add('pulse');
                } else {
                    badge.classList.remove('pulse');
                }
            }

            async loadDropdownContent(type) {
                const content = document.getElementById(`${type}Content`); // This is fine as it's a unique ID
                const token = localStorage.getItem('token');

                if (type === 'complaints') {
                    try {
                        const response = await fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/complaints`, {
                            headers: { 'Authorization': 'Bearer ' + token }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            const complaints = data.complaints?.slice(0, 6) || [];
                            content.innerHTML = complaints.length === 0 ? 
                                '<div class=\"dropdown-empty\"><i class=\"fas fa-inbox\"></i><p>No complaints in system</p></div>' :
                                complaints.map(c => `
                                    <div class=\"dropdown-item\">
                                        <div class=\"dropdown-item-title\">#${c.id} - ${c.category || 'General'}</div>
                                        <div class=\"dropdown-item-subtitle\">
                                            <span style=\"color: ${c.status === 'pending' ? '#ff4d4d' : '#4caf50'};\">${c.status}</span>
                                             ${new Date(c.created_at).toLocaleDateString()}
                                        </div>
                                    </div>
                                `).join('');
                        }
                    } catch (error) {
                        content.innerHTML = '<div class=\"dropdown-empty\"><i class=\"fas fa-exclamation-triangle\"></i><p>Error loading data</p></div>';
                        console.error('Error loading complaints dropdown:', error);
                    }
                } else if (type === 'activity') {
                    content.innerHTML = `
                        <div class=\"dropdown-item\">
                            <div class=\"dropdown-item-title\"><i class=\"fas fa-users\"></i> System Activity</div>
                            <div class=\"dropdown-item-subtitle\">All systems operational  Real-time monitoring active</div>
                        </div>
                        <div class=\"dropdown-item\">
                            <div class=\"dropdown-item-title\"><i class=\"fas fa-shield-alt\"></i> Security Status</div>
                            <div class=\"dropdown-item-subtitle\">No threats detected  All admins active</div>
                        </div>
                    `;
                } else if (type === 'notifications') {
                    content.innerHTML = `
                        <div class=\"dropdown-item\">
                            <div class=\"dropdown-item-title\"><i class=\"fas fa-crown\"></i> Super Admin Privileges Active</div>
                            <div class=\"dropdown-item-subtitle\">Full system access granted</div>
                        </div>
                        <div class=\"dropdown-item\">
                            <div class=\"dropdown-item-title\"><i class=\"fas fa-check-circle\"></i> System Health: Excellent</div>
                            <div class=\"dropdown-item-subtitle\">All services running smoothly</div>
                        </div>
                    `;
                } else if (type === 'mail') {
                    // Load messages from admins
                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            content.innerHTML = '<div class=\"dropdown-empty\"><i class=\"fas fa-exclamation-triangle\"></i><p>Authentication required</p></div>';
                            return;
                        }
                        
                        const response = await fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/messages/head/inbox?status=unread`, {
                            headers: { 
                                'Authorization': 'Bearer ' + token,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.status === 401) {
                            content.innerHTML = '<div class=\"dropdown-empty\"><i class=\"fas fa-exclamation-triangle\"></i><p>Session expired. Please login again.</p></div>';
                            setTimeout(() => window.location.href = '/html/login.html', 2000);
                            return;
                        }
                        
                        if (response.ok) {
                            const data = await response.json();
                            const messages = data.messages?.slice(0, 6) || [];
                            const unreadCount = data.counts?.unread || 0;
                            
                            // Update mail badge
                            this.updateBadge('mailBadge', unreadCount);
                            
                            content.innerHTML = messages.length === 0 ? 
                                '<div class=\"dropdown-empty\"><i class=\"fas fa-envelope-open\"></i><p>No unread messages</p></div>' :
                                messages.map(msg => `
                                    <div class=\"dropdown-item\" data-message-id=\"${msg.id}\" onclick=\"window.openHeadMessageModal(this.dataset.messageId)\" style=\"cursor: pointer;\">
                                        <div class=\"dropdown-item-title\">
                                            <i class=\"fas fa-envelope\"></i> ${escapeHtml(msg.subject)}
                                        </div>
                                        <div class=\"dropdown-item-subtitle\">
                                            From: ${msg.admin_name}  ${new Date(msg.created_at).toLocaleDateString()}
                                        </div>
                                    </div>
                                `).join('') + 
                                `<div style=\"text-align: center; padding: 12px; border-top: 1px solid rgba(255,255,255,0.1);\">
                                    <a href=\"javascript:void(0)\" onclick=\"window.openMessagesInbox()\" style=\"color: var(--primary); text-decoration: none; font-weight: 600;\">
                                        View All Messages <i class=\"fas fa-arrow-right\"></i>
                                    </a>
                                </div>`;
                        } else {
                            content.innerHTML = '<div class=\"dropdown-empty\"><i class=\"fas fa-exclamation-triangle\"></i><p>Failed to load messages</p></div>';
                        }
                    } catch (error) {
                        content.innerHTML = '<div class=\"dropdown-empty\"><i class=\"fas fa-exclamation-triangle\"></i><p>Error loading messages</p></div>';
                        console.error('Error loading messages dropdown:', error);
                    }
                } else {
                    content.innerHTML = '<div class=\"dropdown-empty\"><i class=\"fas fa-inbox\"></i><p>No items</p></div>';
                }
            }

            destroy() {
                if (this.updateInterval) clearInterval(this.updateInterval);
            }
        }

        // Initialize notification bar with error handling
        try {
            const headNotificationBar = new HeadNotificationBar();
            console.log('[HEAD NOTIF] Notification bar created successfully');
        } catch (error) {
            console.error('[HEAD NOTIF] Failed to create notification bar:', error);
        }

        // Theme Toggle - Purple (Light) <-> Black (Dark)
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            const body = document.body;
            const themeIcon = themeToggle.querySelector('i');
            
            themeToggle.addEventListener('click', () => {
                body.classList.toggle('dark-mode');
                const isDark = body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                
                // Update icon
                if (themeIcon) {
                    if (isDark) {
                        themeIcon.className = 'fas fa-sun';
                    } else {
                        themeIcon.className = 'fas fa-moon';
                    }
                }
            });

            // Apply saved theme on load
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                body.classList.add('dark-mode');
                if (themeIcon) {
                    themeIcon.className = 'fas fa-sun';
                }
            }
        }
    </script>

    <!-- Message Compose Modal -->
    <div id="headMessageModal" class="modal" style="display: none;">
        <div class="message-modal-content">
            <div class="message-modal-header">
                <h3><i class="fas fa-envelope"></i> Compose Message</h3>
                <button class="close-modal" onclick="closeHeadMessageModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="message-modal-body">
                <div class="form-group">
                    <label for="headMessageRecipient">To:</label>
                    <select id="headMessageRecipient" required>
                        <option value="">Select Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="headMessageSubject">Subject:</label>
                    <input type="text" id="headMessageSubject" placeholder="Enter subject" required>
                </div>
                <div class="form-group">
                    <label for="headMessageBody">Message:</label>
                    <textarea id="headMessageBody" rows="6" placeholder="Type your message here..." required></textarea>
                </div>
            </div>
            <div class="message-modal-footer">
                <button class="btn-cancel" onclick="closeHeadMessageModal()">Cancel</button>
                <button class="btn-send" onclick="sendHeadMessage()"><i class="fas fa-paper-plane"></i> Send</button>
            </div>
        </div>
    </div>

    <script>
        // Messaging System Functions
        const headMessageModal = document.getElementById('headMessageModal');
        const headMessageRecipient = document.getElementById('headMessageRecipient');
        const headMessageSubject = document.getElementById('headMessageSubject');
        const headMessageBody = document.getElementById('headMessageBody');

        function openNewMessageModal() {
            headMessageModal.style.display = 'flex';
            loadHeadRecipients();
        }
        window.openNewMessageModal = openNewMessageModal;

        function closeNewMessageModal() {
            headMessageModal.style.display = 'none';
            headMessageRecipient.value = '';
            headMessageSubject.value = '';
            headMessageBody.value = '';
        }
        window.closeNewMessageModal = closeNewMessageModal;

        async function loadHeadRecipients() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const response = await fetch('http://127.0.0.1:5000/api/head/admins', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.status === 401) {
                    console.error('Unauthorized - token expired');
                    return;
                }

                if (response.ok) {
                    const data = await response.json();
                    const admins = Array.isArray(data) ? data : (data.data || data.admins || []);
                    headMessageRecipient.innerHTML = '<option value="">Select Admin</option>';
                    if (Array.isArray(admins)) {
                        admins.forEach(admin => {
                            const option = document.createElement('option');
                            option.value = admin.user_id || admin.id;
                            option.textContent = `${admin.name || admin.username} (${admin.email || admin.username})`;
                            headMessageRecipient.appendChild(option);
                        });
                    } else {
                        console.error('Admins data is not an array:', admins);
                    }
                } else {
                    console.error('Failed to load admin recipients, status:', response.status);
                }
            } catch (error) {
                console.error('Error loading recipients:', error);
            }
        }

        async function sendHeadMessage() {
            const recipientId = headMessageRecipient.value;
            const subject = headMessageSubject.value.trim();
            const body = headMessageBody.value.trim();

            if (!recipientId || !subject || !body) {
                showToast('Please fill all fields', 'warning');
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const response = await fetch('http://127.0.0.1:5000/api/messages/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        receiver_id: parseInt(recipientId),
                        subject: subject,
                        body: body
                    })
                });

                if (response.ok) {
                    showToast('Message sent successfully', 'success');
                    closeHeadMessageModal();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to send message', 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Failed to send message', 'error');
            }
        }
        window.sendHeadMessage = sendHeadMessage;

        async function checkHeadMessages() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const apiBase = window.API_BASE || 'http://127.0.0.1:5000';
                const response = await fetch(`${apiBase}/api/messages/inbox?unread_only=true`, {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.ok) {
                    const messages = await response.json();
                    const badge = document.getElementById('headMailBadge');
                    if (messages.length > 0) {
                        badge.textContent = messages.length;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                } else {
                    console.error('Failed to check for messages');
                }
            } catch (error) {
                console.error('Error checking messages:', error);
            }
        }

        // Initialize mail button click handler
        document.addEventListener('DOMContentLoaded', function() {
            const mailBtn = document.getElementById('headMailBtn');
            if (mailBtn) {
                mailBtn.addEventListener('click', () => {
                    openMessagesInbox();
                });
            }

            // Check for new messages with safeguard
            if (!window.messageCheckInterval) {
                checkHeadMessages();
                window.messageCheckInterval = setInterval(checkHeadMessages, 30000); // 30 seconds
            }
        });
    </script>

    <!-- Socket.IO for real-time updates -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="js/auth.js?v=3"></script>
    <script src="js/realtime.js?v=3"></script>
    <script src="js/head_dashboard.js?v=3" onerror="console.error('[SCRIPT ERROR] Failed to load head_dashboard.js')"></script>
    
    <!-- Initialize Dashboard on Load -->
    <script>
        console.log('[HEAD INIT] Starting HEAD dashboard initialization...');
        console.log('[HEAD INIT] API_BASE:', window.API_BASE);
        
        // Check for authentication token
        const token = localStorage.getItem('token');
        console.log('[HEAD INIT] Token exists:', !!token);
        
        if (!token) {
            console.error('[HEAD INIT] No authentication token found');
            alert('Session expired. Please login again.');
            window.location.href = '/html/login.html';
        }
        
        // Load dynamic profile section
        function loadDynamicProfile() {
            const userName = localStorage.getItem('user_name') || localStorage.getItem('userName') || 'Head Admin';
            const userEmail = localStorage.getItem('userEmail') || 'head@servonix.com';
            const userRole = localStorage.getItem('userRole') || 'Head';
            
            // Update profile elements
            const profileAvatar = document.getElementById('profileAvatar');
            const profileName = document.getElementById('profileName');
            const profileRole = document.getElementById('profileRole');
            const dynamicProfile = document.getElementById('dynamicProfile');
            
            if (profileAvatar && profileName && profileRole && dynamicProfile) {
                // Set avatar initial
                profileAvatar.textContent = userName.charAt(0).toUpperCase();
                
                // Set name and role
                profileName.textContent = userName;
                profileRole.textContent = userRole;
                
                // Trigger slide-in animation
                setTimeout(() => {
                    dynamicProfile.classList.add('loaded');
                }, 100);
            }
            
            // Also update the existing user name display
            const headUserName = document.getElementById('headUserName');
            const headAvatar = document.getElementById('headAvatar');
            if (headUserName) headUserName.textContent = userName;
            if (headAvatar) headAvatar.textContent = userName.charAt(0).toUpperCase();
        }
        
        // Load complaints for head dashboard
        async function loadComplaints() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('[COMPLAINTS] No token found');
                    return;
                }

                const response = await fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/complaints`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                // API returns array directly, not wrapped in data.complaints
                const complaints = Array.isArray(data) ? data : (data.complaints || []);
                
                console.log('[COMPLAINTS] Loaded', complaints.length, 'complaints');
                displayComplaintsTable(complaints);
            } catch (error) {
                console.error('[COMPLAINTS] Load error:', error);
                const wrapper = document.getElementById('complaintsTableWrapper');
                if (wrapper) {
                    const errorMessage = `<div style="padding: 40px; text-align: center; color: var(--text-400);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                            <p>Error loading complaints</p>
                            <button onclick="loadComplaints()" style="margin-top: 20px; padding: 12px 24px; background: var(--primary); color: var(--bg-900); border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Retry</button>
                          </div>`;
                    wrapper.innerHTML = errorMessage;
                }
            }
        }

        function displayComplaintsTable(complaints) {
            const wrapper = document.getElementById('complaintsTableWrapper');
            if (!wrapper) return;

            if (!complaints || complaints.length === 0) {
                wrapper.innerHTML = `<div style="padding: 40px; text-align: center; color: var(--text-400);">
                    <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                    <p>No complaints found</p>
                </div>`;
                return;
            }

            wrapper.innerHTML = `
                <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="toggleHeadSelectionBtn" onclick="toggleHeadSelectionMode()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">Select Items</button>
                    <button id="deleteHeadSelectedBtn" onclick="deleteHeadSelectedComplaints()" style="display: none; background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">Delete Selected (0)</button>
                    <button id="printHeadSelectedBtn" onclick="printHeadSelectedComplaints()" style="display: none; background: #8b5cf6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">Print Selected (0)</button>
                    <button id="cancelHeadSelectionBtn" onclick="cancelHeadSelectionMode()" style="display: none; background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">Cancel</button>
                </div>
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th class="head-checkbox-column" style="display: none; width: 40px;"><input type="checkbox" id="headSelectAll" onchange="toggleHeadSelectAll()" style="cursor: pointer;"></th>
                            <th style="width: 80px; cursor: pointer; user-select: none;" title="Click IDs to select/unselect">ID</th>
                            <th>Email ID</th>
                            <th>Admin Assigned</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${complaints.map(c => `
                            <tr>
                                <td class="head-checkbox-column" style="display: none;"><input type="checkbox" class="head-complaint-checkbox" data-id="${c.id}" onchange="updateHeadDeleteButton()" style="cursor: pointer;"></td>
                                <td style="font-weight: 700; color: #FFD700; cursor: pointer; user-select: none;" onclick="toggleHeadComplaintCheckbox(${c.id})" title="Click to select/unselect">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <i class="fas fa-hashtag" style="font-size: 11px; opacity: 0.7;"></i>
                                        <span>${c.id}</span>
                                    </div>
                                </td>
                                <td>${c.email || c.user_email || 'N/A'}</td>
                                <td>${c.admin_name || 'Not Assigned'}</td>
                                <td>
                                    <span class="status-badge" style="
                                        padding: 4px 12px; 
                                        border-radius: 12px; 
                                        font-size: 11px; 
                                        font-weight: 600;
                                        text-transform: uppercase;
                                        background: ${c.status === 'RESOLVED' ? 'rgba(22, 199, 130, 0.15)' : c.status === 'IN_PROGRESS' ? 'rgba(59, 130, 246, 0.15)' : 'rgba(239, 91, 91, 0.15)'};
                                        color: ${c.status === 'RESOLVED' ? '#16c782' : c.status === 'IN_PROGRESS' ? '#3b82f6' : '#ef5b5b'};
                                    ">
                                        ${c.status || 'PENDING'}
                                    </span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 8px; align-items: center; justify-content: center;">
                                        <button class="btn-view-complaint" data-complaint-id="${c.id}" title="View Details" style="
                                            background: linear-gradient(120deg, #e0b75d, #d1983a);
                                            color: #1c1431;
                                            border: 3px solid #d1983a;
                                            padding: 8px 12px;
                                            border-radius: 50px;
                                            cursor: pointer;
                                            font-weight: 700;
                                            font-size: 14px;
                                            transition: all 0.3s ease;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            width: 36px;
                                            height: 36px;
                                        " onmouseover="this.style.background='linear-gradient(135deg, #00FFFF 0%, #00b8d4 100%)'; this.style.color='#ffffff'" onmouseout="this.style.background='linear-gradient(120deg, #e0b75d, #d1983a)'; this.style.color='#1c1431'">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="deleteComplaintWithConfirm(${c.id})" title="Delete Complaint" style="
                                            background: linear-gradient(120deg, #e0b75d, #d1983a);
                                            color: #1c1431;
                                            border: 3px solid #d1983a;
                                            padding: 8px 12px;
                                            border-radius: 50px;
                                            cursor: pointer;
                                            font-weight: 700;
                                            font-size: 14px;
                                            transition: all 0.3s ease;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            width: 36px;
                                            height: 36px;
                                        " onmouseover="this.style.background='linear-gradient(135deg, #ef5b5b 0%, #dc2626 100%)'; this.style.color='#ffffff'" onmouseout="this.style.background='linear-gradient(120deg, #e0b75d, #d1983a)'; this.style.color='#1c1431'">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            // Attach event listeners using event delegation
            setTimeout(() => {
                const viewButtons = wrapper.querySelectorAll('.btn-view-complaint');
                const deleteButtons = wrapper.querySelectorAll('.btn-delete-complaint');
                
                viewButtons.forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const complaintId = parseInt(this.getAttribute('data-complaint-id'));
                        console.log('[VIEW] Button clicked for complaint ID:', complaintId);
                        HeadComplaintActions.viewComplaint(complaintId);
                    });
                });
                
                // Delete buttons now use onclick handlers - no delegation needed
            }, 100);
        }


        // Head Dashboard Selection Mode Functions
        let headSelectionModeActive = false;

        function toggleHeadSelectionMode() {
            headSelectionModeActive = !headSelectionModeActive;
            const checkboxes = document.querySelectorAll('.head-checkbox-column');
            const toggleBtn = document.getElementById('toggleHeadSelectionBtn');
            const cancelBtn = document.getElementById('cancelHeadSelectionBtn');
            
            if (headSelectionModeActive) {
                checkboxes.forEach(cb => cb.style.display = '');
                toggleBtn.style.background = '#10b981';
                toggleBtn.textContent = 'Selection Mode Active';
                cancelBtn.style.display = 'inline-block';
            } else {
                checkboxes.forEach(cb => cb.style.display = 'none');
                toggleBtn.style.background = '#3b82f6';
                toggleBtn.textContent = 'Select Items';
                cancelBtn.style.display = 'none';
                document.getElementById('deleteHeadSelectedBtn').style.display = 'none';
                document.getElementById('printHeadSelectedBtn').style.display = 'none';
                document.getElementById('headSelectAll').checked = false;
                document.querySelectorAll('.head-complaint-checkbox').forEach(cb => cb.checked = false);
            }
        }

        function cancelHeadSelectionMode() {
            headSelectionModeActive = false;
            const checkboxes = document.querySelectorAll('.head-checkbox-column');
            checkboxes.forEach(cb => cb.style.display = 'none');
            
            const toggleBtn = document.getElementById('toggleHeadSelectionBtn');
            toggleBtn.style.background = '#3b82f6';
            toggleBtn.textContent = 'Select Items';
            
            document.getElementById('cancelHeadSelectionBtn').style.display = 'none';
            document.getElementById('deleteHeadSelectedBtn').style.display = 'none';
            document.getElementById('printHeadSelectedBtn').style.display = 'none';
            document.getElementById('headSelectAll').checked = false;
            document.querySelectorAll('.head-complaint-checkbox').forEach(cb => cb.checked = false);
        }

        function toggleHeadSelectAll() {
            const selectAll = document.getElementById('headSelectAll');
            const checkboxes = document.querySelectorAll('.head-complaint-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateHeadDeleteButton();
        }

        function updateHeadDeleteButton() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.head-complaint-checkbox:checked'));
            const deleteBtn = document.getElementById('deleteHeadSelectedBtn');
            const printBtn = document.getElementById('printHeadSelectedBtn');
            const count = selectedCheckboxes.length;
            
            if (count > 0) {
                deleteBtn.style.display = 'inline-block';
                deleteBtn.textContent = `Delete Selected (${count})`;
                printBtn.style.display = 'inline-block';
                printBtn.textContent = `Print Selected (${count})`;
            } else {
                deleteBtn.style.display = 'none';
                printBtn.style.display = 'none';
            }
        }

        // Toggle checkbox when clicking ID column
        function toggleHeadComplaintCheckbox(complaintId) {
            const checkbox = document.querySelector(`.head-complaint-checkbox[data-id="${complaintId}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateHeadDeleteButton();
            }
        }

        async function deleteHeadSelectedComplaints() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.head-complaint-checkbox:checked'));
            const selectedIds = selectedCheckboxes.map(cb => parseInt(cb.dataset.id));
            
            if (selectedIds.length === 0) {
                alert('Please select complaints to delete');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${selectedIds.length} complaint(s)?`)) {
                return;
            }
            
            let successCount = 0;
            let failCount = 0;
            
            for (const id of selectedIds) {
                // Skip invalid IDs
                if (!id || id === 'null' || id === 'undefined' || isNaN(id)) {
                    console.warn('[DELETE] Skipping invalid ID:', id);
                    failCount++;
                    continue;
                }
                
                try {
                    const token = localStorage.getItem('token');
                    const apiBase = window.API_BASE || 'http://127.0.0.1:5000';
                    const response = await fetch(`${apiBase}/api/head/complaints/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    console.error(`Error deleting complaint ${id}:`, error);
                    failCount++;
                }
            }
            
            alert(`Deletion complete!\nSuccessful: ${successCount}\nFailed: ${failCount}`);
            
            // Reset selection mode and refresh
            cancelHeadSelectionMode();
            loadComplaints();
        }

        function printHeadSelectedComplaints() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.head-complaint-checkbox:checked'));
            const selectedIds = selectedCheckboxes.map(cb => parseInt(cb.dataset.id));
            
            // Get all complaints or selected only
            const token = localStorage.getItem('token');
            fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/complaints`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(data => {
                const allComplaints = Array.isArray(data) ? data : (data.complaints || []);
                
                // Filter selected or print all
                const complaintsToPrint = selectedIds.length > 0
                    ? allComplaints.filter(c => selectedIds.includes(c.id))
                    : allComplaints;
                
                if (complaintsToPrint.length === 0) {
                    alert('No complaints to print');
                    return;
                }
                
                const currentDate = new Date().toLocaleString();
                
                // Create print window
                const printWindow = window.open('', '_blank', 'width=900,height=700');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Complaints Report - Head Dashboard</title>
                        <style>
                            @media print {
                                @page { margin: 1cm; }
                            }
                            body {
                                font-family: Arial, sans-serif;
                                margin: 20px;
                                color: #333;
                            }
                            .header {
                                text-align: center;
                                margin-bottom: 30px;
                                border-bottom: 3px solid #F59E0B;
                                padding-bottom: 15px;
                            }
                            .header h1 {
                                margin: 0;
                                color: #F59E0B;
                                font-size: 28px;
                            }
                            .header p {
                                margin: 5px 0 0 0;
                                color: #666;
                                font-size: 14px;
                            }
                            .meta-info {
                                display: flex;
                                justify-content: space-between;
                                margin-bottom: 20px;
                                padding: 10px;
                                background: #f3f4f6;
                                border-radius: 5px;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-top: 20px;
                                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                            }
                            th {
                                background: #F59E0B;
                                color: white;
                                padding: 12px;
                                text-align: left;
                                font-weight: 600;
                                font-size: 12px;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            }
                            td {
                                padding: 10px 12px;
                                border-bottom: 1px solid #e5e7eb;
                                font-size: 12px;
                            }
                            tr:hover {
                                background: #f9fafb;
                            }
                            .status {
                                padding: 4px 8px;
                                border-radius: 4px;
                                font-weight: 600;
                                font-size: 11px;
                                text-transform: uppercase;
                            }
                            .status-pending { background: #FEF3C7; color: #92400E; }
                            .status-in_progress { background: #DBEAFE; color: #1E40AF; }
                            .status-resolved { background: #D1FAE5; color: #065F46; }
                            .footer {
                                margin-top: 30px;
                                text-align: center;
                                font-size: 12px;
                                color: #666;
                                border-top: 1px solid #ddd;
                                padding-top: 15px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1> SERVONIX Complaints Report</h1>
                            <p>Head Dashboard - Complaint Management Overview</p>
                        </div>
                        <div class="meta-info">
                            <div><strong>Generated:</strong> ${currentDate}</div>
                            <div><strong>Total Records:</strong> ${complaintsToPrint.length}</div>
                            <div><strong>Report Type:</strong> ${selectedIds.length > 0 ? 'Selected Items' : 'Complete List'}</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 60px;">ID</th>
                                    <th style="width: 180px;">User Email</th>
                                    <th style="width: 150px;">Admin Assigned</th>
                                    <th style="width: 120px;">Category</th>
                                    <th>Description</th>
                                    <th style="width: 100px;">Status</th>
                                    <th style="width: 120px;">Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${complaintsToPrint.map(c => `
                                    <tr>
                                        <td><strong>#${c.id}</strong></td>
                                        <td>${c.email || c.user_email || 'N/A'}</td>
                                        <td>${c.admin_name || 'Not Assigned'}</td>
                                        <td>${c.category || 'General'}</td>
                                        <td style="max-width: 250px; word-wrap: break-word;">${(c.description || 'N/A').substring(0, 120)}${c.description && c.description.length > 120 ? '...' : ''}</td>
                                        <td><span class="status status-${(c.status || 'pending').toLowerCase().replace(' ', '_')}">${(c.status || 'Pending').toUpperCase()}</span></td>
                                        <td>${new Date(c.created_at).toLocaleDateString()}<br><small>${new Date(c.created_at).toLocaleTimeString()}</small></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="footer">
                            <p>Generated by SERVONIX Bus Complaint Management System |  2025</p>
                            <p>This is a confidential document. Handle with care.</p>
                        </div>
                        <scr` + `ipt>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() { window.close(); }, 500);
                            };
                        </scr` + `ipt>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
            })
            .catch(error => {
                console.error('Print error:', error);
                alert('Failed to print complaints');
            });
        }

        // Expose functions globally
        window.toggleHeadSelectionMode = toggleHeadSelectionMode;
        window.cancelHeadSelectionMode = cancelHeadSelectionMode;
        window.toggleHeadSelectAll = toggleHeadSelectAll;
        window.updateHeadDeleteButton = updateHeadDeleteButton;
        window.deleteHeadSelectedComplaints = deleteHeadSelectedComplaints;
        window.printHeadSelectedComplaints = printHeadSelectedComplaints;

        // ============================================
        // HEAD COMPLAINT ACTIONS - Clean Implementation
        // ============================================
        // Toast fallback if external JS not loaded
        if (typeof showToast !== 'function') {
            window.showToast = function(message, type = 'info') {
                console.log(`[TOAST ${type.toUpperCase()}]:`, message);
                alert(message);
            };
        }

        const HeadComplaintActions = {
            // View complaint with full details and media support
            async viewComplaint(complaintId) {
                try {
                    // Validate complaint ID
                    if (!complaintId || complaintId === 'null' || complaintId === 'undefined' || isNaN(complaintId)) {
                        console.error('[HEAD ACTIONS] Invalid complaint ID:', complaintId);
                        showToast('Invalid complaint ID', 'error');
                        return;
                    }
                    
                    console.log('[HEAD ACTIONS] Viewing complaint:', complaintId);
                    
                    const token = localStorage.getItem('token');
                    if (!token) {
                        showToast('Please login to continue', 'error');
                        window.location.href = '/html/login.html';
                        return;
                    }

                    // Fetch complaint details
                    const apiBase = window.API_BASE || 'http://127.0.0.1:5000';
                    const response = await fetch(`${apiBase}/api/complaints/${complaintId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            showToast('Session expired. Please login again', 'error');
                            localStorage.removeItem('token');
                            window.location.href = '/html/login.html';
                            return;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const complaint = await response.json();
                    console.log('[HEAD ACTIONS] Complaint data:', complaint);

                    // Build modal content with media support
                    this.renderComplaintModal(complaint);

                } catch (error) {
                    console.error('[HEAD ACTIONS] Error viewing complaint:', error);
                    showToast('Failed to load complaint details', 'error');
                }
            },

            renderComplaintModal(complaint) {
                const modal = document.getElementById('complaintDetailsModal');
                const modalBody = document.getElementById('complaintDetailsBody');
                
                if (!modal || !modalBody) {
                    console.error('[HEAD ACTIONS] Modal elements not found');
                    return;
                }

                // Status badge helper
                const getStatusBadge = (status) => {
                    const statusMap = {
                        'RESOLVED': { bg: '#16c782', icon: 'check-circle' },
                        'IN_PROGRESS': { bg: '#3b82f6', icon: 'clock' },
                        'PENDING': { bg: '#ef5b5b', icon: 'exclamation-circle' }
                    };
                    const s = (status || 'PENDING').toUpperCase();
                    const style = statusMap[s] || statusMap['PENDING'];
                    return `
                        <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; 
                                     font-size: 12px; font-weight: 600; text-transform: uppercase; background: ${style.bg}22; 
                                     color: ${style.bg}; border: 2px solid ${style.bg};">
                            <i class="fas fa-${style.icon}"></i> ${s}
                        </span>
                    `;
                };

                // Format date
                const formatDate = (dateStr) => {
                    if (!dateStr) return 'N/A';
                    return new Date(dateStr).toLocaleString('en-US', { 
                        year: 'numeric', month: 'short', day: 'numeric', 
                        hour: '2-digit', minute: '2-digit'
                    });
                };

                // Build media gallery for external preview
                const showMediaPreview = () => {
                    if (!complaint.media_files || complaint.media_files.length === 0) {
                        return;
                    }

                    const container = document.getElementById('mediaPreviewContainer');
                    const content = document.getElementById('mediaPreviewContent');
                    if (!container || !content) return;

                    const mediaHTML = complaint.media_files.map((file, index) => {
                        let fileUrl = file.file_path;
                        if (!fileUrl.startsWith('http')) {
                            const base = window.API_BASE || 'http://127.0.0.1:5000';
                            fileUrl = fileUrl.startsWith('/') ? base + fileUrl : base + '/uploads/' + fileUrl;
                        }

                        const isImage = file.mime_type && file.mime_type.startsWith('image/');
                        const isPDF = file.mime_type && file.mime_type.includes('pdf');
                        const isVideo = file.mime_type && file.mime_type.startsWith('video/');

                        return `
                            <div class="media-item" style="border: 2px solid rgba(255,215,0,0.3); border-radius: 12px; overflow: hidden; 
                                                          background: rgba(255,255,255,0.02); cursor: pointer; transition: all 0.3s;"
                                 onclick="openMediaViewer('${fileUrl}', '${file.mime_type}', '${file.file_name || `Attachment ${index + 1}`}')"
                                 onmouseover="this.style.borderColor='#FFD700'; this.style.transform='scale(1.02)'"
                                 onmouseout="this.style.borderColor='rgba(255,215,0,0.3)'; this.style.transform='scale(1)'">
                                ${isImage ? `
                                    <img src="${fileUrl}" alt="Attachment" 
                                         style="width: 100%; height: 200px; object-fit: cover; display: block;"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                                    <div style="width: 100%; height: 200px; display: none; align-items: center; justify-content: center; 
                                               background: rgba(255,215,0,0.1); flex-direction: column; gap: 8px;">
                                        <i class="fas fa-image" style="font-size: 40px; color: #FFD700;"></i>
                                        <span style="font-size: 11px; color: #C0C0C0;">Image</span>
                                    </div>
                                ` : `
                                    <div style="width: 100%; height: 200px; display: flex; align-items: center; justify-content: center; 
                                               background: rgba(255,215,0,0.1); flex-direction: column; gap: 12px;">
                                        <i class="fas fa-${isPDF ? 'file-pdf' : isVideo ? 'file-video' : 'file-alt'}" 
                                           style="font-size: 48px; color: #FFD700;"></i>
                                        <span style="font-size: 12px; color: #C0C0C0; text-transform: uppercase; font-weight: 600;">
                                            ${isPDF ? 'PDF' : isVideo ? 'Video' : 'File'}
                                        </span>
                                    </div>
                                `}
                                <div style="padding: 12px; background: rgba(0,0,0,0.3); font-size: 11px; color: #C0C0C0; 
                                           display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-eye" style="font-size: 10px;"></i>
                                    <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        ${file.file_name || `Attachment ${index + 1}`}
                                    </span>
                                </div>
                            </div>
                        `;
                    }).join('');

                    content.innerHTML = mediaHTML;
                    container.style.display = 'block';
                };

                // Build media gallery notification with View button
                const buildMediaGallery = () => {
                    if (!complaint.media_files || complaint.media_files.length === 0) {
                        return '';
                    }

                    const mediaFiles = JSON.stringify(complaint.media_files).replace(/"/g, '&quot;');
                    return `
                        <div style="background: linear-gradient(135deg, rgba(26,10,74,0.8), rgba(42,26,96,0.8)); 
                                   border: 2px solid rgba(255,215,0,0.2); border-radius: 16px; padding: 20px; margin-top: 24px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                                <h4 style="color: #FFD700; margin: 0; font-size: 16px; display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-paperclip"></i>
                                    Media Attachments (${complaint.media_files.length})
                                </h4>
                                <button onclick="viewComplaintMedia(${complaint.id})" class="btn btn-primary" style="padding: 10px 20px; font-size: 14px;">
                                    <i class="fas fa-eye"></i> View Media
                                </button>
                            </div>
                        </div>
                    `;
                };

                // Show media preview immediately
                showMediaPreview();

                // Render modal content
                modalBody.innerHTML = `
                    <div style="max-height: 75vh; overflow-y: auto; padding: 8px;">
                        <div style="background: linear-gradient(135deg, rgba(26,10,74,0.9), rgba(42,26,96,0.9)); 
                                   border: 2px solid rgba(255,215,0,0.2); border-radius: 16px; padding: 24px;">
                            
                            <!-- Header: ID and Status -->
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; margin-bottom: 24px; 
                                       padding-bottom: 20px; border-bottom: 2px solid rgba(255,215,0,0.1);">
                                <div>
                                    <div style="font-size: 11px; color: #C0C0C0; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
                                        Complaint ID
                                    </div>
                                    <div style="font-size: 28px; font-weight: 700; color: #FFD700; display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-hashtag" style="font-size: 20px;"></i>${complaint.id}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 11px; color: #C0C0C0; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
                                        Status
                                    </div>
                                    ${getStatusBadge(complaint.status)}
                                </div>
                            </div>

                            <!-- Details Grid -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 10px; border-left: 3px solid #FFD700;">
                                    <div style="font-size: 11px; color: #C0C0C0; margin-bottom: 6px; text-transform: uppercase;">
                                        <i class="fas fa-user"></i> User Name
                                    </div>
                                    <div style="font-size: 15px; color: white; font-weight: 500;">
                                        ${complaint.user_name || complaint.name || 'N/A'}
                                    </div>
                                </div>

                                <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 10px; border-left: 3px solid #FFD700;">
                                    <div style="font-size: 11px; color: #C0C0C0; margin-bottom: 6px; text-transform: uppercase;">
                                        <i class="fas fa-envelope"></i> Email
                                    </div>
                                    <div style="font-size: 14px; color: white; word-break: break-word;">
                                        ${complaint.email || complaint.user_email || 'N/A'}
                                    </div>
                                </div>

                                <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 10px; border-left: 3px solid #FFD700;">
                                    <div style="font-size: 11px; color: #C0C0C0; margin-bottom: 6px; text-transform: uppercase;">
                                        <i class="fas fa-map-marker-alt"></i> District
                                    </div>
                                    <div style="font-size: 15px; color: white; font-weight: 500;">
                                        ${complaint.district_name || complaint.district || 'N/A'}
                                    </div>
                                </div>

                                <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 10px; border-left: 3px solid #FFD700;">
                                    <div style="font-size: 11px; color: #C0C0C0; margin-bottom: 6px; text-transform: uppercase;">
                                        <i class="fas fa-route"></i> Route
                                    </div>
                                    <div style="font-size: 15px; color: white; font-weight: 500;">
                                        ${complaint.route_name || complaint.route || 'N/A'}
                                    </div>
                                </div>

                                <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 10px; border-left: 3px solid #FFD700;">
                                    <div style="font-size: 11px; color: #C0C0C0; margin-bottom: 6px; text-transform: uppercase;">
                                        <i class="fas fa-bus"></i> Bus Number
                                    </div>
                                    <div style="font-size: 15px; color: white; font-weight: 500;">
                                        ${complaint.bus_number_info || complaint.bus_number || 'N/A'}
                                    </div>
                                </div>

                                <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 10px; border-left: 3px solid #FFD700;">
                                    <div style="font-size: 11px; color: #C0C0C0; margin-bottom: 6px; text-transform: uppercase;">
                                        <i class="fas fa-tag"></i> Category
                                    </div>
                                    <div style="font-size: 15px; color: white; font-weight: 500;">
                                        ${complaint.category || complaint.complaint_type || 'General'}
                                    </div>
                                </div>

                                <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 10px; border-left: 3px solid #FFD700;">
                                    <div style="font-size: 11px; color: #C0C0C0; margin-bottom: 6px; text-transform: uppercase;">
                                        <i class="fas fa-user-shield"></i> Assigned Admin
                                    </div>
                                    <div style="font-size: 15px; color: white; font-weight: 500;">
                                        ${complaint.admin_name || '<span style="color: #C0C0C0;">Not Assigned</span>'}
                                    </div>
                                </div>

                                <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 10px; border-left: 3px solid #FFD700;">
                                    <div style="font-size: 11px; color: #C0C0C0; margin-bottom: 6px; text-transform: uppercase;">
                                        <i class="fas fa-calendar-alt"></i> Created At
                                    </div>
                                    <div style="font-size: 14px; color: white;">
                                        ${formatDate(complaint.created_at)}
                                    </div>
                                </div>
                            </div>

                            <!-- Description -->
                            <div style="margin-top: 24px; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; 
                                       border-left: 4px solid #FFD700;">
                                <div style="font-size: 11px; color: #C0C0C0; margin-bottom: 10px; text-transform: uppercase;">
                                    <i class="fas fa-align-left"></i> Description
                                </div>
                                <div style="font-size: 15px; color: white; line-height: 1.7; white-space: pre-wrap;">
                                    ${complaint.description || '<span style="color: #C0C0C0; font-style: italic;">No description provided</span>'}
                                </div>
                            </div>
                        </div>

                        ${buildMediaGallery()}
                    </div>
                `;

                // Show modal
                modal.classList.add('active');
                modal.style.display = 'flex';
            },

            // Delete complaint with confirmation
            // Delete methods moved to global scope for reliability
        };

        // Expose to window
        window.HeadComplaintActions = HeadComplaintActions;
        
        // ============================================
        // GLOBAL DELETE FUNCTIONS - Simple & Reliable
        // ============================================
        // Simple delete - just call the JS function
        // ============================================
        window.deleteComplaintWithConfirm = function(complaintId) {
            console.log('[HTML DELETE] deleteComplaintWithConfirm called with:', complaintId, 'type:', typeof complaintId);
            
            // Validate complaint ID - convert to number and check
            const id = parseInt(complaintId);
            if (!id || isNaN(id) || id <= 0) {
                console.error('[DELETE] Invalid complaint ID:', complaintId, 'parsed as:', id);
                showToast('Invalid complaint ID', 'error');
                return;
            }
            
            console.log('[DELETE] Calling window.deleteComplaint for ID:', id, 'function exists:', typeof window.deleteComplaint);
            // Call the deleteComplaint function from head_dashboard.js
            if (typeof window.deleteComplaint === 'function') {
                window.deleteComplaint(id);
            } else {
                console.warn('[DELETE] window.deleteComplaint not found, using fallback');
                // Fallback if JS not loaded
                if (confirm('Are you sure you want to delete this complaint?')) {
                    const token = localStorage.getItem('token');
                    const apiBase = window.API_BASE || 'http://127.0.0.1:5000';
                    fetch(`${apiBase}/api/head/complaints/${complaintId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    }).then(res => {
                        if (res.ok) {
                            alert('Complaint deleted successfully');
                            location.reload();
                        } else {
                            alert('Failed to delete complaint');
                        }
                    }).catch(err => alert('Error: ' + err.message));
                }
            }
        };
        
        // Cancel delete (for modal)
        window.cancelDeleteConfirmation = function() {
            const modal = document.getElementById('deleteConfirmModal');
            if (modal) modal.style.display = 'none';
            return false;
        };
        
        // Confirm delete (for modal)
        window.confirmDeleteComplaint = function() {
            // Get the pending complaint ID and call the JS function
            if (typeof confirmDelete === 'function') {
                confirmDelete();
            } else {
                console.error('[DELETE] confirmDelete function not found');
            }
        };
        
        console.log('[INIT]  Global delete functions registered successfully');
        
        // Setup refresh button
        document.addEventListener('DOMContentLoaded', () => {
            const refreshBtn = document.getElementById('refreshComplaintsBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', loadComplaints);
            }
        });
        
        // Initialize profile immediately
        loadDynamicProfile();
        
        // Wait for scripts to load
        let initAttempts = 0;
        const maxAttempts = 15; // Increased attempts
        let dataLoaded = false;
        
        function attemptInit() {
            initAttempts++;
            console.log(`[HEAD INIT] Attempt ${initAttempts}/${maxAttempts}`);
            
            // Check if functions are available
            const functionsReady = typeof loadDashboardStats !== 'undefined' && 
                                  typeof loadAdminList !== 'undefined' && 
                                  typeof loadAllUsers !== 'undefined' && 
                                  typeof loadComplaints !== 'undefined';
            
            console.log('[HEAD INIT] Functions available:', {
                loadDashboardStats: typeof loadDashboardStats,
                loadAdminList: typeof loadAdminList,
                loadAllUsers: typeof loadAllUsers,
                loadComplaints: typeof loadComplaints
            });
            
            if (functionsReady && !dataLoaded) {
                dataLoaded = true;
                console.log('[HEAD INIT]  All functions loaded! Starting dashboard...');
                
                // Show loading indicator
                console.log('[HEAD INIT] Loading dashboard data...');
                
                try {
                    // Load data in sequence with proper error handling
                    Promise.all([
                        loadDashboardStats().catch(err => console.error('[HEAD INIT] Stats error:', err)),
                        loadAdminList().catch(err => console.error('[HEAD INIT] Admins error:', err)),
                        loadAllUsers().catch(err => console.error('[HEAD INIT] Users error:', err)),
                        loadComplaints().catch(err => console.error('[HEAD INIT] Complaints error:', err)),
                        // Load districts and routes for real-time dropdown updates
                        (typeof loadDistrictsForDropdown === 'function' ? loadDistrictsForDropdown() : Promise.resolve()).catch(err => console.error('[HEAD INIT] Districts error:', err)),
                        (typeof loadRoutesForDropdown === 'function' ? loadRoutesForDropdown() : Promise.resolve()).catch(err => console.error('[HEAD INIT] Routes error:', err))
                    ]).then(() => {
                        console.log('[HEAD INIT]  All data loaded successfully (including districts & routes)');
                    }).catch(error => {
                        console.error('[HEAD INIT] Error loading data:', error);
                    });
                } catch (error) {
                    console.error('[HEAD INIT] Error starting loaders:', error);
                }
            } else if (initAttempts < maxAttempts && !dataLoaded) {
                console.log('[HEAD INIT] Functions not ready, retrying in 300ms...');
                setTimeout(attemptInit, 300); // Increased delay
            } else if (!dataLoaded) {
                console.error('[HEAD INIT]  Failed to load dashboard functions after', maxAttempts, 'attempts');
                console.error('[HEAD INIT] Please check if /js/head_dashboard.js loaded correctly');
                console.error('[HEAD INIT] Check browser console for script errors');
                alert('Dashboard failed to initialize. Please refresh the page or check console for errors.');
            }
        }
        
        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('[HEAD INIT] DOM loaded, starting initialization in 500ms...');
                setTimeout(attemptInit, 500);
            });
        } else {
            console.log('[HEAD INIT] DOM already loaded, starting initialization...');
            setTimeout(attemptInit, 500);
        }
    </script>
    
    <!-- Modal Close Handlers -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation link handlers with data loading
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    
                    // Remove active class from all links and sections
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Show target section
                    const section = document.getElementById(target);
                    if (section) {
                        section.classList.add('active');
                        
                        // Load data based on section
                        if (target === 'feedback-log' && typeof loadFeedback === 'function') {
                            loadFeedback();
                        } else if (target === 'complaints-log' && typeof loadComplaints === 'function') {
                            loadComplaints();
                        }
                    }
                });
            });

            // Close modals on button click - using event delegation for dynamically created content
            document.addEventListener('click', function(e) {
                // Check if clicked element or its parent has data-close attribute
                const closeButton = e.target.closest('[data-close]');
                if (closeButton) {
                    const modalId = closeButton.getAttribute('data-close');
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.classList.remove('active');
                    }
                }
            });
            
            // Close modals on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });

            // Character count for delete reason
            const reasonInput = document.getElementById('deleteReasonInput');
            const charCount = document.getElementById('reasonCharCount');
            
            if (reasonInput && charCount) {
                reasonInput.addEventListener('input', function() {
                    charCount.textContent = this.value.length;
                });
            }
        });

        // ==================== ADDITIONAL MISSING FUNCTIONS ====================
        
        // Hide admin assignment banner
        function hideAdminAssignmentBanner() {
            const banner = document.getElementById('adminAssignmentBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        }
        window.hideAdminAssignmentBanner = hideAdminAssignmentBanner;
        
        // Close complaint details from user modal
        function closeComplaintDetailsFromUser() {
            const modal = document.getElementById('complaintDetailsFromUserModal');
            if (modal) {
                modal.classList.remove('active');
                modal.style.display = 'none';
                modal.style.zIndex = '';
            }
            console.log('[Modal] Complaint from user modal closed');
        }
        window.closeComplaintDetailsFromUser = closeComplaintDetailsFromUser;
        
        // Close confirm modal
        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        window.closeConfirmModal = closeConfirmModal;
        
        // Toggle print menu dropdown
        function togglePrintMenu(section) {
            const menuId = section + 'SelectMenu';
            const menu = document.getElementById(menuId);
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        }
        window.togglePrintMenu = togglePrintMenu;

        // Select all rows for printing
        function selectAllRows(section) {
            const checkboxes = document.querySelectorAll(`.${section}-row-checkbox`);
            checkboxes.forEach(cb => cb.checked = true);
            console.log(`Selected all rows in ${section}`);
        }
        window.selectAllRows = selectAllRows;

        // Deselect all rows
        function deselectAllRows(section) {
            const checkboxes = document.querySelectorAll(`.${section}-row-checkbox`);
            checkboxes.forEach(cb => cb.checked = false);
            togglePrintMenu(section);
            console.log(`Deselected all rows in ${section}`);
        }
        window.deselectAllRows = deselectAllRows;

        // Print selected rows
        function printSelectedRows(section) {
            const checkboxes = document.querySelectorAll(`.${section}-row-checkbox:checked`);
            if (checkboxes.length === 0) {
                showToast('Please select items to print', 'warning');
                return;
            }
            togglePrintMenu(section);
            window.print();
        }
        window.printSelectedRows = printSelectedRows;

        console.log(' Additional functions loaded: togglePrintMenu, selectAllRows');
    </script>

    <!-- Head Messages System -->
    <script>
        // =============== HEAD MESSAGING SYSTEM ===============

        // Helper: Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        window.escapeHtml = escapeHtml;

        // Open messages inbox (full page view)
        function openMessagesInbox() {
            // Create full-page inbox modal
            const inboxModal = document.createElement('div');
            inboxModal.id = 'messagesInboxModal';
            inboxModal.style.cssText = 'position: fixed; inset: 0; background: var(--bg-900); z-index: 9999; overflow-y: auto; padding: 20px;';
            
            inboxModal.innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--border);">
                        <h2 style="font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 15px;">
                            <i class="fas fa-inbox"></i> Messages from Admins
                        </h2>
                        <button onclick="closeMessagesInbox()" style="background: var(--primary); color: var(--bg-900); border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>

                    <div style="display: flex; gap: 15px; margin-bottom: 25px;">
                        <button onclick="filterMessages('all')" class="msg-filter-btn active" data-filter="all" style="padding: 10px 20px; border-radius: 8px; border: 2px solid var(--border); background: var(--primary); color: var(--bg-900); cursor: pointer; font-weight: 600;">
                            All Messages
                        </button>
                        <button onclick="filterMessages('unread')" class="msg-filter-btn" data-filter="unread" style="padding: 10px 20px; border-radius: 8px; border: 2px solid var(--border); background: transparent; color: var(--text-100); cursor: pointer; font-weight: 600;">
                            Unread
                        </button>
                        <button onclick="filterMessages('read')" class="msg-filter-btn" data-filter="read" style="padding: 10px 20px; border-radius: 8px; border: 2px solid var(--border); background: transparent; color: var(--text-100); cursor: pointer; font-weight: 600;">
                            Read
                        </button>
                        <button onclick="filterMessages('resolved')" class="msg-filter-btn" data-filter="resolved" style="padding: 10px 20px; border-radius: 8px; border: 2px solid var(--border); background: transparent; color: var(--text-100); cursor: pointer; font-weight: 600;">
                            Resolved
                        </button>
                    </div>

                    <div id="inboxMessagesList">
                        <div style="text-align: center; padding: 60px; color: var(--text-400);">
                            <i class="fas fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <div>Loading messages...</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(inboxModal);
            loadInboxMessages('all');
        }
        window.openMessagesInbox = openMessagesInbox;

        function closeMessagesInbox() {
            const modal = document.getElementById('messagesInboxModal');
            if (modal) modal.remove();
        }
        window.closeMessagesInbox = closeMessagesInbox;

        function filterMessages(status) {
            // Update active button
            document.querySelectorAll('.msg-filter-btn').forEach(btn => {
                if (btn.dataset.filter === status) {
                    btn.style.background = 'var(--primary)';
                    btn.style.color = 'var(--bg-900)';
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = 'var(--text-100)';
                }
            });
            loadInboxMessages(status);
        }
        window.filterMessages = filterMessages;

        async function loadInboxMessages(status = 'all') {
            const token = localStorage.getItem('token');
            const container = document.getElementById('inboxMessagesList');
            
            try {
                const response = await fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/messages/head/inbox?status=${status}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const messages = data.messages || [];
                    
                    if (messages.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 60px; color: var(--text-400);">
                                <i class="fas fa-inbox" style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;"></i>
                                <h3 style="font-size: 20px; margin-bottom: 10px;">No messages</h3>
                                <p>You have no ${status === 'all' ? '' : status} messages</p>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = messages.map(msg => {
                        const statusClass = msg.status === 'resolved' ? 'resolved' : (msg.status === 'read' ? 'read' : 'unread');
                        const statusBg = msg.status === 'resolved' ? 'rgba(160,174,192,0.2)' : (msg.status === 'read' ? 'rgba(22,199,130,0.2)' : 'rgba(0,255,255,0.2)');
                        const statusColor = msg.status === 'resolved' ? 'var(--text-400)' : (msg.status === 'read' ? '#16c782' : 'var(--primary)');
                        
                        return `
                            <div data-message-id="${msg.id}" onclick="openHeadMessageModal(this.dataset.messageId)" style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s ease; border-left: 4px solid ${statusColor};" onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px; color: var(--text-100);">
                                            ${escapeHtml(msg.subject)}
                                        </div>
                                        <div style="color: var(--text-200); font-size: 14px; margin-bottom: 10px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                            ${escapeHtml(msg.message_content)}
                                        </div>
                                        <div style="display: flex; gap: 20px; font-size: 13px; color: var(--text-400);">
                                            <span><i class="fas fa-user"></i> ${msg.admin_name}</span>
                                            <span><i class="fas fa-calendar"></i> ${new Date(msg.created_at).toLocaleDateString()}</span>
                                            ${msg.complaint_number ? `<span><i class="fas fa-link"></i> Complaint #${msg.complaint_number}</span>` : ''}
                                        </div>
                                    </div>
                                    <div style="padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; white-space: nowrap; background: ${statusBg}; color: ${statusColor};">
                                        ${msg.status === 'resolved' ? ' Resolved' : (msg.status === 'read' ? 'Read' : ' Unread')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px; color: var(--red);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <div>Failed to load messages</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading inbox messages:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--red);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <div>Network error. Please try again.</div>
                    </div>
                `;
            }
        }

        // Open message detail modal
        async function openHeadMessageModal(messageId) {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/messages/head/${messageId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const msg = data.message;
                    
                    // Create modal
                    const modal = document.createElement('div');
                    modal.id = 'headMessageDetailModal';
                    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
                    
                    modal.innerHTML = `
                        <div style="background: var(--card-bg); border-radius: var(--radius-lg); padding: 30px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px;">
                                <div>
                                    <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 10px; color: var(--text-100);">
                                        ${escapeHtml(msg.subject)}
                                    </h3>
                                    <div style="font-size: 13px; color: var(--text-400); display: flex; gap: 20px; flex-wrap: wrap;">
                                        <span><i class="fas fa-user"></i> From: ${msg.admin_name} (${msg.admin_email})</span>
                                        <span><i class="fas fa-calendar"></i> ${new Date(msg.created_at).toLocaleString()}</span>
                                    </div>
                                </div>
                                <button onclick="closeHeadMessageDetailModal()" style="background: none; border: none; color: var(--text-400); font-size: 24px; cursor: pointer;">&times;</button>
                            </div>

                            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--primary);">
                                <div style="font-size: 13px; color: var(--text-400); margin-bottom: 10px;">Message:</div>
                                <div style="color: var(--text-100); line-height: 1.6; white-space: pre-wrap;">${escapeHtml(msg.message_content)}</div>
                            </div>

                            ${msg.complaint_id ? `
                                <div style="background: rgba(255,215,0,0.1); padding: 15px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #FFD700;">
                                    <div style="font-size: 13px; color: var(--text-400); margin-bottom: 8px;">
                                        <i class="fas fa-link"></i> Linked Complaint:
                                    </div>
                                    <div style="color: var(--text-100); font-size: 14px;">
                                        Complaint #${msg.complaint_number} - ${msg.complaint_status || 'N/A'}
                                    </div>
                                </div>
                            ` : ''}

                            ${msg.reply_content ? `
                                <div style="background: rgba(22,199,130,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #16c782;">
                                    <div style="font-size: 13px; color: var(--text-400); margin-bottom: 10px; display: flex; justify-content: space-between;">
                                        <span><i class="fas fa-reply"></i> Your Reply:</span>
                                        <span>${new Date(msg.replied_at).toLocaleString()}</span>
                                    </div>
                                    <div style="color: var(--text-100); line-height: 1.6; white-space: pre-wrap;">${escapeHtml(msg.reply_content)}</div>
                                </div>
                            ` : ''}

                            ${!msg.reply_content ? `
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-100);">
                                        <i class="fas fa-reply"></i> Your Reply
                                    </label>
                                    <textarea id="headReplyText" rows="6" placeholder="Type your reply here..." style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border); background: rgba(255,255,255,0.05); color: var(--text-100); font-size: 14px; resize: vertical;"></textarea>
                                </div>
                            ` : ''}

                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                ${!msg.reply_content ? `
                                    <button onclick="sendHeadReply(${msg.id})" style="padding: 12px 24px; border-radius: 8px; border: none; background: var(--primary); color: var(--bg-900); cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-paper-plane"></i> Send Reply
                                    </button>
                                ` : ''}
                                ${msg.status !== 'resolved' ? `
                                    <button onclick="resolveMessage(${msg.id})" style="padding: 12px 24px; border-radius: 8px; border: 2px solid var(--green); background: transparent; color: var(--green); cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-check-double"></i> Mark Resolved
                                    </button>
                                ` : ''}
                                <button onclick="closeHeadMessageModal()" style="padding: 12px 24px; border-radius: 8px; border: 2px solid var(--border); background: transparent; color: var(--text-100); cursor: pointer; font-weight: 600;">
                                    Close
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                } else {
                    showToast('Failed to load message', 'error');
                }
            } catch (error) {
                console.error('Error loading message:', error);
                showToast('Network error', 'error');
            }
        }
        window.openHeadMessageModal = openHeadMessageModal;

        function closeHeadMessageDetailModal() {
            const modal = document.getElementById('headMessageDetailModal');
            if (modal) modal.remove();
        }
        window.closeHeadMessageDetailModal = closeHeadMessageDetailModal;

        async function sendHeadReply(messageId) {
            const token = localStorage.getItem('token');
            const replyText = document.getElementById('headReplyText').value.trim();
            
            if (!replyText) {
                showToast('Please enter a reply', 'error');
                return;
            }

            try {
                const response = await fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/messages/head/${messageId}/reply`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reply: replyText })
                });

                if (response.ok) {
                    showToast('Reply sent successfully!', 'success');
                    closeHeadMessageDetailModal();
                    // Refresh inbox if open
                    if (document.getElementById('messagesInboxModal')) {
                        filterMessages(document.querySelector('.msg-filter-btn.active')?.dataset.filter || 'all');
                    }
                } else {
                    const data = await response.json();
                    showToast(data.error || 'Failed to send reply', 'error');
                }
            } catch (error) {
                console.error('Error sending reply:', error);
                showToast('Network error', 'error');
            }
        }
        window.sendHeadReply = sendHeadReply;

        async function resolveMessage(messageId) {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/messages/head/${messageId}/resolve`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showToast('Message marked as resolved', 'success');
                    closeHeadMessageModal();
                    // Refresh inbox if open
                    if (document.getElementById('messagesInboxModal')) {
                        filterMessages(document.querySelector('.msg-filter-btn.active')?.dataset.filter || 'all');
                    }
                } else {
                    const data = await response.json();
                    showToast(data.error || 'Failed to resolve message', 'error');
                }
            } catch (error) {
                console.error('Error resolving message:', error);
                showToast('Network error', 'error');
            }
        }
        window.resolveMessage = resolveMessage;

        console.log(' Head messaging system loaded');
    </script>
    
    <!-- Theme Switcher -->
    <script src="/js/theme-switcher.js?v=2"></script>
    <style>
        /* Theme toggle button dark mode styles for head dashboard */
        body.dark-mode .theme-toggle-btn {
            background: rgba(31, 31, 31, 0.9) !important;
            border-color: rgba(0, 200, 255, 0.4) !important;
            box-shadow: 0 4px 20px rgba(0, 200, 255, 0.2) !important;
        }

        body.dark-mode .theme-toggle-btn:hover {
            box-shadow: 0 6px 25px rgba(0, 200, 255, 0.4) !important;
        }

        body.dark-mode .theme-toggle-btn i {
            color: #00C8FF !important;
        }

        body.dark-mode .theme-toggle-btn span {
            color: #C0C0C0 !important;
        }
    </style>

    <!-- Media Handler for graceful 404 fallbacks -->
    <script src="js/media-handler.js?v=3"></script>
    
    <script>
        // Close media preview function
        window.closeMediaPreview = function() {
            const container = document.getElementById('mediaPreviewContainer');
            if (container) {
                container.style.display = 'none';
                const content = document.getElementById('mediaPreviewContent');
                if (content) content.innerHTML = '';
            }
        };
        
        // Hook into modal close to also close media preview
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('complaintDetailsModal');
            if (modal) {
                const closeBtn = modal.querySelector('[onclick*="close"]');
                if (closeBtn) {
                    const originalOnclick = closeBtn.onclick;
                    closeBtn.onclick = function(e) {
                        if (originalOnclick) originalOnclick.call(this, e);
                        closeMediaPreview();
                    };
                }
            }
        });
        
        // ============================================
        // ENHANCE USERS TABLE WITH VIEW COMPLAINTS BUTTON
        // ============================================
        const originalUsersTableHTML = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML');
        
        // Monitor users table for changes and add View Complaints button
        const observeUsersTable = () => {
            const usersTableWrapper = document.getElementById('usersTableWrapper');
            if (!usersTableWrapper) {
                setTimeout(observeUsersTable, 500);
                return;
            }
            
            const observer = new MutationObserver(() => {
                const table = usersTableWrapper.querySelector('table');
                if (table && table.querySelector('tbody')) {
                    const tbody = table.querySelector('tbody');
                    const rows = tbody.querySelectorAll('tr');
                    
                    rows.forEach(row => {
                        // Check if we already added the button
                        if (row.querySelector('.view-user-complaints-btn')) return;
                        
                        // Get user data from the row
                        const cells = row.querySelectorAll('td');
                        if (cells.length < 4) return;
                        
                        const userId = row.querySelector('[data-user-id]')?.dataset.userId;
                        const userName = cells[1]?.textContent.trim();
                        
                        if (!userId || !userName) return;
                        
                        // Find the actions cell (last cell)
                        const actionsCell = cells[cells.length - 1];
                        if (!actionsCell) return;
                        
                        // Create View Complaints button
                        const viewComplaintsBtn = document.createElement('button');
                        viewComplaintsBtn.className = 'btn btn-sm btn-primary view-user-complaints-btn';
                        viewComplaintsBtn.innerHTML = '<i class="fas fa-clipboard-list"></i> View Complaints';
                        viewComplaintsBtn.title = `View complaints by ${userName}`;
                        viewComplaintsBtn.style.cssText = 'margin-left: 8px; padding: 6px 12px; font-size: 12px;';
                        viewComplaintsBtn.onclick = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            viewUserComplaints(parseInt(userId), userName);
                        };
                        
                        // Add button to actions cell
                        actionsCell.style.whiteSpace = 'nowrap';
                        actionsCell.appendChild(viewComplaintsBtn);
                    });
                }
            });
            
            observer.observe(usersTableWrapper, { childList: true, subtree: true });
        };
        
        // Start observing when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', observeUsersTable);
        } else {
            observeUsersTable();
        }
        
        // Also close mobile menu when clicking nav links
        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 1120) {
                        closeMobileMenu();
                    }
                });
            });
        });
    </script>

    <!-- Create Admin Modal -->
    <div id="createAdminModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(7, 4, 16, 0.92); z-index: 99999;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(145deg, #1a1a2e 0%, #0f0f1a 100%); border-radius: 20px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(139, 92, 246, 0.2), 0 0 40px rgba(139, 92, 246, 0.1); border: 2px solid rgba(139, 92, 246, 0.4);">
            <div style="padding: 24px 28px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; font-size: 20px; color: #8b5cf6; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-user-plus"></i> Create New Admin
                </h2>
                <button id="closeCreateAdminModal" style="background: rgba(255,255,255,0.1); border: none; color: #fff; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 28px;">
                <form id="createAdminForm" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                    <div>
                        <label for="adminName" style="display: block; margin-bottom: 6px; color: #C0C0C0; font-weight: 600; font-size: 14px;">Full Name *</label>
                        <input type="text" id="adminName" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #ffffff; font-size: 14px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label for="adminEmail" style="display: block; margin-bottom: 6px; color: #C0C0C0; font-weight: 600; font-size: 14px;">Email Address *</label>
                        <input type="email" id="adminEmail" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #ffffff; font-size: 14px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label for="adminPhone" style="display: block; margin-bottom: 6px; color: #C0C0C0; font-weight: 600; font-size: 14px;">Phone Number</label>
                        <input type="tel" id="adminPhone" placeholder="E.g. 9876543210" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #ffffff; font-size: 14px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label for="adminPassword" style="display: block; margin-bottom: 6px; color: #C0C0C0; font-weight: 600; font-size: 14px;">Password *</label>
                        <input type="password" id="adminPassword" minlength="8" autocomplete="new-password" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #ffffff; font-size: 14px; box-sizing: border-box;">
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label for="adminDistrict" style="display: block; margin-bottom: 6px; color: #C0C0C0; font-weight: 600; font-size: 14px;">District *</label>
                        <select id="adminDistrict" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #FFD100; background: #1a1a2e; color: #FFD100; font-size: 14px; box-sizing: border-box; cursor: pointer; font-weight: 600;">
                            <option value="" style="background: #1a1a2e; color: #FFD100;">Select District...</option>
                        </select>
                        <small style="color: #9ca3af; display: block; margin-top: 4px; font-size: 12px;">Select from available districts or create new below</small>
                        <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="newDistrictInput" placeholder="Or enter new district name" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #ffffff; font-size: 13px; box-sizing: border-box;">
                            <button type="button" id="addNewDistrictBtn" style="padding: 8px 16px; font-size: 13px; background: linear-gradient(135deg, #FFD100, #FFA500); color: #1a1a2e; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                <i class="fas fa-plus"></i> Add
                            </button>
                            <button type="button" onclick="deleteSelectedDistrict()" style="padding: 8px 16px; font-size: 13px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;" title="Delete selected district">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label for="adminRoutes" style="display: block; margin-bottom: 6px; color: #C0C0C0; font-weight: 600; font-size: 14px;">Routes *</label>
                        <select id="adminRoutes" multiple size="5" required style="width: 100%; min-height: 120px; padding: 10px; border-radius: 8px; border: 1px solid #FFD100; background: #1a1a2e; color: #FFD100; font-size: 14px; box-sizing: border-box; cursor: pointer; font-weight: 600;">
                            <option value="" style="background: #1a1a2e; color: #FFD100;">Select Routes...</option>
                        </select>
                        <small style="color: #9ca3af; display: block; margin-top: 4px; font-size: 12px;">Hold Ctrl/Cmd to select multiple routes</small>
                        <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="newRouteInput" placeholder="Or enter new route (e.g. Palani - Namakkal)" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #ffffff; font-size: 13px; box-sizing: border-box;">
                            <button type="button" id="addNewRouteBtn" style="padding: 8px 16px; font-size: 13px; background: linear-gradient(135deg, #FFD100, #FFA500); color: #1a1a2e; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                <i class="fas fa-plus"></i> Add
                            </button>
                            <button type="button" onclick="deleteSelectedRoutes()" style="padding: 8px 16px; font-size: 13px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;" title="Delete selected route(s)">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    <div style="grid-column: 1 / -1; display: flex; gap: 12px; justify-content: flex-end; margin-top: 12px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <button type="button" onclick="document.getElementById('createAdminModal').style.display='none'; document.getElementById('createAdminForm').reset();" style="padding: 12px 28px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" style="padding: 12px 28px; background: linear-gradient(135deg, #FFD100, #FFA500); color: #1a1a2e; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px;">
                            <i class="fas fa-plus"></i> Create Admin
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</body>
</html>

