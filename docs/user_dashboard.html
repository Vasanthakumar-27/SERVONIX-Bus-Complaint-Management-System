<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link rel="icon" type="image/png" href="assets/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/dashboard-loader.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #120038 0%, #1a0a4a 100%);
            min-height: 100vh;
            color: #333;
            transition: background 0.3s ease;
        }

        /* Dark Mode Background */
        body.dark-mode {
            background: #000000;
        }

        /* Removed initial loading screen - using dashboard loader instead */

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: #1c1431;
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #FFD700;
        }

        body.dark-mode .header {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border: 2px solid rgba(0, 200, 255, 0.4);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 0 0 auto;
        }

        .logo {
            width: 100px;
            height: 100px;
            background: transparent;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-info h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 5px;
            text-shadow: 0 2px 8px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3);
        }

        body.dark-mode .header-info h1 {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header-info p {
            color: #FFF8DC;
            font-size: 0.9rem;
            font-weight: 500;
        }

        body.dark-mode .header-info p {
            color: #C0C0C0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 0 0 auto;
            padding: 0;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000000;
            font-weight: 600;
            border: 2px solid #FFFFFF;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        body.dark-mode .user-avatar {
            background: linear-gradient(135deg, #00C8FF, #0099CC);
            color: #000000;
            border: none;
        }

        /* Profile Dropdown */
        .profile-dropdown-container {
            position: relative;
        }

        .profile-dropdown {
            position: absolute;
            top: 55px;
            right: 0;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-width: 320px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .profile-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        body.dark-mode .profile-dropdown {
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .profile-dropdown-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        body.dark-mode .profile-dropdown-header {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            color: #000;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        body.dark-mode .profile-avatar-large {
            background: linear-gradient(135deg, #00C8FF, #0099CC);
        }

        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-avatar-large .upload-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 5px;
            font-size: 10px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .profile-avatar-large:hover .upload-overlay {
            opacity: 1;
        }

        .profile-name {
            font-size: 18px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 5px;
        }

        body.dark-mode .profile-name {
            color: #ffffff;
        }

        .profile-email {
            font-size: 13px;
            color: #6B7280;
        }

        body.dark-mode .profile-email {
            color: #9CA3AF;
        }

        .profile-role {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
            text-transform: uppercase;
        }

        body.dark-mode .profile-role {
            background: linear-gradient(135deg, #00C8FF, #0099CC);
        }

        .profile-dropdown-body {
            padding: 10px;
        }

        .profile-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
        }

        body.dark-mode .profile-menu-item {
            color: #E5E7EB;
        }

        .profile-menu-item:hover {
            background: rgba(255,215,0,0.1);
        }

        body.dark-mode .profile-menu-item:hover {
            background: rgba(0,200,255,0.1);
        }

        .profile-menu-item i {
            width: 20px;
            text-align: center;
            color: #6B7280;
        }

        body.dark-mode .profile-menu-item i {
            color: #9CA3AF;
        }

        .profile-menu-item.danger {
            color: #EF4444;
        }

        .profile-menu-item.danger i {
            color: #EF4444;
        }

        .profile-info-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: #6B7280;
            font-size: 13px;
        }

        body.dark-mode .profile-info-item {
            color: #9CA3AF;
        }

        .profile-info-item i {
            width: 20px;
            text-align: center;
        }

        .logout-btn {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000000;
            border: 2px solid #FFFFFF;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #FFA500, #FF8C00);
            transform: translateY(-2px);
        }

        body.dark-mode .logout-btn {
            background: #ef4444;
            color: #FFFFFF;
            border: none;
            box-shadow: none;
        }

        body.dark-mode .logout-btn:hover {
            background: #dc2626;
            box-shadow: none;
        }

        /* Modal Overlay for Password Change */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: #ffffff;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: slideDown 0.3s ease;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.1);
            color: #1a1a2e;
        }

        body.dark-mode .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            color: #fff;
            border: 1px solid rgba(0, 200, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 200, 255, 0.15);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        body.dark-mode .modal-header {
            background: linear-gradient(135deg, rgba(0, 200, 255, 0.1), rgba(0, 150, 255, 0.05));
            border-bottom: 1px solid rgba(0, 200, 255, 0.2);
        }

        .modal-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #1a1a2e;
        }

        body.dark-mode .modal-header h3 {
            color: #00C8FF;
        }

        .modal-body {
            padding: 25px;
            background: #ffffff;
        }

        body.dark-mode .modal-body {
            background: transparent;
        }

        .modal-body input,
        .modal-body textarea,
        .modal-body select {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #1a1a2e;
            border-radius: 8px;
            padding: 10px 12px;
        }

        body.dark-mode .modal-body input,
        body.dark-mode .modal-body textarea,
        body.dark-mode .modal-body select {
            background: rgba(45, 45, 68, 0.8);
            border: 1px solid rgba(0, 200, 255, 0.3);
            color: #fff;
        }

        .modal-body label {
            color: #495057;
            font-weight: 500;
        }

        body.dark-mode .modal-body label {
            color: #C0C0C0;
        }

        .modal-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        body.dark-mode .modal-footer {
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(0, 200, 255, 0.2);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: inherit;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .close-btn:hover {
            opacity: 1;
        }

        /* Page Navigation */
        .page-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .page-nav-btn {
            background: rgba(255, 255, 255, 0.95);
            color: #1F2937;
            border: 2px solid transparent;
            padding: 15px 30px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            flex: 1;
            transition: all 0.3s ease;
        }

        .page-nav-btn:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #FFD700;
            transform: translateY(-2px);
        }

        .page-nav-btn.active {
            background: #1c1431;
            color: white;
            border-color: #FFD700;
        }
        }

        body.dark-mode .page-nav-btn {
            background: rgba(26, 26, 26, 0.95);
            color: #C0C0C0;
            border: 2px solid rgba(0, 200, 255, 0.3);
        }

        body.dark-mode .page-nav-btn.active {
            background: linear-gradient(135deg, #00C8FF, #0099CC);
            color: #000000;
            border-color: rgba(0, 200, 255, 0.5);
        }

        /* Pages */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: linear-gradient(135deg, #120038 0%, #1a0a4a 100%);
            border-radius: 20px;
            padding: 30px;
            border: 2px solid #2a1a60;
            color: white;
        }

        body.dark-mode .dashboard-card {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: none;
            color: white;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            border: 2px solid #FFD700;
        }

        .card-icon.complaint { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000000; }
        .card-icon.stats { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000000; }

        body.dark-mode .card-icon { color: white; border: none; box-shadow: none; }
        body.dark-mode .card-icon.complaint { background: #2a2a2a; }
        body.dark-mode .card-icon.stats { background: #2a2a2a; }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
        }

        body.light-mode .card-title {
            background: linear-gradient(135deg, #D4AF37, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        body.dark-mode .card-title {
            color: #FFD700;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        body.dark-mode .form-group label {
            color: #C0C0C0;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            color: #1F2937;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #FFD700;
        }

        body.dark-mode .form-group input,
        body.dark-mode .form-group select,
        body.dark-mode .form-group textarea {
            background: rgba(26, 26, 26, 0.8);
            border: 2px solid rgba(0, 200, 255, 0.3);
            color: #C0C0C0;
        }

        body.dark-mode .form-group input:focus,
        body.dark-mode .form-group select:focus,
        body.dark-mode .form-group textarea:focus {
            border-color: #00C8FF;
            box-shadow: 0 0 0 2px rgba(0, 200, 255, 0.1);
        }

        .submit-btn {
            background: #1c1431;
            color: white;
            border: 2px solid #FFD700;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: #2a1a60;
            transform: translateY(-2px);
        }

        body.dark-mode .submit-btn {
            background: linear-gradient(135deg, #00C8FF, #0099CC);
            color: #000000;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 200, 255, 0.3);
        }

        body.dark-mode .submit-btn:hover {
            box-shadow: 0 6px 16px rgba(0, 200, 255, 0.4);
        }

        /* Field Validation Styles */
        .field-error {
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
            animation: slideIn 0.3s ease;
        }
        
        body.dark-mode .field-error {
            color: #f87171;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .form-group input:invalid:not(:placeholder-shown),
        .form-group select:invalid:not(:placeholder-shown),
        .form-group textarea:invalid:not(:placeholder-shown) {
            border-color: #f59e0b;
        }
        
        .form-group input.error,
        .form-group select.error,
        .form-group textarea.error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }
        
        .form-group input.success,
        .form-group select.success,
        .form-group textarea.success {
            border-color: #22c55e !important;
        }

        /* File Upload */
        .file-input {
            display: none;
        }

        .file-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .file-upload-area:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
        }

        .file-preview {
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            background: #f9fafb;
            padding: 15px;
            border-radius: 12px;
            border: 2px dashed #d1d5db;
        }

        .file-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s, box-shadow 0.2s;
            background: white;
        }

        .file-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        }

        .file-item img,
        .file-item video {
            width: 100%;
            height: 140px;
            object-fit: cover;
            display: block;
        }

        .file-item-info {
            padding: 8px;
            background: #1c1431;
            color: white;
            font-size: 0.75rem;
            text-align: center;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            z-index: 10;
        }

        .file-remove:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1a0a4a 0%, #2a1a60 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid #2a1a60;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Complaints Table */
        .complaints-table-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            max-width: 100%;
        }

        .complaints-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        .complaints-table th {
            background: #1c1431;
            color: #FFD700;
            padding: 15px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 3px solid #D4AF37;
        }

        .complaints-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(209, 213, 219, 0.5);
            color: #000000;
            font-weight: 600;
        }

        .complaints-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            border: 2px solid;
        }

        .status-pending { 
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            color: #92400E;
            border-color: #D4AF37;
        }
        .status-in_progress { 
            background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
            color: #1E40AF;
            border-color: #3B82F6;
        }
        .status-resolved { 
            background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
            color: #065F46;
            border-color: #10B981;
        }

        body.dark-mode .status-pending {
            background: rgba(212, 175, 55, 0.2);
            color: #FFD700;
            border-color: #D4AF37;
        }

        body.dark-mode .status-in_progress {
            background: rgba(0, 200, 255, 0.2);
            color: #00C8FF;
            border-color: #00C8FF;
        }

        body.dark-mode .status-resolved {
            background: rgba(16, 185, 129, 0.2);
            color: #10B981;
            border-color: #10B981;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .btn-view {
            background: linear-gradient(135deg, #D4AF37, #FFD700);
            color: #000000;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.5);
        }

        .btn-delete {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-view:hover {
            background: linear-gradient(135deg, #FFD700, #FFC700);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.7);
        }

        .btn-delete:hover {
            background: linear-gradient(135deg, #F87171, #EF4444);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
        }

        body.dark-mode .btn-view {
            background: #2a2a2a;
            color: #00FFFF;
            border: 1px solid #00FFFF;
            box-shadow: none;
        }

        body.dark-mode .btn-view:hover {
            background: #00FFFF;
            color: #000000;
            box-shadow: 0 2px 8px rgba(0, 255, 255, 0.3);
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }

            .page-nav {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .complaints-table {
                font-size: 0.85rem;
            }

            .complaints-table th,
            .complaints-table td {
                padding: 10px;
            }
        }

        /* Confirm Modal Styles */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10002;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .confirm-modal-content {
            background: #ffffff;
            border-radius: 16px;
            width: 90%;
            max-width: 440px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            animation: slideDown 0.3s ease;
            border: 1px solid rgba(0,0,0,0.1);
        }

        body.dark-mode .confirm-modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border: 1px solid rgba(0, 200, 255, 0.3);
            box-shadow: 0 25px 50px rgba(0, 200, 255, 0.15);
        }

        .confirm-modal-header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            padding: 20px 25px;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .confirm-modal-header i {
            font-size: 1.5rem;
        }

        .confirm-modal-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }

        .confirm-modal-body {
            padding: 25px;
            background: #ffffff;
        }

        body.dark-mode .confirm-modal-body {
            background: transparent;
        }

        .confirm-modal-body p {
            color: #4a5568;
            font-size: 1rem;
            line-height: 1.6;
            margin: 0;
        }

        body.dark-mode .confirm-modal-body p {
            color: #C0C0C0;
        }

        .confirm-modal-actions {
            padding: 20px 25px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
        }

        body.dark-mode .confirm-modal-actions {
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(0, 200, 255, 0.2);
        }

        .confirm-modal-btn {
            padding: 10px 24px;
            border-radius: 8px;
            border: none;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .confirm-modal-btn.cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .confirm-modal-btn.cancel:hover {
            background: #cbd5e0;
        }

        .confirm-modal-btn.confirm {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
        }

        .confirm-modal-btn.confirm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Theme Toggle Button */
        .theme-toggle-btn {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 15px;
        }

        .theme-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: white;
            color: white;
            transform: translateY(-2px);
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background: #000000;
            color: #c0c0c0;
        }

        body.dark-mode .container {
            background: rgba(0, 0, 0, 0.5);
        }

        body.dark-mode .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 2px solid rgba(0, 200, 255, 0.4);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        body.dark-mode .header-info h1 {
            color: #00C8FF;
            text-shadow: 0 0 10px rgba(0, 200, 255, 0.3);
        }

        body.dark-mode .header-info p {
            color: #C0C0C0;
        }

        body.dark-mode .page-nav button {
            background: rgba(26, 26, 26, 0.95);
            color: #C0C0C0;
            border: 2px solid rgba(0, 200, 255, 0.3);
        }

        body.dark-mode .page-nav button.active,
        body.dark-mode .page-nav button:hover {
            background: linear-gradient(135deg, #00C8FF, #0099CC);
            color: #000000;
            border-color: rgba(0, 200, 255, 0.5);
        }

        body.dark-mode .stats-grid {
            background: rgba(0, 0, 0, 0.5);
        }

        body.dark-mode .stat-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 1px solid rgba(0, 200, 255, 0.3);
        }

        body.dark-mode .stat-card h3 {
            color: #00C8FF;
        }

        body.dark-mode .stat-card .stat-value {
            color: #C0C0C0;
        }

        body.dark-mode .content-section {
            background: rgba(0, 0, 0, 0.5);
        }

        body.dark-mode .complaint-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 1px solid rgba(0, 200, 255, 0.3);
        }

        body.dark-mode .complaint-card h3 {
            color: #00C8FF;
        }

        body.dark-mode .complaint-card p {
            color: #C0C0C0;
        }

        body.dark-mode .modal-header h2 {
            color: #00C8FF;
        }

        body.dark-mode input,
        body.dark-mode textarea,
        body.dark-mode select {
            background: rgba(26, 26, 26, 0.8);
            border: 2px solid rgba(0, 200, 255, 0.3);
            color: #C0C0C0;
            font-weight: 500;
        }

        body.dark-mode .complaints-table-container {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .complaints-table th {
            background: #000000;
            color: #FFFFFF;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        body.dark-mode .complaints-table td {
            color: #CCCCCC;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .complaints-table tr:hover {
            background: #2a2a2a;
        }

        /* Notification Bar Styles */
        .notification-bar {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-right: 20px;
        }

        .notification-item {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-icon {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .notification-item:hover .notification-icon {
            transform: scale(1.08);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.25);
            color: white;
        }

        .notification-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ff4d4d;
            color: white;
            font-size: 11px;
            font-weight: 700;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            box-shadow: 0 2px 8px rgba(255, 77, 77, 0.5);
            animation: none;
        }

        .notification-badge.pulse {
            animation: badgePulse 2s ease-in-out infinite;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); box-shadow: 0 2px 8px rgba(255, 77, 77, 0.5); }
            50% { transform: scale(1.15); box-shadow: 0 4px 16px rgba(255, 77, 77, 0.8); }
        }

        .notification-tooltip {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%) scale(0.9);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s ease;
            z-index: 1000;
        }

        .notification-item:hover .notification-tooltip {
            opacity: 1;
            transform: translateX(-50%) scale(1);
        }

        .notification-dropdown {
            position: absolute;
            top: 60px;
            right: 0;
            width: 380px;
            max-height: 500px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 248, 255, 0.98) 100%);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(20px);
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }

        .notification-dropdown.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .dropdown-header {
            padding: 18px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .dropdown-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .dropdown-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 8px;
        }

        .dropdown-item {
            padding: 14px 16px;
            border-radius: 10px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .dropdown-item-title {
            font-weight: 600;
            font-size: 14px;
            color: #2D1B69;
            margin-bottom: 4px;
        }

        .dropdown-item-subtitle {
            font-size: 12px;
            color: #666;
        }

        .dropdown-empty {
            padding: 40px 20px;
            text-align: center;
            color: #999;
            font-size: 14px;
        }

        .dropdown-empty i {
            font-size: 48px;
            opacity: 0.3;
            margin-bottom: 12px;
        }

        body.dark-mode .notification-dropdown {
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.98) 0%, rgba(42, 42, 42, 0.98) 100%);
            border: 1px solid rgba(0, 200, 255, 0.2);
        }

        body.dark-mode .dropdown-item {
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid rgba(0, 200, 255, 0.1);
        }

        body.dark-mode .dropdown-item:hover {
            background: rgba(42, 42, 42, 0.9);
        }

        body.dark-mode .dropdown-item-title {
            color: #C0C0C0;
        }

        body.dark-mode .dropdown-item-subtitle {
            color: #808080;
        }

        body.dark-mode .notification-icon {
            background: rgba(26, 26, 26, 0.95);
            color: #00C8FF;
            border: 1px solid rgba(0, 200, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 200, 255, 0.2);
        }

        body.dark-mode .notification-item:hover .notification-icon {
            background: rgba(42, 42, 42, 0.95);
            color: #00C8FF;
            box-shadow: 0 3px 12px rgba(0, 200, 255, 0.4);
        }

        body.dark-mode .theme-toggle {
            background: rgba(26, 26, 26, 0.95);
            border: 2px solid rgba(0, 200, 255, 0.4);
            box-shadow: 0 2px 8px rgba(0, 200, 255, 0.2);
        }

        body.dark-mode .theme-toggle:hover {
            background: rgba(42, 42, 42, 0.95);
            border-color: #00C8FF;
            box-shadow: 0 4px 16px rgba(0, 200, 255, 0.4);
        }

        body.dark-mode .theme-toggle i {
            color: #00C8FF;
        }

        /* Dark Mode - File Items */
        body.dark-mode .file-item {
            background: rgba(26, 26, 26, 0.9);
            border: 1px solid rgba(0, 200, 255, 0.2);
        }

        body.dark-mode .file-item-info {
            background: rgba(26, 26, 26, 0.95);
            color: #C0C0C0;
        }

        /* Dark Mode - Confirm Modal */
        body.dark-mode .confirm-modal-content {
            background: rgba(26, 26, 26, 0.98);
            border: 1px solid rgba(0, 200, 255, 0.2);
        }

        body.dark-mode .confirm-modal-body p {
            color: #C0C0C0;
            font-weight: 500;
        }

        body.dark-mode .confirm-modal-btn.cancel {
            background: rgba(42, 42, 42, 0.9);
            color: #C0C0C0;
            border: 1px solid rgba(0, 200, 255, 0.3);
        }

        body.dark-mode .confirm-modal-btn.cancel:hover {
            background: rgba(58, 58, 58, 0.9);
        }

        /* Dark Mode - Media Modal */
        body.dark-mode #mediaModal > div {
            background: rgba(26, 26, 26, 0.98) !important;
            border: 1px solid rgba(0, 200, 255, 0.2);
        }

        body.dark-mode #mediaModal button {
            background: rgba(42, 42, 42, 0.9) !important;
            color: #C0C0C0 !important;
        }

        body.dark-mode #mediaModal button:hover {
            background: rgba(58, 58, 58, 0.9) !important;
        }

        @media (max-width: 768px) {
            .notification-bar {
                gap: 12px;
                margin-right: 12px;
            }
            .notification-icon {
                width: 38px;
                height: 38px;
                font-size: 16px;
            }
            .notification-dropdown {
                width: 95vw;
                right: -50px;
            }
        }
    </style>
    <script src="js/config.js"></script>
</head>
<body>
    <!-- Dashboard Loading Overlay -->
    <div class="dashboard-loader-overlay hidden" id="dashboardLoader">
        <div class="loader-container">
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
            <div class="loader-text">
                Loading Dashboard
                <span class="loader-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Hidden file input for profile photo -->
        <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;">
        
        <!-- Header -->
        <header class="header">
            <div class="logo-section">
                <div class="logo">
                    <img src="assets/logo.png" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <div class="header-info">
                    <h1>User Dashboard</h1>
                    <p>Bus Complaint Management System</p>
                </div>
            </div>
            <div class="user-info">
                <!-- Profile Dropdown Container -->
                <div class="profile-dropdown-container">
                    <div class="user-avatar" id="userAvatar" onclick="toggleProfileDropdown()">U</div>
                    
                    <!-- Profile Dropdown -->
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="profile-dropdown-header">
                            <div class="profile-avatar-large" id="profileAvatarLarge" onclick="triggerPhotoUpload()">
                                <span id="profileInitial">U</span>
                                <div class="upload-overlay">
                                    <i class="fas fa-camera"></i> Change
                                </div>
                            </div>
                            <div class="profile-name" id="profileName">Loading...</div>
                            <div class="profile-email" id="profileEmail">loading@email.com</div>
                            <div class="profile-role" id="profileRole">User</div>
                        </div>
                        <div class="profile-dropdown-body">
                            <div class="profile-info-item">
                                <i class="fas fa-clock"></i>
                                <span>Last login: <span id="lastLoginTime">--</span></span>
                            </div>
                            <div class="profile-info-item">
                                <i class="fas fa-phone"></i>
                                <span>Phone: <span id="profilePhone">--</span></span>
                                <span class="edit-phone-btn" onclick="showEditPhoneModal()" style="margin-left: auto; color: #FFD700; cursor: pointer; font-size: 12px;"><i class="fas fa-edit"></i> Edit</span>
                            </div>
                            <div class="profile-menu-item" onclick="showChangePasswordModal()">
                                <i class="fas fa-key"></i>
                                <span>Change Password</span>
                            </div>
                            <div class="profile-menu-item" onclick="triggerPhotoUpload()">
                                <i class="fas fa-camera"></i>
                                <span>Change Profile Photo</span>
                            </div>
                            <div class="profile-menu-item danger" onclick="logoutAllDevices()">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout from All Devices</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-right: 20px;">
                    <div style="font-weight: 600; color: #FFFFFF;" id="userName">Loading...</div>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">User</div>
                </div>
                
                <!-- Notification Bar -->
                <div class="notification-bar">
                    <div class="notification-item" data-type="notifications">
                        <div class="notification-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <span class="notification-badge pulse" id="notificationBadge">0</span>
                        <div class="notification-tooltip">All Notifications</div>
                    </div>
                </div>

                <button class="theme-toggle-btn" id="themeToggle" title="Toggle Dark/Light Mode">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="logout-btn" id="logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <script>
        // ========== PAGE NAVIGATION (Define early for inline onclick handlers) ==========
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.page-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected page
            const selectedPage = document.getElementById(pageName + 'Page');
            if (selectedPage) {
                selectedPage.classList.add('active');
            }
            
            // Highlight active button - safely get the clicked element
            const buttons = document.querySelectorAll('.page-nav-btn');
            if (pageName === 'home' && buttons[0]) buttons[0].classList.add('active');
            if (pageName === 'complaints' && buttons[1]) buttons[1].classList.add('active');
            if (pageName === 'feedback' && buttons[2]) buttons[2].classList.add('active');
            
            // Trigger data loading when functions are available
            if (pageName === 'complaints' && typeof loadMyComplaints === 'function') {
                loadMyComplaints();
            }
            if (pageName === 'feedback' && typeof loadFeedback === 'function') {
                loadFeedback();
            }
        }
        
        // Make globally accessible
        window.showPage = showPage;
        </script>

        <!-- Page Navigation -->
        <div class="page-nav">
            <button class="page-nav-btn active" onclick="showPage('home')">
                <i class="fas fa-home"></i> Home - Submit & Statistics
            </button>
            <button class="page-nav-btn" onclick="showPage('complaints')">
                <i class="fas fa-history"></i> My Complaints History
            </button>
            <button class="page-nav-btn" onclick="showPage('feedback')">
                <i class="fas fa-star"></i> Feedback
            </button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="dashboard-grid">
                <!-- Submit Complaint -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-icon complaint">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h2 class="card-title">Submit New Complaint</h2>
                    </div>
                    
                    <div id="complaintMessage"></div>
                    
                    <form id="complaintForm">
                        <div class="form-group">
                            <label for="district">District *</label>
                            <select id="district" name="district" required onchange="loadRoutesForDistrict(this.value)">
                                <option value="">-- Select District --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="route">Route *</label>
                            <select id="route" name="route" required disabled>
                                <option value="">-- Select District First --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="busNumber">Bus Number *</label>
                            <input type="text" id="busNumber" name="bus_number" required placeholder="Enter bus number">
                        </div>
                        
                        <div class="form-group">
                            <label for="category">Category *</label>
                            <select id="category" name="category" required>
                                <option value="">Select Category</option>
                                <option value="delay">Schedule Delay</option>
                                <option value="cleanliness">Cleanliness Issues</option>
                                <option value="staff">Staff Behavior</option>
                                <option value="safety">Safety Concerns</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="description">Description *</label>
                            <textarea id="description" name="description" rows="4" required placeholder="Describe your complaint..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="proofFiles">
                                <i class="fas fa-paperclip"></i> Upload Proof (Photo/Video/PDF) *
                            </label>
                            <input type="file" id="proofFiles" name="proofFiles" multiple 
                                   accept="image/*,video/*,.pdf" 
                                   class="file-input"
                                   required
                                   onchange="handleFileSelection(event)">
                            <div class="file-upload-area" onclick="document.getElementById('proofFiles').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Click to upload images, videos, or PDFs (Required)</p>
                                <small>Supported: JPG, PNG, GIF, MP4, AVI, MOV, PDF  Max 1GB per file</small>
                            </div>
                            <div id="filePreview" class="file-preview"></div>
                        </div>
                        
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-paper-plane"></i> Submit Complaint
                        </button>
                    </form>
                </div>

                <!-- Statistics -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-icon stats">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h2 class="card-title">My Statistics</h2>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalComplaints">0</div>
                            <div class="stat-label">Total Complaints</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="pendingComplaints">0</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="resolvedComplaints">0</div>
                            <div class="stat-label">Resolved</div>
                        </div>
                    </div>

                    <div style="margin-top: 30px; text-align: center;">
                        <button class="submit-btn" onclick="showPage('complaints')" style="width: auto; padding: 15px 40px;">
                            <i class="fas fa-list"></i> View My Complaints
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Complaints History Page -->
        <div id="complaintsPage" class="page">
            <div class="complaints-table-container">
                <div class="card-header">
                    <div class="card-icon complaint">
                        <i class="fas fa-history"></i>
                    </div>
                    <h2 class="card-title">My Complaints History</h2>
                </div>

                <div id="complaintsTableContainer"></div>
            </div>
        </div>

        <!-- Feedback Page -->
        <div id="feedbackPage" class="page">
            <div class="dashboard-grid">
                <!-- Submit Feedback -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fas fa-star"></i>
                        </div>
                        <h2 class="card-title">Send Feedback to Head Admin</h2>
                        <p style="font-size: 0.85rem; color: #6b7280; margin-top: 8px;">
                            <i class="fas fa-info-circle"></i> You can submit multiple feedbacks. Delete old ones if you wish to provide updated feedback.
                        </p>
                    </div>
                    
                    <div id="feedbackMessage"></div>
                    
                    <form id="feedbackForm">
                        <div class="form-group">
                            <label id="ratingLabel">Rating *</label>
                            <div id="ratingStars" role="radiogroup" aria-labelledby="ratingLabel" style="display: flex; gap: 10px; font-size: 2rem; justify-content: center; margin: 20px 0;">
                                <i class="fas fa-star rating-star" data-rating="1" role="radio" aria-label="1 star" tabindex="0" style="cursor: pointer; color: #d1d5db; transition: all 0.2s;"></i>
                                <i class="fas fa-star rating-star" data-rating="2" role="radio" aria-label="2 stars" tabindex="0" style="cursor: pointer; color: #d1d5db; transition: all 0.2s;"></i>
                                <i class="fas fa-star rating-star" data-rating="3" role="radio" aria-label="3 stars" tabindex="0" style="cursor: pointer; color: #d1d5db; transition: all 0.2s;"></i>
                                <i class="fas fa-star rating-star" data-rating="4" role="radio" aria-label="4 stars" tabindex="0" style="cursor: pointer; color: #d1d5db; transition: all 0.2s;"></i>
                                <i class="fas fa-star rating-star" data-rating="5" role="radio" aria-label="5 stars" tabindex="0" style="cursor: pointer; color: #d1d5db; transition: all 0.2s;"></i>
                            </div>
                            <input type="hidden" id="ratingValue" name="rating" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="feedbackMessageText">Your Message to Head Admin *</label>
                            <textarea id="feedbackMessageText" name="message" rows="6" required placeholder="Share your feedback about the complaint management system..." style="resize: vertical;"></textarea>
                        </div>
                        
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-paper-plane"></i> Submit Feedback
                        </button>
                    </form>
                </div>

                <!-- Feedback History -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-icon stats" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            <i class="fas fa-list"></i>
                        </div>
                        <h2 class="card-title">My Feedback History</h2>
                    </div>
                    
                    <div id="feedbackHistoryContainer" style="max-height: 500px; overflow-y: auto;">
                        <div style="text-align: center; padding: 40px; color: #6b7280;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                            <p style="margin-top: 15px;">Loading feedback...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.IO for real-time updates -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/realtime.js"></script>
    <script src="js/user_dashboard.js"></script>
    <script>
        // ========== PAGE NAVIGATION (Define first for onclick handlers) ==========
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.page-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected page
            const selectedPage = document.getElementById(pageName + 'Page');
            if (selectedPage) {
                selectedPage.classList.add('active');
            }
            
            // Highlight active button - safely get the clicked element
            const buttons = document.querySelectorAll('.page-nav-btn');
            if (pageName === 'home' && buttons[0]) buttons[0].classList.add('active');
            if (pageName === 'complaints' && buttons[1]) buttons[1].classList.add('active');
            if (pageName === 'feedback' && buttons[2]) buttons[2].classList.add('active');
            
            // Load data for specific pages (will be called when functions are defined)
            setTimeout(() => {
                if (pageName === 'complaints' && typeof loadComplaintsTable === 'function') {
                    loadComplaintsTable();
                } else if (pageName === 'feedback' && typeof loadFeedbackHistory === 'function') {
                    loadFeedbackHistory();
                }
            }, 100);
        }
        
        // ========== WEBSOCKET INITIALIZATION ==========
        let socket = null;
        let unreadNotificationCount = 0;
        
        // Ensure API_BASE is available (from auth.js or define it)
        if (typeof API_BASE === 'undefined') {
            var API_BASE = window.API_BASE || 'http://127.0.0.1:5000';
        }
        
        // API Request helper function
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const token = localStorage.getItem('token');
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                }
            };
            
            if (body && method !== 'GET') {
                options.body = JSON.stringify(body);
            }
            
            return await fetch(`${API_BASE}${endpoint}`, options);
        }
        
        // Initialize WebSocket connection
        function initializeWebSocket() {
            const token = getToken();
            if (!token) {
                console.log('[WebSocket] No token found, skipping connection');
                return;
            }
            
            // Determine Socket.IO server URL
            const socketURL = API_BASE || (() => {
                const hostname = window.location.hostname;
                if (hostname.includes('devtunnels.ms')) {
                    return `${window.location.protocol}//${hostname}`;
                }
                return 'http://127.0.0.1:5000';
            })();
            
            console.log('[WebSocket] Connecting to:', socketURL);
            
            // Create Socket.IO connection - prefer polling first then upgrade to websocket
            socket = io(socketURL, {
                transports: ['polling', 'websocket'],
                upgrade: true,
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5,
                timeout: 20000
            });
            
            // Connection established
            socket.on('connect', () => {
                console.log('[WebSocket] Connected:', socket.id);
                
                // Register user with role
                socket.emit('register', {
                    token: token
                });
            });
            
            // Registration successful
            socket.on('registered', (data) => {
                console.log('[WebSocket] Registered:', data);
                unreadNotificationCount = data.unread_count || 0;
                updateNotificationBadge(unreadNotificationCount);
            });
            
            // Real-time complaint updates
            socket.on('complaints_updated', (data) => {
                console.log('[WebSocket] Complaints updated:', data);
                // Reload complaints if on complaints page
                const complaintsPage = document.getElementById('complaintsPage');
                if (complaintsPage && complaintsPage.classList.contains('active')) {
                    loadComplaintsTable();
                }
            });
            
            // Real-time notification updates
            socket.on('notifications_updated', (data) => {
                console.log('[WebSocket] Notifications updated:', data);
                // Could trigger notification refresh here
            });
            
            // New notification received
            socket.on('new_notification', (notification) => {
                console.log('[WebSocket] New notification:', notification);
                unreadNotificationCount++;
                updateNotificationBadge(unreadNotificationCount);
                
                // Show toast notification (optional)
                showMessage(notification.message || 'You have a new notification', 'info');
            });
            
            // Notification marked as read
            socket.on('notification_marked_read', (data) => {
                console.log('[WebSocket] Notification marked read:', data);
                if (unreadNotificationCount > 0) {
                    unreadNotificationCount--;
                    updateNotificationBadge(unreadNotificationCount);
                }
            });
            
            // Connection error
            socket.on('connect_error', (error) => {
                console.error('[WebSocket] Connection error:', error);
            });
            
            // Disconnected
            socket.on('disconnect', (reason) => {
                console.log('[WebSocket] Disconnected:', reason);
            });
            
            // Reconnecting
            socket.on('reconnect_attempt', (attemptNumber) => {
                console.log('[WebSocket] Reconnect attempt:', attemptNumber);
            });
            
            // Reconnected
            socket.on('reconnect', (attemptNumber) => {
                console.log('[WebSocket] Reconnected after', attemptNumber, 'attempts');
                // Re-register after reconnection
                socket.emit('register', { token: token });
            });
            
            // Error handler
            socket.on('error', (error) => {
                console.error('[WebSocket] Error:', error);
            });
        }
        
        // Update notification badge
        function updateNotificationBadge(count) {
            // You can implement notification badge UI here
            console.log('[Notifications] Unread count:', count);
            // Example: document.getElementById('notificationBadge').textContent = count;
        }
        
        // Initialize WebSocket on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeWebSocket();
        });
        
        // Disconnect on page unload
        window.addEventListener('beforeunload', () => {
            if (socket) {
                socket.disconnect();
            }
        });
        
        // ========== END WEBSOCKET INITIALIZATION ==========
        
        // Show loader when page is about to reload
        window.addEventListener('beforeunload', function() {
            showDashboardLoader();
        });

        // Show loader on page visibility change (tab switch back)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                showDashboardLoader();
                setTimeout(() => {
                    hideDashboardLoader();
                }, 500);
            }
        });

        // Check authentication
        if (!getToken()) {
            window.location.href = 'login.html';
        }

        let complaints = [];
        let selectedFiles = [];

        // Page Navigation function already defined at top of script
        // (Removed duplicate definition here)
        
        // Show dashboard loader
        function showDashboardLoader() {
            const loader = document.getElementById('dashboardLoader');
            if (loader) {
                loader.classList.remove('hidden');
            }
        }
        
        // Hide dashboard loader
        function hideDashboardLoader() {
            const loader = document.getElementById('dashboardLoader');
            if (loader) {
                loader.classList.add('hidden');
            }
        }

        // Make showPage globally accessible
        window.showPage = showPage;

        // Logout
        document.getElementById('logout').addEventListener('click', () => {
            clearToken();
            window.location.href = 'login.html';
        });

        // Load user info and profile data
        async function loadUserInfo() {
            const userName = localStorage.getItem('user_name') || 'User';
            document.getElementById('userName').textContent = userName;
            
            // Load full profile from API
            try {
                const response = await apiRequest('/api/profile', 'GET');
                if (response.ok) {
                    const profile = await response.json();
                    
                    // Update profile dropdown
                    document.getElementById('profileName').textContent = profile.name || userName;
                    document.getElementById('profileEmail').textContent = profile.email || '';
                    document.getElementById('profileRole').textContent = profile.role || 'User';
                    
                    // Update avatar with photo or initial
                    const initial = (profile.name || userName).charAt(0).toUpperCase();
                    document.getElementById('profileInitial').textContent = initial;
                    
                    if (profile.profile_pic) {
                        const apiHost = typeof API_BASE !== 'undefined' ? API_BASE : (window.API_BASE || 'http://127.0.0.1:5000');
                        const imgUrl = profile.profile_pic.startsWith('http') 
                            ? profile.profile_pic 
                            : (profile.profile_pic.startsWith('/') ? `${apiHost}${profile.profile_pic}` : `${apiHost}/${profile.profile_pic}`);
                        
                        // Update small avatar
                        document.getElementById('userAvatar').innerHTML = `<img src="${imgUrl}" alt="Profile">`;
                        // Update large avatar in dropdown
                        document.getElementById('profileAvatarLarge').innerHTML = `
                            <img src="${imgUrl}" alt="Profile">
                            <div class="upload-overlay"><i class="fas fa-camera"></i> Change</div>
                        `;
                    } else {
                        document.getElementById('userAvatar').textContent = initial;
                    }
                    
                    // Format and display last login time
                    if (profile.last_active) {
                        const lastLogin = new Date(profile.last_active);
                        const now = new Date();
                        const diffMs = now - lastLogin;
                        const diffMins = Math.floor(diffMs / 60000);
                        const diffHours = Math.floor(diffMs / 3600000);
                        const diffDays = Math.floor(diffMs / 86400000);
                        
                        let timeAgo;
                        if (diffMins < 1) timeAgo = 'Just now';
                        else if (diffMins < 60) timeAgo = `${diffMins} min ago`;
                        else if (diffHours < 24) timeAgo = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                        else if (diffDays < 7) timeAgo = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                        else timeAgo = lastLogin.toLocaleDateString();
                        
                        document.getElementById('lastLoginTime').textContent = timeAgo;
                    }
                    
                    // Display phone number
                    document.getElementById('profilePhone').textContent = profile.phone || '--';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();
            }
        }

        // Toggle profile dropdown
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('profileDropdown');
            const container = document.querySelector('.profile-dropdown-container');
            if (dropdown && container && !container.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Trigger photo upload
        function triggerPhotoUpload() {
            document.getElementById('profilePhotoInput').click();
        }

        // Handle photo upload
        document.getElementById('profilePhotoInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Image must be less than 5MB', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                showToast('Uploading photo...', 'info');
                
                const response = await fetch(`${API_BASE}/api/user/profile-picture`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showToast('Profile photo updated!', 'success');
                    // Reload profile to show new photo
                    loadUserInfo();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to upload photo', 'error');
                }
            } catch (error) {
                console.error('Error uploading photo:', error);
                showToast('Failed to upload photo', 'error');
            }
            
            // Reset input
            e.target.value = '';
        });

        // Show change password modal
        function showChangePasswordModal() {
            // Close profile dropdown
            document.getElementById('profileDropdown').classList.remove('show');
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'changePasswordModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #000;">
                        <h3><i class="fas fa-key"></i> Change Password</h3>
                        <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 25px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">Current Password</label>
                            <input type="password" id="currentPassword" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" placeholder="Enter current password">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">New Password</label>
                            <input type="password" id="newPassword" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" placeholder="Enter new password (min 6 chars)">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">Confirm New Password</label>
                            <input type="password" id="confirmPassword" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" placeholder="Confirm new password">
                        </div>
                        <button onclick="submitPasswordChange()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px;">
                            <i class="fas fa-check"></i> Update Password
                        </button>
                    </div>
                </div>
            `;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            document.body.appendChild(modal);
        }

        // Submit password change
        async function submitPasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('New password must be at least 6 characters', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('New passwords do not match', 'error');
                return;
            }
            
            try {
                const response = await apiRequest('/api/user/change-password', 'POST', {
                    current_password: currentPassword,
                    new_password: newPassword
                });
                
                if (response.ok) {
                    showToast('Password changed successfully!', 'success');
                    document.getElementById('changePasswordModal').remove();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to change password', 'error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showToast('Failed to change password', 'error');
            }
        }

        // Show edit phone modal
        function showEditPhoneModal() {
            // Close profile dropdown
            document.getElementById('profileDropdown').classList.remove('show');
            
            const currentPhone = document.getElementById('profilePhone').textContent || '';
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'editPhoneModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #000;">
                        <h3><i class="fas fa-phone"></i> Update Phone Number</h3>
                        <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 25px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">Phone Number</label>
                            <input type="tel" id="newPhoneNumber" value="${currentPhone !== '--' ? currentPhone : ''}" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" placeholder="Enter phone number (10+ digits)">
                        </div>
                        <button onclick="submitPhoneUpdate()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px;">
                            <i class="fas fa-check"></i> Update Phone
                        </button>
                    </div>
                </div>
            `;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            document.body.appendChild(modal);
        }

        // Submit phone update
        async function submitPhoneUpdate() {
            const phone = document.getElementById('newPhoneNumber').value.trim();
            
            if (phone && phone.length < 10) {
                showToast('Phone number must be at least 10 digits', 'error');
                return;
            }
            
            try {
                const response = await apiRequest('/api/user/update-phone', 'POST', { phone });
                
                if (response.ok) {
                    showToast('Phone number updated!', 'success');
                    document.getElementById('profilePhone').textContent = phone || '--';
                    document.getElementById('editPhoneModal').remove();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to update phone', 'error');
                }
            } catch (error) {
                console.error('Error updating phone:', error);
                showToast('Failed to update phone number', 'error');
            }
        }

        // Logout from all devices
        async function logoutAllDevices() {
            if (!confirm('This will log you out from all devices including this one. Continue?')) {
                return;
            }
            
            try {
                const response = await apiRequest('/api/user/logout-all-devices', 'POST');
                
                if (response.ok) {
                    showToast('Logged out from all devices', 'success');
                    setTimeout(() => {
                        clearToken();
                        window.location.href = 'login.html';
                    }, 1500);
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to logout', 'error');
                }
            } catch (error) {
                console.error('Error logging out:', error);
                showToast('Failed to logout from all devices', 'error');
            }
        }

        // Load district hints
        async function loadDistrictHints() {
            try {
                const response = await apiRequest('/api/districts', 'GET');
                if (response.ok) {
                    const data = await response.json();
                    const districts = Array.isArray(data) ? data : (data.districts || []);
                    const select = document.getElementById('district');
                    const currentValue = select.value;
                    
                    // Clear existing options except the placeholder
                    select.innerHTML = '<option value="">-- Select District --</option>';
                    
                    districts.filter(d => d.is_active !== false).forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.id;
                        option.textContent = district.name;
                        option.dataset.name = district.name; // Store name for form submission
                        if (String(district.id) === currentValue) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    console.log('[DISTRICTS] Loaded', districts.length, 'districts into dropdown');
                }
            } catch (error) {
                console.error('Failed to load districts:', error);
            }
        }
        
        // Load routes for selected district
        async function loadRoutesForDistrict(districtId) {
            const routeSelect = document.getElementById('route');
            
            if (!districtId) {
                routeSelect.innerHTML = '<option value="">-- Select District First --</option>';
                routeSelect.disabled = true;
                return;
            }
            
            routeSelect.innerHTML = '<option value="">Loading routes...</option>';
            routeSelect.disabled = true;
            
            try {
                const response = await apiRequest(`/api/routes?district_id=${districtId}`, 'GET');
                if (response.ok) {
                    const data = await response.json();
                    const routes = Array.isArray(data) ? data : (data.routes || []);
                    
                    routeSelect.innerHTML = '<option value="">-- Select Route --</option>';
                    
                    if (routes.length === 0) {
                        routeSelect.innerHTML = '<option value="">No routes available for this district</option>';
                        routeSelect.disabled = true;
                        return;
                    }
                    
                    routes.filter(r => r.is_active !== false).forEach(route => {
                        const option = document.createElement('option');
                        option.value = route.name; // Use route name for complaint submission
                        option.textContent = `${route.name}${route.code ? ' (' + route.code + ')' : ''}`;
                        routeSelect.appendChild(option);
                    });
                    
                    routeSelect.disabled = false;
                    console.log('[ROUTES] Loaded', routes.length, 'routes for district', districtId);
                }
            } catch (error) {
                console.error('Failed to load routes:', error);
                routeSelect.innerHTML = '<option value="">Error loading routes</option>';
                routeSelect.disabled = true;
            }
        }
        
        // Auto-refresh districts every 30 seconds for real-time updates
        setInterval(async function() {
            console.log('[AUTO-REFRESH] Updating districts in real-time...');
            await loadDistrictHints();
        }, 30000); // 30 seconds

        // File handling
        function handleFileSelection(e) {
            const files = Array.from(e.target.files);
            const maxFileSize = 1024 * 1024 * 1024; // 1GB
            const maxFiles = 10; // Maximum 10 files
            let warnings = [];
            let successCount = 0;
            
            // Check if adding these files exceeds limit
            if (selectedFiles.length + files.length > maxFiles) {
                showFileWarning(` Maximum ${maxFiles} files allowed. You can add ${maxFiles - selectedFiles.length} more file(s).`, 'warning');
                return;
            }
            
            files.forEach(file => {
                // Check for empty files
                if (file.size === 0) {
                    warnings.push(` "${file.name}" is empty (0 bytes)`);
                    return;
                }
                
                // Check file size (1GB limit)
                if (file.size > maxFileSize) {
                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    warnings.push(` "${file.name}" is too large (${fileSizeMB} MB). Max: 1GB`);
                    return;
                }
                
                // Check file type with detailed message
                const validImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                const validVideoTypes = ['video/mp4', 'video/avi', 'video/quicktime', 'video/webm', 'video/mov'];
                const validDocTypes = ['application/pdf'];
                const validTypes = [...validImageTypes, ...validVideoTypes, ...validDocTypes];
                
                if (!validTypes.includes(file.type)) {
                    const extension = file.name.split('.').pop().toLowerCase();
                    warnings.push(` "${file.name}" (.${extension}) is not supported. Use: JPG, PNG, GIF, MP4, AVI, MOV, or PDF`);
                    return;
                }
                
                // Check for duplicate files
                const isDuplicate = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                if (isDuplicate) {
                    warnings.push(` "${file.name}" is already added`);
                    return;
                }
                
                selectedFiles.push(file);
                successCount++;
            });
            
            // Show warnings if any
            if (warnings.length > 0) {
                showFileWarning(warnings.join('<br>'), 'error');
            }
            
            // Show success message if some files added
            if (successCount > 0 && warnings.length > 0) {
                showMessage(`${successCount} file(s) added successfully. Some files were skipped.`, 'warning');
            } else if (successCount > 0) {
                showFileWarning(` ${successCount} file(s) added successfully`, 'success');
            }
            
            displayFilePreview();
            updateFileInputLabel();
        }
        
        // Show inline warning below file input
        function showFileWarning(message, type) {
            let warningDiv = document.getElementById('fileWarning');
            if (!warningDiv) {
                warningDiv = document.createElement('div');
                warningDiv.id = 'fileWarning';
                warningDiv.style.cssText = 'margin-top: 10px; padding: 12px; border-radius: 8px; font-size: 0.9rem; animation: slideIn 0.3s ease;';
                const filePreview = document.getElementById('filePreview');
                filePreview.parentNode.insertBefore(warningDiv, filePreview);
            }
            
            const colors = {
                error: { bg: 'rgba(239, 68, 68, 0.1)', border: '#ef4444', text: '#dc2626' },
                warning: { bg: 'rgba(245, 158, 11, 0.1)', border: '#f59e0b', text: '#d97706' },
                success: { bg: 'rgba(34, 197, 94, 0.1)', border: '#22c55e', text: '#16a34a' }
            };
            
            const color = colors[type] || colors.warning;
            warningDiv.style.background = color.bg;
            warningDiv.style.border = `1px solid ${color.border}`;
            warningDiv.style.color = color.text;
            warningDiv.innerHTML = message;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (warningDiv && warningDiv.parentNode) {
                    warningDiv.style.opacity = '0';
                    warningDiv.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => warningDiv.remove(), 300);
                }
            }, 5000);
        }
        
        // Update file input label with count
        function updateFileInputLabel() {
            const uploadArea = document.querySelector('.file-upload-area p');
            if (uploadArea) {
                if (selectedFiles.length > 0) {
                    uploadArea.innerHTML = `<strong>${selectedFiles.length}</strong> file(s) selected - Click to add more`;
                } else {
                    uploadArea.innerHTML = 'Click to upload images, videos, or PDFs (Required)';
                }
            }
        }

        function displayFilePreview() {
            const preview = document.getElementById('filePreview');
            if (selectedFiles.length === 0) {
                preview.innerHTML = '';
                preview.style.display = 'none';
                return;
            }
            
            preview.style.display = 'grid';
            preview.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.alt = file.name;
                    fileItem.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.controls = false;
                    video.muted = true;
                    fileItem.appendChild(video);
                } else if (file.type === 'application/pdf') {
                    const iconDiv = document.createElement('div');
                    iconDiv.style.cssText = 'width: 100%; height: 140px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;';
                    iconDiv.innerHTML = '<i class="fas fa-file-pdf" style="font-size: 3rem;"></i>';
                    fileItem.appendChild(iconDiv);
                } else {
                    const iconDiv = document.createElement('div');
                    iconDiv.style.cssText = 'width: 100%; height: 140px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white;';
                    iconDiv.innerHTML = '<i class="fas fa-file" style="font-size: 3rem;"></i>';
                    fileItem.appendChild(iconDiv);
                }
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-item-info';
                fileInfo.textContent = file.name;
                fileInfo.title = file.name;
                fileItem.appendChild(fileInfo);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'file-remove';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeFile(index);
                };
                fileItem.appendChild(removeBtn);
                
                preview.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayFilePreview();
            updateFileInputLabel();
        }
        
        // Validate form field and show inline warning
        function validateField(fieldId, fieldName, customValidation = null) {
            const field = document.getElementById(fieldId);
            if (!field) return true;
            
            const value = field.value.trim();
            let isValid = true;
            let errorMsg = '';
            
            // Check if empty
            if (!value) {
                isValid = false;
                errorMsg = `${fieldName} is required`;
            }
            // Custom validation
            else if (customValidation) {
                const result = customValidation(value);
                if (result !== true) {
                    isValid = false;
                    errorMsg = result;
                }
            }
            
            // Show/hide error styling
            const existingError = field.parentNode.querySelector('.field-error');
            if (!isValid) {
                field.style.borderColor = '#ef4444';
                field.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                
                if (!existingError) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'field-error';
                    errorDiv.style.cssText = 'color: #ef4444; font-size: 0.85rem; margin-top: 5px; display: flex; align-items: center; gap: 5px;';
                    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${errorMsg}`;
                    field.parentNode.appendChild(errorDiv);
                }
            } else {
                field.style.borderColor = '';
                field.style.boxShadow = '';
                if (existingError) existingError.remove();
            }
            
            return isValid;
        }
        
        // Clear field errors on input
        document.querySelectorAll('#complaintForm input, #complaintForm select, #complaintForm textarea').forEach(field => {
            field.addEventListener('input', function() {
                this.style.borderColor = '';
                this.style.boxShadow = '';
                const error = this.parentNode.querySelector('.field-error');
                if (error) error.remove();
            });
            field.addEventListener('change', function() {
                this.style.borderColor = '';
                this.style.boxShadow = '';
                const error = this.parentNode.querySelector('.field-error');
                if (error) error.remove();
            });
        });

        // Submit complaint
        document.getElementById('complaintForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('.submit-btn');
            
            // Clear all previous errors
            document.querySelectorAll('.field-error').forEach(el => el.remove());
            document.querySelectorAll('#complaintForm input, #complaintForm select, #complaintForm textarea').forEach(field => {
                field.style.borderColor = '';
                field.style.boxShadow = '';
            });
            
            // Validate all fields
            let isFormValid = true;
            const errors = [];
            
            // Validate District
            if (!validateField('district', 'District')) {
                isFormValid = false;
                errors.push('District');
            }
            
            // Validate Route
            if (!validateField('route', 'Route')) {
                isFormValid = false;
                errors.push('Route');
            }
            
            // Validate Bus Number with pattern
            if (!validateField('busNumber', 'Bus Number', (value) => {
                if (value.length < 2) return 'Bus number must be at least 2 characters';
                if (value.length > 20) return 'Bus number is too long (max 20 characters)';
                return true;
            })) {
                isFormValid = false;
                errors.push('Bus Number');
            }
            
            // Validate Category
            if (!validateField('category', 'Category')) {
                isFormValid = false;
                errors.push('Category');
            }
            
            // Validate Description
            if (!validateField('description', 'Description', (value) => {
                if (value.length < 10) return 'Description must be at least 10 characters';
                if (value.length > 2000) return 'Description is too long (max 2000 characters)';
                return true;
            })) {
                isFormValid = false;
                errors.push('Description');
            }
            
            // Validate Files
            if (selectedFiles.length === 0) {
                isFormValid = false;
                errors.push('Proof Files');
                showFileWarning(' Please upload at least one proof file (photo, video, or PDF)', 'error');
            }
            
            // Show summary error if validation failed
            if (!isFormValid) {
                showMessage(`Please fix the following: ${errors.join(', ')}`, 'error');
                // Scroll to first error
                const firstErrorField = document.querySelector('.field-error');
                if (firstErrorField) {
                    firstErrorField.parentNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }
            
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            submitBtn.disabled = true;

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showMessage('Please login again', 'error');
                    window.location.href = 'login.html';
                    return;
                }

                let mediaIds = [];
                
                // First, upload files (now mandatory)
                if (selectedFiles.length > 0) {
                    const formData = new FormData();
                    selectedFiles.forEach(file => {
                        formData.append('files', file);
                    });
                    
                    const uploadResponse = await fetch(`${API_BASE}/api/upload-media`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        },
                        body: formData
                    });
                    
                    if (uploadResponse.ok) {
                        const uploadResult = await uploadResponse.json();
                        mediaIds = uploadResult.uploaded_files.map(f => f.id);
                        
                        if (uploadResult.errors && uploadResult.errors.length > 0) {
                            showMessage('Some files failed: ' + uploadResult.errors.join(', '), 'warning');
                        }
                    } else {
                        throw new Error('File upload failed');
                    }
                }
                
                // Then, submit complaint with media IDs
                const districtSelect = document.getElementById('district');
                const districtName = districtSelect.options[districtSelect.selectedIndex]?.text || '';
                
                const complaintData = {
                    bus_number: document.getElementById('busNumber').value.trim(),
                    district_name: districtName,
                    route_name: document.getElementById('route').value, // Already the route name
                    category: document.getElementById('category').value,
                    description: document.getElementById('description').value,
                    media_ids: mediaIds
                };

                const response = await fetch(`${API_BASE}/api/complaints`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(complaintData)
                });
                
                if (response.ok) {
                    showMessage('Complaint submitted successfully!', 'success');
                    document.getElementById('complaintForm').reset();
                    // Reset route dropdown to disabled state
                    const routeSelect = document.getElementById('route');
                    routeSelect.innerHTML = '<option value="">-- Select District First --</option>';
                    routeSelect.disabled = true;
                    selectedFiles = [];
                    displayFilePreview();
                    loadStatistics();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to submit complaint', 'error');
                }
            } catch (error) {
                console.error('Submission error:', error);
                showMessage('Connection error. Please check if server is running.', 'error');
            } finally {
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Complaint';
                submitBtn.disabled = false;
            }
        });

        // Load statistics
        async function loadStatistics() {
            try {
                const response = await apiRequest('/api/my/complaints');
                
                if (response.ok) {
                    const data = await response.json();
                    // Ensure complaints is always an array
                    complaints = Array.isArray(data) ? data : (data.complaints || []);
                    const total = complaints.length;
                    const pending = complaints.filter(c => c.status === 'pending').length;
                    const resolved = complaints.filter(c => c.status === 'resolved').length;
                    
                    document.getElementById('totalComplaints').textContent = total;
                    document.getElementById('pendingComplaints').textContent = pending;
                    document.getElementById('resolvedComplaints').textContent = resolved;
                }
            } catch (error) {
                console.error('Failed to load statistics:', error);
            }
        }

        // Load complaints table
        async function loadComplaintsTable() {
            const container = document.getElementById('complaintsTableContainer');
            container.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #4c1d95;"></i></div>';

            try {
                const response = await apiRequest('/api/my/complaints');
                
                if (response.ok) {
                    const data = await response.json();
                    complaints = data.complaints || data;  // Handle both paginated and array responses
                    
                    if (!complaints || complaints.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <h3>No Complaints Yet</h3>
                                <p>You haven't submitted any complaints</p>
                            </div>
                        `;
                        return;
                    }

                    const tableHTML = `
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                            <button id="toggleSelectionBtn" onclick="toggleSelectionMode()" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <i class="fas fa-check-square"></i> Select Items
                            </button>
                            <button id="deleteSelectedBtn" onclick="deleteSelectedComplaints()" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: none;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <i class="fas fa-trash"></i> Delete Selected (<span id="selectedCount">0</span>)
                            </button>
                            <button id="cancelSelectionBtn" onclick="cancelSelectionMode()" style="background: linear-gradient(135deg, #6b7280, #4b5563); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: none;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                        <table class="complaints-table">
                            <thead>
                                <tr>
                                    <th class="checkbox-column" style="width: 50px; display: none;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" style="cursor: pointer; width: 18px; height: 18px;"></th>
                                    <th>ID</th>
                                    <th>Bus</th>
                                    <th>District</th>
                                    <th>Route</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Media</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${complaints.map(c => `
                                    <tr>
                                        <td class="checkbox-column" style="display: none;"><input type="checkbox" class="complaint-checkbox" data-id="${c.id}" onchange="updateDeleteButton()" style="cursor: pointer; width: 18px; height: 18px;"></td>
                                        <td>#${c.id}</td>
                                        <td>${c.bus_number}</td>
                                        <td>${c.district_name || 'N/A'}</td>
                                        <td>${c.route_name || c.route || 'N/A'}</td>
                                        <td>${c.category}</td>
                                        <td><span class="status-badge status-${c.status}">${c.status.replace('_', ' ').toUpperCase()}</span></td>
                                        <td>
                                            ${c.media_files && c.media_files.length > 0 ? `
                                                <span style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                                    <i class="fas fa-paperclip"></i> ${c.media_files.length}
                                                </span>
                                            ` : '<span style="color: #9ca3af;">-</span>'}
                                        </td>
                                        <td>${new Date(c.created_at).toLocaleDateString()}</td>
                                        <td>
                                            <button class="action-btn btn-view" onclick="viewComplaint(${c.id})">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                            <button class="action-btn btn-delete" onclick="deleteComplaint(${c.id})">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    
                    container.innerHTML = tableHTML;
                } else {
                    container.innerHTML = '<div class="message error">Failed to load complaints</div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="message error">Connection error</div>';
            }
        }

        // View complaint with media files
        async function viewComplaint(id) {
            const complaint = complaints.find(c => c.id === id);
            if (!complaint) return;
            
            // Reuse API_BASE already defined at top of script
            // (Removed duplicate const declaration)
            
            // Load media URLs (try public route first, fallback to authenticated)
            const mediaFiles = complaint.media_files || [];
            const authenticatedMedia = await Promise.all(mediaFiles.map(async (media) => {
                const fileType = media.file_type || media.mime_type || '';
                const isImageType = fileType === 'image' || fileType.startsWith('image/');
                if (isImageType) {
                    try {
                        // Extract just the filename from the full path
                        const fileName = media.file_path.split('/').pop();
                        
                        // Use full API_BASE URL (frontend is on GitHub Pages, not the API server)
                        let response = await fetch(`${API_BASE}/api/media/${fileName}`);
                        
                        // Fallback to authenticated route
                        if (!response.ok) {
                            response = await apiRequest(`/api/media/${fileName}`);
                        }
                        
                        if (response.ok) {
                            const blob = await response.blob();
                            media.authUrl = URL.createObjectURL(blob);
                        }
                    } catch (e) {
                        console.error('Failed to load image:', e);
                    }
                }
                return media;
            }));
            

            // Media gallery unchanged
            const mediaGallery = authenticatedMedia.length > 0 ? `
                <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 16px; border: 2px solid #3b82f6;">
                    <h3 style="color: #1e40af; margin-bottom: 16px; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-paperclip" style="color: #3b82f6;"></i> 
                        Uploaded Media Files (${authenticatedMedia.length})
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px;">
                        ${authenticatedMedia.map(media => {
                            const fileType = media.file_type || media.mime_type || '';
                            const isImage = fileType === 'image' || fileType.startsWith('image/');
                            const isVideo = fileType === 'video' || fileType.startsWith('video/');
                            const isPDF = fileType === 'document' || fileType === 'application/pdf' || fileType.includes('pdf');
                            const displayType = isImage ? 'image' : isVideo ? 'video' : 'document';
                            const iconClass = isImage ? 'fa-image' : isVideo ? 'fa-video' : 'fa-file-pdf';
                            const bgColor = isImage ? 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)' : isVideo ? 'linear-gradient(135deg, #1e40af 0%, #2563eb 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                            const iconColor = isImage ? '#3b82f6' : isVideo ? '#1e40af' : '#ef4444';
                            return `
                                <div style="position: relative; background: white; border-radius: 16px; overflow: hidden; cursor: pointer; box-shadow: 0 6px 16px rgba(0,0,0,0.1); transition: all 0.3s; border: 2px solid ${iconColor}20;" 
                                     onclick="openAuthenticatedMediaModal('${media.file_path}', '${displayType}', '${media.file_name}')" 
                                     onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 12px 28px rgba(0,0,0,0.2)'" 
                                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.1)'">
                                    ${isImage && media.authUrl ? `
                                        <img src="${media.authUrl}" style="width: 100%; height: 160px; object-fit: cover; display: block;" alt="${media.file_name}">
                                    ` : isImage ? `
                                        <div style="height: 160px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: ${bgColor}; color: white; gap: 8px;">
                                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                                            <span style="font-size: 0.75rem;">Loading...</span>
                                        </div>
                                    ` : `
                                        <div style="height: 160px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: ${bgColor}; color: white; gap: 8px;">
                                            <i class="fas ${iconClass}" style="font-size: 3.5rem; opacity: 0.95; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));"></i>
                                            <span style="font-size: 0.75rem; opacity: 0.9; text-transform: uppercase; font-weight: 600;">${displayType}</span>
                                        </div>
                                    `}
                                    <div style="padding: 12px; background: ${bgColor}; color: white; font-size: 0.8rem; text-align: center; font-weight: 600; word-wrap: break-word; line-height: 1.3;" title="${media.file_name}">
                                        <i class="fas ${iconClass}" style="margin-right: 6px;"></i>
                                        ${media.file_name}
                                    </div>
                                    <div style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.95); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                        <i class="fas fa-search-plus" style="color: ${iconColor}; font-size: 0.9rem;"></i>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : '<div style="margin-top: 20px; padding: 20px; background: #f3f4f6; border-radius: 12px; text-align: center; color: #6b7280; border: 2px dashed #d1d5db;"><i class="fas fa-info-circle" style="font-size: 1.5rem; margin-bottom: 8px; display: block;"></i><strong>No media files uploaded</strong></div>';
            

            const modalHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="closeComplaintModal()">
                    <div style="background: white; border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        <div style="padding: 24px; border-bottom: 2px solid #e5e7eb; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); border-radius: 16px 16px 0 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h2 style="color: white; margin: 0; font-size: 1.5rem;"><i class="fas fa-ticket-alt"></i> Complaint #${complaint.id}</h2>
                                <button onclick="closeComplaintModal()" style="background: rgba(255,255,255,0.2); border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; color: white; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div style="padding: 24px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                                <div><strong style="color: #6b7280;">Bus Number:</strong><br><span style="color: #1f2937; font-size: 1.1rem; word-wrap: break-word;">${complaint.bus_number}</span></div>
                                <div><strong style="color: #6b7280;">Status:</strong><br><span class="status-badge status-${complaint.status}">${complaint.status.replace('_', ' ').toUpperCase()}</span></div>
                                <div><strong style="color: #6b7280;">District:</strong><br><span style="color: #1f2937; word-wrap: break-word;">${complaint.district_name || 'N/A'}</span></div>
                                <div><strong style="color: #6b7280;">Route:</strong><br><span style="color: #1f2937; word-wrap: break-word;">${complaint.route_name || complaint.route || 'N/A'}</span></div>
                                <div><strong style="color: #6b7280;">Category:</strong><br><span style="color: #1f2937; word-wrap: break-word;">${complaint.category}</span></div>
                                <div><strong style="color: #6b7280;">Date:</strong><br><span style="color: #1f2937; word-wrap: break-word;">${new Date(complaint.created_at).toLocaleString()}</span></div>
                            </div>
                            <div style="margin-top: 20px;">
                                <h3 style="color: #1f2937; margin-bottom: 8px; font-size: 1.1rem;"><i class="fas fa-align-left"></i> Description</h3>
                                <p style="background: #f9fafb; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6; color: #374151; line-height: 1.6;">${complaint.description || 'No description provided'}</p>
                            </div>
                            ${mediaGallery}
                            ${complaint.admin_notes ? `
                                <div style="margin-top: 20px;">
                                    <h3 style="color: #1f2937; margin-bottom: 8px; font-size: 1.1rem;"><i class="fas fa-comment-dots"></i> Admin Notes</h3>
                                    <p style="background: #fef3c7; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b; color: #92400e; line-height: 1.6;">${complaint.admin_notes}</p>
                                </div>
                            ` : ''}

                            <!-- Complaint Communication Section -->
                            <div id="complaintCommSection_${complaint.id}" style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%); border-radius: 16px; border: 2px solid #FFD100;">
                                <h3 style="color: #1e40af; margin-bottom: 16px; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-reply" style="color: #FFD100;"></i>
                                    Complaint Communication
                                </h3>
                                <div id="commMessages_${complaint.id}" style="max-height: 180px; overflow-y: auto; background: #fff; border-radius: 8px; padding: 12px; margin-bottom: 12px; border: 1px solid #e5e7eb;"></div>
                                <form id="commForm_${complaint.id}" style="display: flex; gap: 8px;">
                                    <input type="text" id="commInput_${complaint.id}" placeholder="Type your message..." style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #e5e7eb; font-size: 1rem;">
                                    <button type="submit" style="background: linear-gradient(135deg, #FFD100, #FFD700); color: #1e40af; border: none; padding: 10px 18px; border-radius: 8px; font-weight: 700; cursor: pointer;">
                                        <i class="fas fa-paper-plane"></i> Reply
                                    </button>
                                </form>
                            </div>

                            <!-- Complaint Feedback Section -->
                            <div id="complaintFeedbackSection_${complaint.id}" style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 16px; border: 2px solid #FFD700;">
                                <h3 style="color: #78350f; margin-bottom: 16px; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-star" style="color: #FFD700;"></i>
                                    Your Feedback for This Complaint
                                </h3>
                                <div id="feedbackContent_${complaint.id}" style="text-align: center; padding: 20px;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: #92400e;"></i>
                                    <p style="margin-top: 10px; color: #92400e;">Loading feedback...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', `<div id="complaintModal">${modalHTML}</div>`);

            // Load communication messages for this complaint
            loadComplaintMessages(complaint.id);

            // Attach submit handler for reply
            setTimeout(() => {
                const commForm = document.getElementById(`commForm_${complaint.id}`);
                if (commForm) {
                    commForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const input = document.getElementById(`commInput_${complaint.id}`);
                        const message = input.value.trim();
                        if (message.length === 0) return;
                        await sendComplaintMessage(complaint.id, message);
                        input.value = '';
                    };
                }
            }, 100);

            // Load feedback for this complaint
            loadComplaintFeedback(complaint.id);
            
            // Load complaint communication messages
            async function loadComplaintMessages(complaintId) {
                const container = document.getElementById(`commMessages_${complaintId}`);
                if (!container) return;
                container.innerHTML = '<div style="text-align:center; color:#6b7280;"><i class="fas fa-spinner fa-spin"></i> Loading messages...</div>';
                try {
                    const response = await apiRequest(`/api/complaints/${complaintId}/messages`);
                    if (response.ok) {
                        const data = await response.json();
                        const messages = data.messages || [];
                        if (messages.length === 0) {
                            container.innerHTML = '<div style="text-align:center; color:#6b7280;">No messages yet.</div>';
                            return;
                        }
                        container.innerHTML = messages.map(msg => `
                            <div style="margin-bottom:8px; padding:8px 12px; background:#f9fafb; border-radius:6px; color:#1e40af; font-size:0.97rem;">
                                <strong style="color:${msg.sender_role === 'admin' || msg.sender_role === 'head' ? '#ef4444' : '#3b82f6'}">${msg.sender_name || (msg.sender_role === 'admin' || msg.sender_role === 'head' ? 'Admin' : 'You')}:</strong> 
                                <span style="color:#1f2937;">${msg.message}</span>
                                <span style="display:block; color:#6b7280; font-size:0.75rem; margin-top:4px;">${new Date(msg.created_at).toLocaleString()}</span>
                            </div>
                        `).join('');
                        // Scroll to bottom
                        container.scrollTop = container.scrollHeight;
                    } else {
                        container.innerHTML = '<div style="text-align:center; color:#dc2626;">Failed to load messages.</div>';
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                    container.innerHTML = '<div style="text-align:center; color:#dc2626;">Connection error.</div>';
                }
            }

            // Send a new complaint message
            async function sendComplaintMessage(complaintId, message) {
                try {
                    const response = await apiRequest(`/api/complaints/${complaintId}/messages`, 'POST', { message });
                    if (response.ok) {
                        await loadComplaintMessages(complaintId);
                    } else {
                        alert('Failed to send message');
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Connection error');
                }
            }
            
            // Load complaint feedback
            
            // Submit complaint feedback
            
            // Star rating helpers
            window.highlightStars = function(complaintId, rating) {
                const stars = document.querySelectorAll(`#ratingStars_${complaintId} .fa-star`);
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.style.color = '#FFD700';
                    } else {
                        star.style.color = '#d1d5db';
                    }
                });
            };
            
            window.selectRating = function(complaintId, rating) {
                document.getElementById(`rating_${complaintId}`).value = rating;
                highlightStars(complaintId, rating);
            };
        }
        
        function closeComplaintModal() {
            const modal = document.getElementById('complaintModal');
            if (modal) modal.remove();
        }
        window.closeComplaintModal = closeComplaintModal;

        // Modern Confirm Modal Functions
        function showConfirmModal(title, message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const titleElement = document.getElementById('confirmModalTitle');
            const messageElement = document.getElementById('confirmModalMessage');
            const confirmBtn = document.getElementById('confirmModalBtn');
            
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            // Remove old event listeners by cloning
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.onclick = async () => {
                closeConfirmModal();
                if (onConfirm) await onConfirm();
            };
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Delete complaint
        async function deleteComplaint(id) {
            showConfirmModal(
                'Delete Complaint',
                'Are you sure you want to delete this complaint? This action cannot be undone.',
                async () => {
                    try {
                        const response = await apiRequest(`/api/my/complaints/${id}`, 'DELETE');
                        
                        if (response.ok) {
                            showMessage('Complaint deleted successfully', 'success');
                            loadComplaintsTable();
                            loadStatistics();
                        } else {
                            const error = await response.json();
                            showMessage(error.error || 'Failed to delete complaint', 'error');
                        }
                    } catch (error) {
                        showMessage('Connection error. Please try again.', 'error');
                    }
                }
            );
        }

        // Load feedback history
        
        // Make functions globally accessible
        window.viewComplaint = viewComplaint;
        window.deleteComplaint = deleteComplaint;
        window.loadFeedbackHistory = loadFeedbackHistory;

        // ========== COMPLAINT FEEDBACK SYSTEM ==========
        
        // Load feedback for a specific complaint
        async function loadComplaintFeedback(complaintId) {
            const container = document.getElementById(`feedbackContent_${complaintId}`);
            if (!container) return;
            
            try {
                const response = await apiRequest(`/api/complaints/${complaintId}/feedback`);
                const data = await response.json();
                
                if (response.ok && data.feedback) {
                    // Feedback exists - show edit/delete options
                    const feedback = data.feedback;
                    const stars = ''.repeat(feedback.rating) + ''.repeat(5 - feedback.rating);
                    
                    container.innerHTML = `
                        <div style="text-align: left;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-size: 1.5rem; color: #FFD700;" title="${feedback.rating}/5 stars">${stars}</div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="openEditFeedbackModal(${complaintId}, ${feedback.rating}, \`${feedback.message.replace(/`/g, '\\`')}\`)" 
                                        style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;"
                                        onmouseover="this.style.transform='scale(1.05)'" 
                                        onmouseout="this.style.transform='scale(1)'">
                                        <i class="fas fa-edit"></i> Edit Feedback
                                    </button>
                                    <button onclick="deleteComplaintFeedback(${complaintId})" 
                                        style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;"
                                        onmouseover="this.style.transform='scale(1.05)'" 
                                        onmouseout="this.style.transform='scale(1)'">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                            <p style="background: white; padding: 12px; border-radius: 8px; color: #374151; line-height: 1.6; border-left: 4px solid #FFD700;">${feedback.message}</p>
                            <div style="margin-top: 8px; font-size: 0.85rem; color: #78350f;">
                                <i class="fas fa-clock"></i> Submitted ${new Date(feedback.created_at).toLocaleString()}
                                ${feedback.updated_at ? `<br><i class="fas fa-edit"></i> Updated ${new Date(feedback.updated_at).toLocaleString()}` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // No feedback - show add button
                    container.innerHTML = `
                        <div style="text-align: center;">
                            <p style="color: #78350f; margin-bottom: 16px; font-size: 1rem;">
                                <i class="fas fa-info-circle"></i> You haven't submitted feedback for this complaint yet.
                            </p>
                            <button onclick="openAddFeedbackModal(${complaintId})" 
                                style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #1f2937; border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 1rem;"
                                onmouseover="this.style.transform='scale(1.08)'; this.style.boxShadow='0 8px 20px rgba(255, 215, 0, 0.4)'" 
                                onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                                <i class="fas fa-plus-circle"></i> Add Feedback
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div style="text-align: center; color: #dc2626;">
                        <i class="fas fa-exclamation-triangle"></i> Failed to load feedback
                    </div>
                `;
            }
        }
        
        // Open modal to add new feedback
        function openAddFeedbackModal(complaintId) {
            const modalHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;" id="feedbackModalOverlay" onclick="closeFeedbackModal()">
                    <div style="background: white; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        <div style="padding: 24px; border-bottom: 2px solid #e5e7eb; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border-radius: 16px 16px 0 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h2 style="color: #1f2937; margin: 0; font-size: 1.5rem;"><i class="fas fa-star"></i> Add Feedback</h2>
                                <button onclick="closeFeedbackModal()" style="background: rgba(0,0,0,0.1); border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; color: #1f2937; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(0,0,0,0.2)'" onmouseout="this.style.background='rgba(0,0,0,0.1)'">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <form id="addFeedbackForm" style="padding: 24px;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600;">Rating *</label>
                                <div id="starRating" style="display: flex; gap: 10px; font-size: 2.5rem; justify-content: center; margin: 10px 0;">
                                    <i class="fas fa-star" data-rating="1" style="cursor: pointer; color: #d1d5db; transition: all 0.2s;" onmouseover="highlightStars(1)" onmouseout="resetStars()" onclick="setRating(1)"></i>
                                    <i class="fas fa-star" data-rating="2" style="cursor: pointer; color: #d1d5db; transition: all 0.2s;" onmouseover="highlightStars(2)" onmouseout="resetStars()" onclick="setRating(2)"></i>
                                    <i class="fas fa-star" data-rating="3" style="cursor: pointer; color: #d1d5db; transition: all 0.2s;" onmouseover="highlightStars(3)" onmouseout="resetStars()" onclick="setRating(3)"></i>
                                    <i class="fas fa-star" data-rating="4" style="cursor: pointer; color: #d1d5db; transition: all 0.2s;" onmouseover="highlightStars(4)" onmouseout="resetStars()" onclick="setRating(4)"></i>
                                    <i class="fas fa-star" data-rating="5" style="cursor: pointer; color: #d1d5db; transition: all 0.2s;" onmouseover="highlightStars(5)" onmouseout="resetStars()" onclick="setRating(5)"></i>
                                </div>
                                <input type="hidden" id="feedbackRating" required>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label for="feedbackMsg" style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600;">Your Feedback *</label>
                                <textarea id="feedbackMsg" rows="5" required placeholder="Share your experience with this complaint resolution..." style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                            </div>
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" onclick="closeFeedbackModal()" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Cancel
                                </button>
                                <button type="submit" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #1f2937; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-paper-plane"></i> Submit Feedback
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', `<div id="feedbackModal">${modalHTML}</div>`);
            document.body.style.overflow = 'hidden';
            
            // Handle form submission
            document.getElementById('addFeedbackForm').onsubmit = async (e) => {
                e.preventDefault();
                const rating = parseInt(document.getElementById('feedbackRating').value);
                const message = document.getElementById('feedbackMsg').value.trim();
                
                if (!rating) {
                    alert('Please select a rating');
                    return;
                }
                if (message.length < 1) {
                    alert('Please enter a feedback message');
                    return;
                }
                
                await submitComplaintFeedback(complaintId, rating, message);
            };
        }
        
        // Open modal to edit existing feedback
        function openEditFeedbackModal(complaintId, currentRating, currentMessage) {
            const modalHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;" id="feedbackModalOverlay" onclick="closeFeedbackModal()">
                    <div style="background: white; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        <div style="padding: 24px; border-bottom: 2px solid #e5e7eb; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 16px 16px 0 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h2 style="color: white; margin: 0; font-size: 1.5rem;"><i class="fas fa-edit"></i> Edit Feedback</h2>
                                <button onclick="closeFeedbackModal()" style="background: rgba(255,255,255,0.2); border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; color: white; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <form id="editFeedbackForm" style="padding: 24px;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600;">Rating *</label>
                                <div id="starRating" style="display: flex; gap: 10px; font-size: 2.5rem; justify-content: center; margin: 10px 0;">
                                    <i class="fas fa-star" data-rating="1" style="cursor: pointer; color: ${currentRating >= 1 ? '#FFD700' : '#d1d5db'}; transition: all 0.2s;" onmouseover="highlightStars(1)" onmouseout="resetStars()" onclick="setRating(1)"></i>
                                    <i class="fas fa-star" data-rating="2" style="cursor: pointer; color: ${currentRating >= 2 ? '#FFD700' : '#d1d5db'}; transition: all 0.2s;" onmouseover="highlightStars(2)" onmouseout="resetStars()" onclick="setRating(2)"></i>
                                    <i class="fas fa-star" data-rating="3" style="cursor: pointer; color: ${currentRating >= 3 ? '#FFD700' : '#d1d5db'}; transition: all 0.2s;" onmouseover="highlightStars(3)" onmouseout="resetStars()" onclick="setRating(3)"></i>
                                    <i class="fas fa-star" data-rating="4" style="cursor: pointer; color: ${currentRating >= 4 ? '#FFD700' : '#d1d5db'}; transition: all 0.2s;" onmouseover="highlightStars(4)" onmouseout="resetStars()" onclick="setRating(4)"></i>
                                    <i class="fas fa-star" data-rating="5" style="cursor: pointer; color: ${currentRating >= 5 ? '#FFD700' : '#d1d5db'}; transition: all 0.2s;" onmouseover="highlightStars(5)" onmouseout="resetStars()" onclick="setRating(5)"></i>
                                </div>
                                <input type="hidden" id="feedbackRating" value="${currentRating}" required>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label for="feedbackMsg" style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600;">Your Feedback *</label>
                                <textarea id="feedbackMsg" rows="5" required placeholder="Share your experience..." style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem; resize: vertical;">${currentMessage}</textarea>
                            </div>
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" onclick="closeFeedbackModal()" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Cancel
                                </button>
                                <button type="submit" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-save"></i> Update Feedback
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', `<div id="feedbackModal">${modalHTML}</div>`);
            document.body.style.overflow = 'hidden';
            
            // Handle form submission
            document.getElementById('editFeedbackForm').onsubmit = async (e) => {
                e.preventDefault();
                const rating = parseInt(document.getElementById('feedbackRating').value);
                const message = document.getElementById('feedbackMsg').value.trim();
                
                if (!rating) {
                    alert('Please select a rating');
                    return;
                }
                if (message.length < 1) {
                    alert('Please enter a feedback message');
                    return;
                }
                
                await updateComplaintFeedback(complaintId, rating, message);
            };
        }
        
        // Star rating UI handlers
        let selectedRating = 0;
        
        function highlightStars(rating) {
            const stars = document.querySelectorAll('#starRating .fa-star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.style.color = '#FFD700';
                } else {
                    star.style.color = '#d1d5db';
                }
            });
        }
        
        function resetStars() {
            const currentRating = selectedRating || parseInt(document.getElementById('feedbackRating')?.value || 0);
            highlightStars(currentRating);
        }
        
        function setRating(rating) {
            selectedRating = rating;
            document.getElementById('feedbackRating').value = rating;
            highlightStars(rating);
        }
        
        // Close feedback modal
        function closeFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        }
        
        // Submit new feedback
        async function submitComplaintFeedback(complaintId, rating, message) {
            try {
                const response = await apiRequest(`/api/complaints/${complaintId}/feedback`, 'POST', {
                    rating: rating,
                    message: message
                });
                
                if (response.ok) {
                    showMessage('Feedback submitted successfully and sent to Head Admin!', 'success');
                    closeFeedbackModal();
                    loadComplaintFeedback(complaintId);
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to submit feedback', 'error');
                }
            } catch (error) {
                showMessage('Connection error. Please try again.', 'error');
            }
        }
        
        // Update existing feedback
        async function updateComplaintFeedback(complaintId, rating, message) {
            try {
                const response = await apiRequest(`/api/complaints/${complaintId}/feedback`, 'PUT', {
                    rating: rating,
                    message: message
                });
                
                if (response.ok) {
                    showMessage('Feedback updated successfully and sent to Head Admin!', 'success');
                    closeFeedbackModal();
                    loadComplaintFeedback(complaintId);
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to update feedback', 'error');
                }
            } catch (error) {
                showMessage('Connection error. Please try again.', 'error');
            }
        }
        
        // Delete feedback
        async function deleteComplaintFeedback(complaintId) {
            showConfirmModal(
                'Delete Feedback',
                'Are you sure you want to delete this feedback? You can submit new feedback after deletion.',
                async () => {
                    try {
                        const response = await apiRequest(`/api/complaints/${complaintId}/feedback`, 'DELETE');
                        
                        if (response.ok) {
                            showMessage('Feedback deleted successfully. You can now submit new feedback.', 'success');
                            loadComplaintFeedback(complaintId);
                        } else {
                            const error = await response.json();
                            showMessage(error.error || 'Failed to delete feedback', 'error');
                        }
                    } catch (error) {
                        showMessage('Connection error. Please try again.', 'error');
                    }
                }
            );
        }
        
        // Make feedback functions globally accessible
        window.loadComplaintFeedback = loadComplaintFeedback;
        window.openAddFeedbackModal = openAddFeedbackModal;
        window.openEditFeedbackModal = openEditFeedbackModal;
        window.deleteComplaintFeedback = deleteComplaintFeedback;
        window.closeFeedbackModal = closeFeedbackModal;
        window.highlightStars = highlightStars;
        window.resetStars = resetStars;
        window.setRating = setRating;

        // Multiple delete functionality
        let selectionModeActive = false;

        function toggleSelectionMode() {
            selectionModeActive = !selectionModeActive;
            const checkboxColumns = document.querySelectorAll('.checkbox-column');
            const toggleBtn = document.getElementById('toggleSelectionBtn');
            const cancelBtn = document.getElementById('cancelSelectionBtn');
            
            if (selectionModeActive) {
                checkboxColumns.forEach(col => col.style.display = '');
                toggleBtn.innerHTML = '<i class="fas fa-check-square"></i> Selection Mode Active';
                toggleBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                cancelBtn.style.display = 'block';
            } else {
                checkboxColumns.forEach(col => col.style.display = 'none');
                toggleBtn.innerHTML = '<i class="fas fa-check-square"></i> Select Items';
                toggleBtn.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                cancelBtn.style.display = 'none';
                // Uncheck all
                document.querySelectorAll('.complaint-checkbox').forEach(cb => cb.checked = false);
                document.getElementById('selectAll').checked = false;
                updateDeleteButton();
            }
        }

        function cancelSelectionMode() {
            selectionModeActive = false;
            toggleSelectionMode();
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.complaint-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const checkboxes = document.querySelectorAll('.complaint-checkbox:checked');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');
            
            if (checkboxes.length > 0) {
                deleteBtn.style.display = 'block';
                countSpan.textContent = checkboxes.length;
            } else {
                deleteBtn.style.display = 'none';
            }
        }

        async function deleteSelectedComplaints() {
            const checkboxes = document.querySelectorAll('.complaint-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
            
            if (ids.length === 0) return;
            
            showConfirmModal(
                'Delete Multiple Complaints',
                `Are you sure you want to delete ${ids.length} complaint${ids.length > 1 ? 's' : ''}? This action cannot be undone.`,
                async () => {
                    let successCount = 0;
                    let failCount = 0;
                    
                    for (const id of ids) {
                        try {
                            const response = await apiRequest(`/api/my/complaints/${id}`, 'DELETE');
                            if (response.ok) {
                                successCount++;
                            } else {
                                failCount++;
                            }
                        } catch (error) {
                            failCount++;
                        }
                    }
                    
                    if (successCount > 0) {
                        showMessage(`Successfully deleted ${successCount} complaint${successCount > 1 ? 's' : ''}`, 'success');
                    }
                    if (failCount > 0) {
                        showMessage(`Failed to delete ${failCount} complaint${failCount > 1 ? 's' : ''}`, 'error');
                    }
                    
                    loadComplaintsTable();
                    loadStatistics();
                }
            );
        }

        window.toggleSelectAll = toggleSelectAll;
        window.updateDeleteButton = updateDeleteButton;
        window.deleteSelectedComplaints = deleteSelectedComplaints;
        window.toggleSelectionMode = toggleSelectionMode;
        window.cancelSelectionMode = cancelSelectionMode;

        // ==================== FEEDBACK FUNCTIONALITY ====================
        
        // selectedRating already declared above, reusing it
        
        // Rating star functionality
        document.querySelectorAll('.rating-star').forEach(star => {
            star.addEventListener('click', function() {
                selectedRating = parseInt(this.getAttribute('data-rating'));
                document.getElementById('ratingValue').value = selectedRating;
                
                // Update star colors
                document.querySelectorAll('.rating-star').forEach((s, index) => {
                    if (index < selectedRating) {
                        s.style.color = '#f59e0b'; // Gold color
                    } else {
                        s.style.color = '#d1d5db'; // Gray color
                    }
                });
            });
            
            // Hover effect
            star.addEventListener('mouseenter', function() {
                const hoverRating = parseInt(this.getAttribute('data-rating'));
                document.querySelectorAll('.rating-star').forEach((s, index) => {
                    if (index < hoverRating) {
                        s.style.color = '#fbbf24';
                    } else if (index >= selectedRating) {
                        s.style.color = '#d1d5db';
                    }
                });
            });
            
            star.addEventListener('mouseleave', function() {
                document.querySelectorAll('.rating-star').forEach((s, index) => {
                    if (index < selectedRating) {
                        s.style.color = '#f59e0b';
                    } else {
                        s.style.color = '#d1d5db';
                    }
                });
            });
        });
        
        // Submit feedback
        document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (selectedRating === 0) {
                showMessage('Please select a rating', 'error');
                return;
            }
            
            const message = document.getElementById('feedbackMessageText').value.trim();
            
            if (message.length < 1) {
                showMessage('Please enter a feedback message', 'error');
                return;
            }
            
            const submitBtn = e.target.querySelector('.submit-btn');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            submitBtn.disabled = true;
            
            try {
                const feedbackData = {
                    rating: selectedRating,
                    message: message
                };
                
                const response = await apiRequest('/api/feedback', 'POST', feedbackData);
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Show success - multiple submissions allowed
                    showMessage(' Feedback Submitted! You can submit more feedback anytime.', 'success');
                    
                    // Reset form
                    document.getElementById('feedbackForm').reset();
                    selectedRating = 0;
                    document.querySelectorAll('.rating-star').forEach(s => {
                        s.style.color = '#d1d5db';
                    });
                    
                    // Show submitted badge temporarily on submit button
                    submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submitted!';
                    submitBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    
                    // Reset button after 2 seconds
                    setTimeout(() => {
                        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Feedback';
                        submitBtn.style.background = '';
                    }, 2000);
                    
                    // Reload feedback history to show new submission
                    loadFeedbackHistory();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to submit feedback', 'error');
                }
            } catch (error) {
                showMessage('Connection error. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
            }
        });
        
        // Load feedback history
        async function loadFeedbackHistory() {
            const container = document.getElementById('feedbackHistoryContainer');
            container.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #4c1d95;"></i></div>';
            
            try {
                const response = await apiRequest('/api/my/feedback');
                
                if (response.ok) {
                    const data = await response.json();
                    const feedbackList = data.feedback || data || [];
                    
                    if (feedbackList.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #6b7280;">
                                <i class="fas fa-comment-slash" style="font-size: 3rem; opacity: 0.3; margin-bottom: 15px;"></i>
                                <h3 style="margin-bottom: 8px;">No Feedback Yet</h3>
                                <p>You haven't submitted any feedback to Head Admin</p>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = feedbackList.map(fb => {
                        const statusColors = {
                            pending: { bg: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)', border: '#f59e0b', badge: '#92400e', badgeBg: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)', text: 'white' },
                            reviewed: { bg: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)', border: '#10b981', badge: '#065f46', badgeBg: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', text: 'white' },
                            responded: { bg: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)', border: '#3b82f6', badge: '#1e40af', badgeBg: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', text: 'white' },
                            archived: { bg: 'linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%)', border: '#6b7280', badge: '#1f2937', badgeBg: 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)', text: 'white' }
                        };
                        const colors = statusColors[fb.status] || statusColors.pending;
                        return `
                        <div style="background: ${colors.bg}; border-radius: 16px; padding: 24px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 0 0 1px ${colors.border}20; border-left: 5px solid ${colors.border}; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.12)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08), 0 0 0 1px ${colors.border}20'">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 0.75rem; color: #6b7280; font-weight: 600; margin-bottom: 6px;">Feedback #${fb.id}</div>
                                    <div style="font-size: 1.3rem; margin-bottom: 6px;">
                                        ${Array(fb.rating).fill('<i class="fas fa-star" style="color: #f59e0b; filter: drop-shadow(0 2px 4px rgba(245, 158, 11, 0.3));"></i>').join('')}
                                        ${Array(5 - fb.rating).fill('<i class="far fa-star" style="color: #d1d5db;"></i>').join('')}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #374151; font-weight: 500;">
                                        <i class="fas fa-clock" style="margin-right: 4px;"></i>
                                        ${new Date(fb.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                </div>
                                <button onclick="deleteFeedback(${fb.id})" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.3)'">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                            </div>
                            <p style="color: #1f2937; line-height: 1.7; margin: 0; font-size: 0.95rem; font-weight: 500;">${fb.message}</p>
                            ${fb.reviewed_at ? `<div style="margin-top: 12px; padding-top: 12px; border-top: 2px dashed ${colors.border}40; font-size: 0.85rem; color: #059669; font-weight: 600;"><i class="fas fa-check-circle" style="margin-right: 4px;"></i> Reviewed on ${new Date(fb.reviewed_at).toLocaleDateString()}</div>` : ''}
                        </div>
                    `}).join('');
                } else {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">Failed to load feedback history</div>';
                }
            } catch (error) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">Connection error</div>';
            }
        }

        // Delete feedback function - allows users to resubmit
        async function deleteFeedback(feedbackId) {
            if (!confirm('Delete this feedback? You can submit new feedback after deletion.')) {
                return;
            }
            
            try {
                const response = await apiRequest(`/api/my/feedback/${feedbackId}`, 'DELETE');
                
                if (response.ok) {
                    showMessage(' Feedback deleted! You can now submit new feedback.', 'success');
                    loadFeedbackHistory();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to delete feedback', 'error');
                }
            } catch (error) {
                showMessage('Connection error. Please try again.', 'error');
            }
        }

        // Expose deleteFeedback globally
        window.deleteFeedback = deleteFeedback;

        // Show message

        // General message for complaints
        function showMessage(text, type) {
            const activePage = document.querySelector('.page.active');
            let messageDiv = null;
            if (activePage && activePage.id === 'feedbackPage') {
                messageDiv = document.getElementById('feedbackMessage');
            } else {
                messageDiv = document.getElementById('complaintMessage');
            }
            if (messageDiv) {
                messageDiv.innerHTML = `
                    <div class="message ${type}">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                        ${text}
                    </div>
                `;
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 5000);
            }
        }

        // Dedicated feedback message (can be used for feedback page only)
        function showFeedbackMessage(text, type) {
            const messageDiv = document.getElementById('feedbackMessage');
            if (messageDiv) {
                messageDiv.innerHTML = `
                    <div class="message ${type}">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                        ${text}
                    </div>
                `;
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 5000);
            }
        }

        // Toast notification function for profile actions
        function showToast(message, type = 'info') {
            // Remove existing toast if any
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            
            let icon = 'info-circle';
            let bgColor = '#2196F3';
            if (type === 'success') { icon = 'check-circle'; bgColor = '#4CAF50'; }
            else if (type === 'error') { icon = 'exclamation-circle'; bgColor = '#f44336'; }
            else if (type === 'warning') { icon = 'exclamation-triangle'; bgColor = '#ff9800'; }
            
            toast.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 14px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 100000;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 500;
                animation: slideIn 0.3s ease;
                max-width: 350px;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Media Modal Functions
        async function openAuthenticatedMediaModal(filePath, type, filename) {
            const modal = document.getElementById('mediaModal');
            const modalContent = document.getElementById('mediaModalContent');
            const modalTitle = document.getElementById('mediaModalTitle');
            
            // Get the API base URL
            const apiBase = window.API_BASE || 'http://127.0.0.1:5000';
            
            modalTitle.textContent = filename;
            modalContent.innerHTML = '<div style="color: white; text-align: center;"><i class="fas fa-spinner fa-spin" style="font-size: 3rem;"></i><p style="margin-top: 20px;">Loading media...</p></div>';
            
            // Ensure modal is on top of everything including complaint detail popup
            modal.style.zIndex = '99999';
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            try {
                // Extract just the filename from the path
                const fileName = filePath.split('/').pop();
                console.log('[Media] Loading file:', fileName, 'type:', type);
                
                // Try fetching with full API_BASE URL
                let response = await fetch(`${apiBase}/api/uploads/${fileName}`);
                console.log('[Media] Response status:', response.status);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    console.log('[Media] Blob URL created:', url, 'size:', blob.size);
                    
                    if (type === 'image') {
                        modalContent.innerHTML = `<img src="${url}" style="max-width: 100%; max-height: 80vh; border-radius: 8px;" alt="${filename}">`;
                    } else if (type === 'video') {
                        modalContent.innerHTML = `<video src="${url}" controls autoplay style="max-width: 100%; max-height: 80vh; border-radius: 8px;"></video>`;
                    } else if (type === 'document') {
                        // For PDF files, create an embed or iframe
                        modalContent.innerHTML = `
                            <div style="width: 90vw; max-width: 1200px; height: 85vh; background: white; border-radius: 12px; overflow: hidden;">
                                <embed src="${url}" type="application/pdf" width="100%" height="100%" style="border: none;">
                            </div>
                        `;
                    } else {
                        // Fallback - try to display as document
                        modalContent.innerHTML = `
                            <div style="width: 90vw; max-width: 1200px; height: 85vh; background: white; border-radius: 12px; overflow: hidden;">
                                <embed src="${url}" width="100%" height="100%" style="border: none;">
                            </div>
                        `;
                    }
                } else {
                    console.error('[Media] Failed to load, status:', response.status);
                    modalContent.innerHTML = '<div style="color: white; text-align: center;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem;"></i><p style="margin-top: 20px;">Failed to load media (HTTP ' + response.status + ')</p></div>';
                }
            } catch (error) {
                console.error('[Media] Error loading media:', error);
                modalContent.innerHTML = '<div style="color: white; text-align: center;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem;"></i><p style="margin-top: 20px;">Error loading media: ' + error.message + '</p></div>';
            }
        }
        window.openAuthenticatedMediaModal = openAuthenticatedMediaModal;
        
        function openMediaModal(src, type, filename) {
            openAuthenticatedMediaModal(src.replace('/api/media/', ''), type, filename);
        }
        
        function closeMediaModal() {
            const modal = document.getElementById('mediaModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('mediaModalContent').innerHTML = '';
        }
        
        window.openMediaModal = openMediaModal;
        window.closeMediaModal = closeMediaModal;

        // Initialize
        loadUserInfo();
        loadDistrictHints();
        loadStatistics();
        
        // Enable real-time updates
        if (typeof window.registerRealtimeUpdate === 'function') {
            // Auto-refresh complaints every 5 seconds
            window.registerRealtimeUpdate('user-complaints', async () => {
                const complaintsPage = document.getElementById('complaintsPage');
                if (complaintsPage && complaintsPage.classList.contains('active')) {
                    await loadComplaintsTable();
                    console.log('[User] Auto-refreshed complaints');
                }
            }, 5000);
            
            // Auto-refresh statistics every 10 seconds
            window.registerRealtimeUpdate('user-stats', async () => {
                await loadStatistics();
                
                // Setup auto-refresh every 30 seconds for real-time updates
                setInterval(async function() {
                    console.log('[AUTO-REFRESH] Updating user dashboard...');
                    await loadStatistics();
                    // Refresh current page if on complaints history
                    const currentSection = document.querySelector('.content-section.active');
                    if (currentSection && currentSection.id === 'complaints-history') {
                        await loadComplaintsTable();
                    }
                }, 30000); // 30 seconds
                console.log('[User] Auto-refreshed statistics');
            }, 10000);
            
            console.log('[User] Real-time updates enabled');
        }
    </script>

    <!-- Media Modal - z-index 99999 to ensure it's always on top -->
    <div id="mediaModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 99999; align-items: center; justify-content: center; flex-direction: column; padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 1200px; margin-bottom: 20px;">
            <h3 id="mediaModalTitle" style="color: white; font-size: 1.1rem; font-weight: 600;"></h3>
            <button onclick="closeMediaModal()" style="background: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: #333; transition: all 0.3s;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="mediaModalContent" style="max-width: 95%; max-height: 90%; display: flex; align-items: center; justify-content: center;"></div>
    </div>

    <!-- Notification Dropdowns -->
    <div class="notification-dropdown" id="notificationsDropdown">
        <div class="dropdown-header">
            <h3><i class="fas fa-bell"></i> Notifications</h3>
        </div>
        <div class="dropdown-content" id="notificationsContent">
            <div class="dropdown-empty">
                <i class="fas fa-bell-slash"></i>
                <p>No notifications yet</p>
            </div>
        </div>
    </div>

    <div class="notification-dropdown" id="complaintsDropdown">
        <div class="dropdown-header">
            <h3><i class="fas fa-file-alt"></i> Recent Complaints</h3>
        </div>
        <div class="dropdown-content" id="complaintsContent">
            <div class="dropdown-empty">
                <i class="fas fa-inbox"></i>
                <p>No complaints yet</p>
            </div>
        </div>
    </div>

    <div class="notification-dropdown" id="messagesDropdown">
        <div class="dropdown-header">
            <h3><i class="fas fa-envelope"></i> Messages</h3>
        </div>
        <div class="dropdown-content" id="messagesContent">
            <div class="dropdown-empty">
                <i class="fas fa-envelope-open"></i>
                <p>No messages yet</p>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <i class="fas fa-exclamation-triangle"></i>
                <h3 id="confirmModalTitle">Confirm Action</h3>
            </div>
            <div class="confirm-modal-body">
                <p id="confirmModalMessage">Are you sure you want to proceed?</p>
            </div>
            <div class="confirm-modal-actions">
                <button class="confirm-modal-btn cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="confirm-modal-btn confirm" id="confirmModalBtn">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Theme Toggle Functionality
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        const themeIcon = themeToggle.querySelector('i');

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
            themeIcon.classList.remove('fa-moon');
            themeIcon.classList.add('fa-sun');
        }

        // Toggle theme
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            
            if (body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                localStorage.setItem('theme', 'light');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        });

        // Notification Bar Functionality
        class NotificationBar {
            constructor() {
                this.activeDropdown = null;
                this.updateInterval = null;
                this.notifications = [];
                this.init();
            }

            init() {
                // Setup click handlers for notification items
                document.querySelectorAll('.notification-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const type = item.dataset.type;
                        this.toggleDropdown(type);
                        this.markAsRead();
                    });
                });

                // Close dropdowns when clicking outside
                document.addEventListener('click', () => {
                    this.closeAllDropdowns();
                });

                // Prevent dropdown from closing when clicking inside
                document.querySelectorAll('.notification-dropdown').forEach(dropdown => {
                    dropdown.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                });

                // Start live updates every 3 seconds
                this.updateCounts();
                this.updateInterval = setInterval(() => this.updateCounts(), 3000);
            }

            toggleDropdown(type) {
                const dropdown = document.getElementById(`${type}Dropdown`);
                
                if (this.activeDropdown === type) {
                    this.closeAllDropdowns();
                    return;
                }

                this.closeAllDropdowns();
                dropdown.classList.add('active');
                this.activeDropdown = type;
                this.loadDropdownContent(type);
                
                // Mark notifications as read and update count immediately
                if (type === 'notifications') {
                    this.markAsRead();
                }
            }

            closeAllDropdowns() {
                document.querySelectorAll('.notification-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
                this.activeDropdown = null;
            }

            markAsRead() {
                // Mark notifications as read via API
                const token = localStorage.getItem('token');
                this.notifications.forEach(async (notif) => {
                    try {
                        await fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/user/notifications/${notif.id}/read`, {
                            method: 'PUT',
                            headers: { 'Authorization': 'Bearer ' + token }
                        });
                    } catch (e) {
                        console.error('Error marking notification as read:', e);
                    }
                });
                
                // Reset badge to 0
                this.updateBadge('notificationBadge', 0);
                this.notifications = [];
            }

            async updateCounts() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) return;

                    // Fetch unread notifications from backend
                    const response = await fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/user/notifications?include_read=false`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.notifications = data.notifications || [];
                        const totalCount = this.notifications.length;
                        
                        // Update badge
                        this.updateBadge('notificationBadge', totalCount);
                    } else {
                        console.error('Failed to fetch notifications');
                    }

                } catch (error) {
                    console.error('Error updating notification counts:', error);
                }
            }

            updateBadge(badgeId, count) {
                const badge = document.getElementById(badgeId);
                if (!badge) return;

                badge.textContent = count > 99 ? '99+' : count;
                
                if (count > 0) {
                    badge.style.display = 'flex';
                    if (badgeId === 'notificationBadge') {
                        badge.classList.add('pulse');
                    }
                } else {
                    badge.style.display = 'none';
                    badge.classList.remove('pulse');
                }
            }

            async loadDropdownContent(type) {
                const content = document.getElementById(`${type}Content`);
                const token = localStorage.getItem('token');

                if (type === 'notifications') {
                    if (this.notifications.length === 0) {
                        content.innerHTML = '<div class="dropdown-empty"><i class="fas fa-bell-slash"></i><p>No new notifications</p></div>';
                    } else {
                        content.innerHTML = this.notifications.map(notif => {
                            let icon = 'fa-bell';
                            let color = '#FFFFFF';
                            let title = notif.message;
                            
                            if (notif.type === 'reply') {
                                icon = 'fa-comment';
                                color = '#10b981';
                            } else if (notif.type === 'status_resolved') {
                                icon = 'fa-check-circle';
                                color = '#22c55e';
                            } else if (notif.type === 'feedback') {
                                icon = 'fa-star';
                                color = '#f59e0b';
                            } else if (notif.type === 'message') {
                                icon = 'fa-envelope';
                                color = '#3b82f6';
                            }
                            
                            return `
                                <div class="dropdown-item">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <i class="fas ${icon}" style="color: ${color}; font-size: 20px;"></i>
                                        <div style="flex: 1;">
                                            <div class="dropdown-item-title">${title}</div>
                                            <div class="dropdown-item-subtitle">${new Date(notif.created_at).toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                } else if (type === 'complaints') {
                    try {
                        const response = await fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/user/complaints`, {
                            headers: { 'Authorization': 'Bearer ' + token }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const complaints = data.complaints || [];
                            
                            if (complaints.length === 0) {
                                content.innerHTML = '<div class="dropdown-empty"><i class="fas fa-inbox"></i><p>No complaints yet</p></div>';
                            } else {
                                content.innerHTML = complaints.slice(0, 5).map(complaint => `
                                    <div class="dropdown-item" onclick="showPage('complaints')">
                                        <div class="dropdown-item-title">#${complaint.id} - ${complaint.category}</div>
                                        <div class="dropdown-item-subtitle">
                                            <span class="status-badge status-${complaint.status}">${complaint.status}</span>
                                            ${new Date(complaint.created_at).toLocaleDateString()}
                                        </div>
                                    </div>
                                `).join('');
                            }
                        }
                    } catch (error) {
                        content.innerHTML = '<div class="dropdown-empty"><i class="fas fa-exclamation-triangle"></i><p>Error loading complaints</p></div>';
                    }
                } else if (type === 'notifications') {
                    content.innerHTML = `
                        <div class="dropdown-item">
                            <div class="dropdown-item-title">Welcome to Servonix!</div>
                            <div class="dropdown-item-subtitle">Your account is active</div>
                        </div>
                    `;
                } else if (type === 'messages') {
                    content.innerHTML = '<div class="dropdown-empty"><i class="fas fa-envelope-open"></i><p>No messages yet</p></div>';
                }
            }

            destroy() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                }
            }
        }

        // Initialize notification bar
        const notificationBar = new NotificationBar();
    </script>
</body>
</html>
