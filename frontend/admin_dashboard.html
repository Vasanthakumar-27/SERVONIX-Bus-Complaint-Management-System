<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
        <link rel="icon" type="image/png" href="assets/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/dashboard-loader.css">
    <style>
        :root {
            /* Purple/Cyan Light Theme (Default) */
            --bg-900: #120038;
            --bg-800: #1a0a4a;
            --bg-700: #2a1a60;
            --card-bg: rgba(18, 0, 56, 0.94);
            --border: rgba(42, 26, 96, 0.6);
            --primary: #00FFFF;
            --primary-soft: rgba(0, 255, 255, 0.15);
            --gold: #FFD700;
            --gold-soft: rgba(255, 215, 0, 0.15);
            --green: #16c782;
            --red: #ef5b5b;
            --blue: #1976D2;
            --text-100: #FFFFFF;
            --text-200: #C0C0C0;
            --text-400: #A0AEC0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --radius-lg: 18px;
            --radius-md: 12px;
            --transition: all 0.25s ease;
        }

        body.dark-mode {
            /* Custom Black/Gold/Silver Dark Theme */
            --bg-900: #000000;
            --bg-800: #000000;
            --bg-700: #000000;
            --card-bg: #000000;
            --border: #FFD100;
            --primary: #FFD100;
            --primary-soft: #FFD100;
            --gold: #FFD100;
            --gold-soft: #FFD100;
            --text-100: #C0C0C0;
            --text-200: #C0C0C0;
            --text-400: #C0C0C0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #120038 0%, #1a0a4a 100%);
            min-height: 100vh;
            color: var(--text-100);
            transition: all 0.3s ease;
        }

        body.light-mode {
            background: linear-gradient(135deg, #120038 0%, #1a0a4a 100%);
        }

        body.dark-mode {
            background: #000000 !important;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px; /* Add gap for theme toggle button */
        }

        /* Header */
        .header {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 25px 35px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        body.dark-mode .header {
            background: transparent;
            border: 2px solid #FFD100;
        }

        body.light-mode .header {
            background: var(--card-bg);
            border: 2px solid #00FFFF;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: transparent;
            border-radius: var(--radius-md);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 100px;
            height: 100px;
            background: transparent;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            padding: 0;
        }

        .header-info h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-100);
            margin-bottom: 5px;
        }

        .header-info p {
            color: var(--text-400);
            font-size: 0.9rem;
        }

        body.dark-mode .header-info h1 {
            color: #C0C0C0;
        }

        body.light-mode .header-info h1 {
            color: #FFFFFF;
        }

        body.light-mode .header-info p {
            color: #C0C0C0;
        }

        body.light-mode .header-top {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            justify-content: flex-end;
            flex: 1;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #120038, #1a0a4a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            border: 2px solid #2a1a60;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .user-avatar:hover {
            transform: scale(1.05);
            border-color: var(--primary);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Profile Dropdown Styles */
        .profile-dropdown-container {
            position: relative;
        }

        .profile-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 300px;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .profile-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        body.dark-mode .profile-dropdown {
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .profile-dropdown-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        body.dark-mode .profile-dropdown-header {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-size: 32px;
            font-weight: 700;
            margin: 0 auto 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .profile-avatar-large:hover {
            transform: scale(1.05);
        }

        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            font-size: 10px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .profile-avatar-large:hover .upload-overlay {
            opacity: 1;
        }

        .profile-name {
            font-weight: 600;
            font-size: 18px;
            color: #1F2937;
            margin-bottom: 4px;
        }

        body.dark-mode .profile-name {
            color: #fff;
        }

        .profile-email {
            color: #6B7280;
            font-size: 13px;
        }

        body.dark-mode .profile-email {
            color: #9CA3AF;
        }

        .profile-role-badge {
            display: inline-block;
            background: linear-gradient(135deg, #00FFFF, #00CED1);
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
            text-transform: uppercase;
        }

        .profile-dropdown-menu {
            padding: 10px 0;
        }

        .profile-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #374151;
            font-size: 14px;
        }

        body.dark-mode .profile-menu-item {
            color: #D1D5DB;
        }

        .profile-menu-item:hover {
            background: rgba(0,255,255,0.1);
        }

        body.dark-mode .profile-menu-item:hover {
            background: rgba(255,209,0,0.1);
        }

        .profile-menu-item i {
            width: 20px;
            text-align: center;
            color: #6B7280;
        }

        body.dark-mode .profile-menu-item i {
            color: #9CA3AF;
        }

        .profile-menu-item.danger {
            color: #EF4444;
        }

        .profile-menu-item.danger i {
            color: #EF4444;
        }

        .profile-info-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: #6B7280;
            font-size: 13px;
        }

        body.dark-mode .profile-info-item {
            color: #9CA3AF;
        }

        .profile-info-item i {
            width: 20px;
            text-align: center;
        }

        /* Modal Overlay for Password Change */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: #ffffff;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: slideDown 0.3s ease;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.1);
            color: #1a1a2e;
        }

        body.dark-mode .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            color: #fff;
            border: 1px solid rgba(0, 200, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 200, 255, 0.15);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        body.dark-mode .modal-header {
            background: linear-gradient(135deg, rgba(0, 200, 255, 0.1), rgba(0, 150, 255, 0.05));
            border-bottom: 1px solid rgba(0, 200, 255, 0.2);
        }

        .modal-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #1a1a2e;
        }

        body.dark-mode .modal-header h3 {
            color: #00C8FF;
        }

        .modal-body {
            padding: 25px;
            background: #ffffff;
        }

        body.dark-mode .modal-body {
            background: transparent;
        }

        .modal-body input,
        .modal-body textarea,
        .modal-body select {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #1a1a2e;
            border-radius: 8px;
            padding: 10px 12px;
        }

        body.dark-mode .modal-body input,
        body.dark-mode .modal-body textarea,
        body.dark-mode .modal-body select {
            background: rgba(45, 45, 68, 0.8);
            border: 1px solid rgba(0, 200, 255, 0.3);
            color: #fff;
        }

        .modal-body label {
            color: #495057;
            font-weight: 500;
        }

        body.dark-mode .modal-body label {
            color: #C0C0C0;
        }

        .modal-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        body.dark-mode .modal-footer {
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(0, 200, 255, 0.2);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: inherit;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .close-btn:hover {
            opacity: 1;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Search and Filter Bar */
        .controls-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(var(--bg-800), 0.5);
            color: var(--text-100);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 0.25rem;
            border-radius: 6px;
        }

        .filter-select {
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background: rgba(var(--bg-800), 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-100);
        }
        
        .filter-select option {
            background: #1a0a4a;
            color: #ffffff;
            padding: 10px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .refresh-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-messages {
            background: var(--primary);
            color: var(--bg-900);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            position: relative;
        }

        .btn-messages:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.3);
        }

        body.dark-mode .btn-messages {
            background: #FFD100;
            color: #000000;
        }

        body.dark-mode .btn-messages:hover {
            box-shadow: 0 4px 12px rgba(255, 209, 0, 0.3);
        }

        .message-badge {
            background: #ef5b5b;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }

        /* Messages Section Styles */
        .messages-container {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 30px;
            margin-bottom: 30px;
            display: none;
        }

        body.dark-mode .messages-container {
            background: transparent;
            border: 2px solid #FFD100;
        }

        body.light-mode .messages-container {
            border: 2px solid #00FFFF;
        }

        .messages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .messages-title {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-compose {
            background: var(--primary);
            color: var(--bg-900);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-compose:hover {
            transform: translateY(-2px);
        }

        body.dark-mode .btn-compose {
            background: #FFD100;
            color: #000000;
        }

        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .message-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .message-item.unread {
            border-left-color: var(--primary);
            background: rgba(0, 255, 255, 0.1);
        }

        .message-item.read {
            border-left-color: var(--green);
        }

        .message-item.resolved {
            border-left-color: var(--text-400);
            opacity: 0.7;
        }

        body.dark-mode .message-item {
            background: rgba(255, 209, 0, 0.05);
        }

        body.dark-mode .message-item:hover {
            background: rgba(255, 209, 0, 0.1);
        }

        body.dark-mode .message-item.unread {
            border-left-color: #FFD100;
            background: rgba(255, 209, 0, 0.15);
        }

        .message-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }

        .message-content {
            flex: 1;
        }

        .message-subject {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-100);
        }

        .message-preview {
            color: var(--text-200);
            font-size: 14px;
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .message-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: var(--text-400);
        }

        .message-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
        }

        .message-status.pending {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
        }

        .message-status.read {
            background: rgba(22, 199, 130, 0.2);
            color: #16c782;
        }

        .message-status.resolved {
            background: rgba(160, 174, 192, 0.2);
            color: var(--text-400);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-400);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        /* Stats Cards */
        .stats-section {
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: transparent;
            border-radius: var(--radius-lg);
            padding: 28px;
            text-align: center;
            border: 2px solid
        }

        body.dark-mode .stat-card {
            background: transparent;
            border: 2px solid #FFD100;
        }

        body.light-mode .stat-card {
            background: #1a0a4a;
            border: 2px solid #2a1a60;
        }

        .stat-card.pending { border-left: 5px solid rgba(255, 255, 255, 0.8); }
        .stat-card.in-progress { border-left: 5px solid rgba(255, 255, 255, 0.8); }
        .stat-card.resolved { border-left: 5px solid rgba(255, 255, 255, 0.8); }
        .stat-card.total { border-left: 5px solid rgba(255, 255, 255, 0.8); }
        
        body.dark-mode .stat-card.pending { border-left: none; }
        body.dark-mode .stat-card.in-progress { border-left: none; }
        body.dark-mode .stat-card.resolved { border-left: none; }
        body.dark-mode .stat-card.total { border-left: none; }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: #C0C0C0;
        }
        
        body.dark-mode .stat-number {
            color: #C0C0C0;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #C0C0C0;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        body.dark-mode .stat-label {
            color: #C0C0C0;
        }

        /* Complaints Section */
        .complaints-section {
            background: transparent;
            border-radius: var(--radius-lg);
            padding: 35px;
            border: 2px solid #FFD100;
        }

        .complaints-section .section-header,
        .complaints-section .complaint-table {
            background: transparent;
        }

        /* Table overflow prevention */
        .complaints-section .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid rgba(255, 209, 0, 0.3);
            max-width: 100%;
        }

        .complaints-section .table-wrapper table {
            width: 100%;
            table-layout: auto;
        }

        body.dark-mode .complaints-section {
            background: transparent;
            border: 2px solid #FFD100;
        }

        body.light-mode .complaints-section {
            background: #1a0a4a;
            border: 2px solid #2a1a60;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #00CED1;
        }
        
        body.dark-mode .section-title {
            color: #C0C0C0;
        }

        /* Complaint Item */
        .complaint-item {
            background: #120038;
            border-radius: var(--radius-md);
            padding: 12px 15px;
            margin-bottom: 12px;
            border-left: 4px solid #D5A846;
            position: relative;
        }

        body.dark-mode .complaint-item {
            background: transparent;
            border: 1px solid #FFD100;
            border-left: 4px solid #FFD100;
        }

        body.light-mode .complaint-item {
            background: #2a1a60;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-left: 4px solid rgba(255, 255, 255, 0.8);
        }

        .complaint-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .complaint-id {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.95rem;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .actions-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-btn {
            background: var(--primary-soft);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--primary);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: #FFFFFF;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 200px;
            margin-top: 8px;
            padding: 6px;
            overflow: hidden;
        }

        body.dark-mode .dropdown-menu {
            background: #2a2a2a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        body.light-mode .dropdown-menu {
            background: #FFFFFF;
            border: 1px solid rgba(109, 40, 217, 0.2);
            box-shadow: 0 8px 24px rgba(109, 40, 217, 0.2);
        }

        .dropdown-menu.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #1a1a1a;
            border-radius: 8px;
            transition: all 0.2s ease;
            margin-bottom: 2px;
        }

        .dropdown-item:hover {
            background: rgba(18, 0, 56, 0.1);
            color: white;
        }

        .dropdown-item i {
            color: #FFD700;
            width: 18px;
            font-size: 15px;
            text-align: center;
        }

        body.dark-mode .dropdown-item {
            color: #FFFFFF;
        }

        body.dark-mode .dropdown-item:hover {
            background: rgba(192, 192, 192, 0.12);
            color: #C0C0C0;
        }

        body.dark-mode .dropdown-item i {
            color: #C0C0C0;
        }

        body.light-mode .dropdown-item {
            color: #1a1a1a;
        }

        body.light-mode .dropdown-item:hover {
            background: rgba(18, 0, 56, 0.15);
            color: white;
        }

        body.light-mode .dropdown-item i {
            color: #FFD700;
        }

        .dropdown-item:last-child {
            margin-bottom: 0;
        }

        .complaint-media-collapsed {
            display: none;
        }

        .complaint-media-collapsed.show {
            display: block;
            margin-top: 10px;
            padding: 12px;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(99, 102, 241, 0.2);
            animation: slideDown 0.3s ease;
        }

        .resolution-section {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 215, 0, 0.05);
            border-radius: 8px;
            border-left: 3px solid #FFD700;
        }

        .resolution-section textarea {
            width: 100%;
            padding: 8px;
            border: 1.5px solid #e5e7eb;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.8rem;
            resize: vertical;
        }

        .status-badge.pending { background: #fef3c7; color: #92400e; }
        .status-badge.in_progress { background: #dbeafe; color: #1e40af; }
        .status-badge.resolved { background: #d1fae5; color: #065f46; }

        .complaint-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 8px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
            word-wrap: break-word;
            font-size: 0.8rem;
        }

        .info-item i {
            color: #00CED1;
            min-width: 14px;
            font-size: 0.8rem;
        }
        
        body.dark-mode .info-item i {
            color: #D5A846;
        }

        .info-label {
            font-weight: 600;
            color: #374151;
            min-width: 50px;
            font-size: 0.8rem;
        }

        .info-item i {
            color: #4c1d95;
            min-width: 16px;
        }

        .info-label {
            font-weight: 600;
            color: #374151;
            min-width: 60px;
        }
        
        .info-item span:last-child {
            word-wrap: break-word;
            overflow-wrap: break-word;
            flex: 1;
        }

        /* Scrollbar Styling for Complaints Container */
        #complaintsContainer::-webkit-scrollbar {
            height: 10px;
        }
        
        #complaintsContainer::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }
        
        #complaintsContainer::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.6), rgba(255, 215, 0, 0.9));
            border-radius: 5px;
        }
        
        #complaintsContainer::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.8), rgba(255, 215, 0, 1));
        }
        
        /* Make table scrollable */
        #complaintsContainer table {
            min-width: 1200px;
        }

        .complaint-description {
            background: white;
            padding: 8px 10px;
            border-radius: 6px;
            border-left: 2px solid #D5A846;
            margin-bottom: 8px;
            font-style: italic;
            color: #4b5563;
            font-size: 0.8rem;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            cursor: pointer;
        }

        /* Media Item */
        .media-item {
            cursor: pointer;
        }

        /* Action Controls */
        .action-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }

        .status-selector {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-selector label {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-select {
            padding: 5px 8px;
            border: 1.5px solid #e5e7eb;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-save {
            background: #D5A846;
            color: white;
        }

        .btn-reply {
            background: #3b82f6;
            color: white;
        }

        .btn-view {
            background: #6b7280;
            color: white;
        }

        /* Replies Section */
        .replies-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
            display: none;
        }

        .replies-section.expanded {
            display: block;
        }

        .reply-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 3px solid #10b981;
        }

        .reply-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .reply-sender {
            font-weight: 600;
            color: #374151;
        }

        .reply-time {
            font-size: 0.8rem;
            color: #718096;
        }

        .reply-message {
            color: #4b5563;
            line-height: 1.5;
        }

        /* Quick Reply Form */
        .quick-reply-form {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border: 2px solid #e5e7eb;
        }

        .quick-reply-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            resize: vertical;
            margin-bottom: 10px;
        }

        .send-reply-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        /* Loading and Empty States */
        .loading {
            text-align: center;
            padding: 60px;
            color: #718096;
        }

        .loading i {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #718096;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .controls-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: auto;
            }

            .complaint-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .complaint-info {
                grid-template-columns: 1fr;
            }

            .action-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .container {
                padding: 10px;
            }
        }

        /* Messages */
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        /* Confirm Modal Styles */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10002;
            align-items: center;
            justify-content: center;
        }

        .confirm-modal-content {
            background: #ffffff;
            border-radius: 16px;
            width: 90%;
            max-width: 440px;
            overflow: hidden;
            animation: slideDown 0.3s ease;
            border: 1px solid rgba(0,0,0,0.1);
        }

        body.dark-mode .confirm-modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border: 1px solid rgba(0, 200, 255, 0.3);
        }

        .confirm-modal-header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            padding: 20px 25px;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .confirm-modal-header i {
            font-size: 1.5rem;
        }

        .confirm-modal-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }

        .confirm-modal-body {
            padding: 25px;
            background: #ffffff;
        }

        body.dark-mode .confirm-modal-body {
            background: transparent;
        }

        .confirm-modal-body p {
            color: #4a5568;
            font-size: 1rem;
            line-height: 1.6;
            margin: 0;
        }

        body.dark-mode .confirm-modal-body p {
            color: #C0C0C0;
        }

        .confirm-modal-actions {
            padding: 20px 25px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
        }

        body.dark-mode .confirm-modal-actions {
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(0, 200, 255, 0.2);
        }

        .confirm-modal-btn {
            padding: 10px 24px;
            border-radius: 8px;
            border: none;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
        }

        .confirm-modal-btn.cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        body.dark-mode .confirm-modal-btn.cancel {
            background: rgba(45, 45, 68, 0.8);
            color: #C0C0C0;
        }

        .confirm-modal-btn.confirm {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Assigned Areas Modal - Clean Enterprise Design */
        .assigned-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10003;
            align-items: center;
            justify-content: center;
        }

        .assigned-modal-overlay.active {
            display: flex;
        }

        .assigned-modal {
            background: #ffffff;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }

        body.dark-mode .assigned-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border: 1px solid rgba(0, 200, 255, 0.3);
        }

        .assigned-modal-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding: 24px 30px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark-mode .assigned-modal-header {
            background: linear-gradient(135deg, rgba(0, 200, 255, 0.1), rgba(0, 150, 255, 0.05));
            border-bottom: 1px solid rgba(0, 200, 255, 0.2);
        }

        .assigned-modal-title {
            color: #1a1a2e;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
        }

        body.dark-mode .assigned-modal-title {
            color: #C0C0C0;
        }

        .assigned-modal-title i {
            color: #4f46e5;
        }

        body.dark-mode .assigned-modal-title i {
            color: #00C8FF;
        }

        .assigned-modal-close {
            background: rgba(0,0,0,0.1);
            border: none;
            color: #1a1a2e;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        body.dark-mode .assigned-modal-close {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .assigned-summary {
            padding: 25px 30px;
            background: #f8f9fa;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            margin: 20px 30px 0 30px;
        }

        body.dark-mode .assigned-summary {
            background: rgba(45, 45, 68, 0.5);
            border: 1px solid rgba(0, 200, 255, 0.2);
        }

        .assigned-summary h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #1a1a2e;
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.dark-mode .assigned-summary h3 {
            color: #C0C0C0;
        }

        .assigned-summary p {
            font-size: 0.95rem;
            color: #4a5568;
            margin: 0;
        }

        body.dark-mode .assigned-summary p {
            color: #a0a0a0;
        }

        .assigned-section {
            padding: 25px 30px;
        }

        .assigned-section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        body.dark-mode .assigned-section-title {
            color: #C0C0C0;
            border-bottom: 1px solid rgba(0, 200, 255, 0.2);
        }

        .assigned-section-title i {
            color: #4f46e5;
            font-size: 1.3rem;
        }

        body.dark-mode .assigned-section-title i {
            color: #00C8FF;
        }

        .assigned-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .assigned-item {
            background: #f8f9fa;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        body.dark-mode .assigned-item {
            background: rgba(45, 45, 68, 0.5);
            border: 1px solid rgba(0, 200, 255, 0.2);
        }

        .assigned-item-icon {
            width: 40px;
            height: 40px;
            background: #e9ecef;
            border: 1px solid #4f46e5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4f46e5;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        body.dark-mode .assigned-item-icon {
            background: rgba(0, 200, 255, 0.1);
            border-color: #00C8FF;
            color: #00C8FF;
        }

        .assigned-item-text {
            font-size: 0.95rem;
            font-weight: 500;
            color: #1a1a2e;
            flex: 1;
        }

        body.dark-mode .assigned-item-text {
            color: #C0C0C0;
        }

        .assigned-empty {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        body.dark-mode .assigned-empty {
            color: #94a3b8;
        }

        .assigned-empty i {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        .assigned-empty p {
            font-size: 0.95rem;
            margin: 0;
        }

        /* Theme Toggle Button - Right of Main Box */
        .theme-toggle-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            border: 2px solid rgba(79, 70, 229, 0.3);
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .theme-toggle-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .theme-toggle-btn i {
            font-size: 1.4rem;
            color: #21004B;
            transition: all 0.3s ease;
        }

        body.dark-mode .theme-toggle-btn {
            background: transparent;
            border-color: rgba(255, 255, 255, 0.2);
        }

        body.dark-mode .theme-toggle-btn i {
            color: #FFFFFF;
        }

        /* Dynamic Profile Section */
        .profile-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            border-radius: 12px;
            background: rgba(79, 70, 229, 0.08);
            border: 1px solid rgba(79, 70, 229, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            transform: translateX(-30px);
        }

        .profile-container.loaded {
            opacity: 1;
            transform: translateX(0);
        }

        .profile-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #120038 0%, #1a0a4a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(18, 0, 56, 0.3);
            border: 2px solid #2a1a60;
        }

        .profile-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .profile-name {
            font-size: 15px;
            font-weight: 700;
            color: #000000;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .profile-role {
            font-size: 12px;
            font-weight: 500;
            color: #666666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Dark Mode Profile Styles */
        body.dark-mode .profile-container {
            background: rgba(58, 58, 58, 0.08);
            border: 1px solid rgba(192, 192, 192, 0.2);
        }

        body.dark-mode .profile-avatar {
            background: transparent;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        body.dark-mode .profile-name {
            color: #FFFFFF;
        }

        body.dark-mode .profile-role {
            color: #808080;
        }

        /* Responsive Profile */
        @media (max-width: 768px) {
            .profile-container {
                padding: 6px 12px;
                gap: 8px;
            }

            .profile-avatar {
                width: 38px;
                height: 38px;
                font-size: 16px;
            }

            .profile-name {
                font-size: 13px;
                max-width: 120px;
            }

            .profile-role {
                font-size: 10px;
            }
        }

        /* Dark Mode - Pure Black with Grey Borders */
        body.dark-mode {
            background: #000000;
            color: #C0C0C0;
        }
        
        /* Dark Mode Theme Styles */
        body.dark-mode .dashboard { background: #000000; }
        body.dark-mode .header { background: #000000; border: 2px solid #808080; }
        body.dark-mode .controls-bar { background: #000000; }
        body.dark-mode .search-box input { background: #000000; border: 2px solid #808080; color: #C0C0C0; }
        body.dark-mode .filter-select { background: #000000; border: 2px solid #808080; color: #C0C0C0; }
        body.dark-mode .filter-select option { background: #000000; color: #C0C0C0; }
        body.dark-mode .complaint-card { background: #000000; border: 2px solid #808080; }
        body.dark-mode .complaint-card h3 { color: #00FFFF; }
        body.dark-mode .complaint-card p { color: #C0C0C0; }
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode h4, body.dark-mode h5 { color: #C0C0C0; }
        body.dark-mode p, body.dark-mode span, body.dark-mode td { color: #C0C0C0; }
        body.dark-mode .card, body.dark-mode .stats-card, body.dark-mode .info-card { background: #000000; border: 2px solid #808080; }
        body.dark-mode .btn-primary, body.dark-mode .action-btn { background: linear-gradient(135deg, #4CAF50, #45a049); color: #FFFFFF; border: 2px solid #4CAF50; }
        body.dark-mode table { background: #000000; border: 2px solid #808080; }
        body.dark-mode th { background: #000000; color: #00FFFF; border-bottom: 2px solid #808080; text-transform: uppercase; }
        body.dark-mode td { background: #000000; color: #C0C0C0; border-bottom: 1px solid #808080; }
        body.dark-mode .user-avatar { background: #000000; border: 2px solid #FFD100; color: #C0C0C0; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background: #000000; color: #C0C0C0; border: 2px solid #808080; }
        body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode textarea:focus { border-color: #A9A9A9; outline: none; }
        body.dark-mode input::placeholder, body.dark-mode textarea::placeholder { color: #999999; }
        body.dark-mode .kanban-column { background: #000000; border: 2px solid #808080; }
        body.dark-mode .modal { background: rgba(0, 0, 0, 0.95); }
        
        /* Light Mode Theme Styles */
        body.light-mode .complaint-card { background: #2a1a60; border: 2px solid rgba(255, 255, 255, 0.3); }
        body.light-mode .card, body.light-mode .stats-card, body.light-mode .info-card { background: #1a0a4a; border: 2px solid #2a1a60; }
        body.light-mode .filter-select { background: #1a0a4a; border: 2px solid #3a2a70; color: #ffffff; }
        body.light-mode .filter-select option { background: #1a0a4a; color: #ffffff; }
        body.light-mode table { background: linear-gradient(135deg, #120038 0%, #1a0a4a 100%); border: 2px solid #2a1a60; }
        body.light-mode th { background: linear-gradient(135deg, #2a1a60 0%, #3a2a70 100%); }
        body.light-mode tr { background: #1a0a4a; }
        body.light-mode tr:nth-child(even) { background: #2a1a60; }

        /* Notification Bar Styles */
        .notification-bar { display: flex; align-items: center; gap: 20px; margin-right: 20px; }
        .notification-item { position: relative; cursor: pointer; transition: all 0.3s ease; }
        .notification-icon { width: 44px; height: 44px; background: rgba(18, 0, 56, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #FFD700; font-size: 18px; transition: all 0.3s ease; border: 2px solid rgba(42, 26, 96, 0.5); }
        .notification-badge { position: absolute; top: -6px; right: -6px; background: #ff4d4d; color: white; font-size: 11px; font-weight: 700; min-width: 20px; height: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: center; padding: 0 6px; }
        .notification-badge.pulse { animation: badgePulse 2s ease-in-out infinite; }
        @keyframes badgePulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        .notification-tooltip { position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%) scale(0.9); background: rgba(0, 0, 0, 0.9); color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; white-space: nowrap; opacity: 0; pointer-events: none; transition: all 0.2s ease; z-index: 1000; }
        .notification-item:hover .notification-tooltip { opacity: 1; transform: translateX(-50%) scale(1); }
        .notification-dropdown { position: absolute; top: 60px; right: 0; width: 380px; max-height: 500px; background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 248, 255, 0.98) 100%); border-radius: 16px; opacity: 0; transform: translateY(-10px); pointer-events: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; border: 1px solid rgba(255, 255, 255, 0.3); overflow: hidden; }
        .notification-dropdown.active { opacity: 1; transform: translateY(0); pointer-events: all; }
        .dropdown-header { padding: 18px 20px; border-bottom: 1px solid rgba(0, 0, 0, 0.08); background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; }
        .dropdown-header h3 { margin: 0; font-size: 16px; font-weight: 600; }
        .dropdown-content { max-height: 400px; overflow-y: auto; padding: 8px; }
        .dropdown-item { padding: 14px 16px; border-radius: 10px; margin-bottom: 6px; background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(0, 0, 0, 0.05); transition: all 0.2s ease; cursor: pointer; }
        .dropdown-item-title { font-weight: 600; font-size: 14px; color: #2D1B69; margin-bottom: 4px; }
        .dropdown-item-subtitle { font-size: 12px; color: #666; }
        .dropdown-empty { padding: 40px 20px; text-align: center; color: #999; font-size: 14px; }
        .dropdown-empty i { font-size: 48px; opacity: 0.3; margin-bottom: 12px; }
        body.dark-mode .notification-dropdown { background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%); border: 2px solid #00FFFF; }
        body.dark-mode .dropdown-item { background: transparent; border: 1px solid rgba(0, 255, 255, 0.3); }
        body.dark-mode .dropdown-item:hover { background: #2a2a2a; border-color: #00FFFF; }
        body.dark-mode .dropdown-item-title { color: #00FFFF; }
        body.dark-mode .dropdown-item-subtitle { color: #CCCCCC; }
        body.dark-mode .notification-icon { background: transparent; color: #00FFFF; border: 2px solid #00FFFF; }
        body.dark-mode .theme-toggle { background: transparent; border: 2px solid #00FFFF; }
        body.dark-mode .theme-toggle i { color: #00FFFF; }
        @media (max-width: 768px) { .notification-bar { gap: 12px; margin-right: 12px; } .notification-icon { width: 38px; height: 38px; font-size: 16px; } .notification-dropdown { width: 95vw; right: -50px; } }

        /* Mail Button Styles */
        .mail-btn { width: 44px; height: 44px; background: linear-gradient(135deg, rgba(18, 0, 56, 0.2) 0%, rgba(26, 10, 74, 0.2) 100%); border: 2px solid rgba(42, 26, 96, 0.5); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #FFD700; font-size: 18px; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .mail-badge { position: absolute; top: -6px; right: -6px; background: #ff4d4d; color: white; font-size: 11px; font-weight: 700; min-width: 20px; height: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: center; padding: 0 6px; }
        .mail-badge.pulse { animation: badgePulse 2s ease-in-out infinite; }
        body.dark-mode .mail-btn { background: transparent; border: 2px solid #00FFFF; color: #00FFFF; }

        /* Message Modal Styles */
        .message-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 10000; animation: fadeIn 0.3s ease; }
        .message-modal-overlay.active { display: flex; }
        .message-modal { background: #ffffff; border-radius: 20px; width: 90%; max-width: 600px; max-height: 85vh; overflow: hidden; animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(0,0,0,0.1); }
        .message-modal-header { background: linear-gradient(135deg, #f8f9fa, #e9ecef); color: #1a1a2e; padding: 24px 28px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .message-modal-title { margin: 0; font-size: 22px; font-weight: 600; display: flex; align-items: center; gap: 12px; color: #1a1a2e; }
        .message-modal-close { background: rgba(0, 0, 0, 0.1); border: none; color: #1a1a2e; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .message-modal-close:hover { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .message-modal-body { padding: 28px; max-height: calc(85vh - 160px); overflow-y: auto; background: #ffffff; }
        .message-form-group { margin-bottom: 20px; }
        .message-form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; font-size: 14px; }
        .message-form-input, .message-form-select, .message-form-textarea { width: 100%; padding: 12px 16px; border: 1px solid #dee2e6; border-radius: 10px; font-size: 14px; font-family: inherit; transition: all 0.3s ease; background: #f8f9fa; color: #1a1a2e; }
        .message-form-input:focus, .message-form-select:focus, .message-form-textarea:focus { outline: none; border-color: #4f46e5; }
        .message-form-textarea { resize: vertical; min-height: 150px; }
        .message-form-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding: 15px 0 0; border-top: 1px solid rgba(0,0,0,0.1); }
        .message-btn { padding: 12px 28px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .message-btn-primary { background: linear-gradient(135deg, #4f46e5, #6366f1); color: white; }
        .message-btn-secondary { background: #e2e8f0; color: #4a5568; }
        body.dark-mode .message-modal { background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%); border: 1px solid rgba(0, 200, 255, 0.3); }
        body.dark-mode .message-modal-header { background: linear-gradient(135deg, rgba(0, 200, 255, 0.1), rgba(0, 150, 255, 0.05)); border-bottom: 1px solid rgba(0, 200, 255, 0.2); }
        body.dark-mode .message-modal-title { color: #00C8FF; }
        body.dark-mode .message-modal-close { background: rgba(255,255,255,0.1); color: #fff; }
        body.dark-mode .message-modal-body { background: transparent; }
        body.dark-mode .message-form-label { color: #C0C0C0; }
        body.dark-mode .message-form-input, body.dark-mode .message-form-select, body.dark-mode .message-form-textarea { background: rgba(45, 45, 68, 0.8); border: 1px solid rgba(0, 200, 255, 0.3); color: #fff; }
        body.dark-mode .message-form-input:focus, body.dark-mode .message-form-select:focus, body.dark-mode .message-form-textarea:focus { border-color: #00C8FF; }
        body.dark-mode .message-form-actions { border-top: 1px solid rgba(0, 200, 255, 0.2); }
        body.dark-mode .message-btn-primary { background: linear-gradient(135deg, #00C8FF, #0088FF); }
        body.dark-mode .message-btn-secondary { background: rgba(45, 45, 68, 0.8); color: #C0C0C0; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
        /* Compact Button Styles */
        .btn-compact {
            padding: 8px 16px !important;
            font-size: 0.9rem !important;
            min-width: auto !important;
        }

        .action-btn {
            width: 36px !important;
            height: 36px !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .action-btn-group {
            gap: 8px !important;
        }

        button[title] {
            font-size: 0.9rem !important;
        }
</style>
    <script src="js/config.js"></script>
</head>
<body>
    <!-- Message Compose Modal -->
    <div class="message-modal-overlay" id="messageModal">
        <div class="message-modal">
            <div class="message-modal-header">
                <h2 class="message-modal-title">
                    <i class="fas fa-envelope"></i>
                    Send Message
                </h2>
                <button class="message-modal-close" id="closeMessageModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="message-modal-body">
                <form id="messageForm">
                    <div class="message-form-group">
                        <label class="message-form-label" for="messageReceiver">To:</label>
                        <select class="message-form-select" id="messageReceiver" required>
                            <option value="">Select recipient...</option>
                        </select>
                    </div>
                    <div class="message-form-group">
                        <label class="message-form-label" for="messageSubject">Subject:</label>
                        <input type="text" class="message-form-input" id="messageSubject" placeholder="Enter subject..." required>
                    </div>
                    <div class="message-form-group">
                        <label class="message-form-label" for="messageBody">Message:</label>
                        <textarea class="message-form-textarea" id="messageBody" placeholder="Type your message here..." required></textarea>
                    </div>
                    <div class="message-form-actions">
                        <button type="button" class="message-btn message-btn-secondary" id="cancelMessageBtn">Cancel</button>
                        <button type="submit" class="message-btn message-btn-primary">
                            <i class="fas fa-paper-plane"></i> Send Message
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Assigned Areas Modal -->
    <div class="assigned-modal-overlay" id="assignedModal">
        <div class="assigned-modal">
            <div class="assigned-modal-header">
                <h2 class="assigned-modal-title">
                    <i class="fas fa-user-circle"></i>
                    Admin Profile & Assignments
                </h2>
                <button class="assigned-modal-close" id="closeAssignedModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="assigned-summary">
                <h3>Admin Details</h3>
                <p id="assignmentSummary"></p>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #2a1a60;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                        <i class="fas fa-user" style="color: #4aa8ff; width: 20px;"></i>
                        <span id="adminNameDetail" style="color: #dcdcdc;"></span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                        <i class="fas fa-envelope" style="color: #4aa8ff; width: 20px;"></i>
                        <span id="adminEmailDetail" style="color: #dcdcdc;"></span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-shield-alt" style="color: #4aa8ff; width: 20px;"></i>
                        <span style="color: #dcdcdc;">Role: Administrator</span>
                    </div>
                </div>
            </div>

            <div class="assigned-section">
                <div class="assigned-section-title">
                    <i class="fas fa-map-marker-alt"></i>
                    Assigned Districts
                </div>
                <div class="assigned-items" id="districtsList"></div>
            </div>

            <div class="assigned-section">
                <div class="assigned-section-title">
                    <i class="fas fa-route"></i>
                    Assigned Routes
                </div>
                <div class="assigned-items" id="routesList"></div>
            </div>
        </div>
    </div>

    <!-- Message Inbox Modal -->
    <div class="message-modal-overlay" id="inboxModal" style="display: none;">
        <div class="message-modal" style="max-width: 800px;">
            <div class="message-modal-header">
                <h2 class="message-modal-title">
                    <i class="fas fa-inbox"></i>
                    Message Inbox
                </h2>
                <button class="message-modal-close" id="closeInboxModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="message-modal-body" style="max-height: 600px; overflow-y: auto;">
                <div id="inboxContent">
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                        <p>Loading messages...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Loading Overlay -->
    <div class="dashboard-loader-overlay" id="dashboardLoader">
        <div class="loader-container">
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
            <div class="loader-text">
                Loading Dashboard
                <span class="loader-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <div class="logo-section">
                    <div class="logo">
                        <img src="assets/logo.png" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">
                    </div>
                    <div class="header-info">
                        <h1>Admin Dashboard</h1>
                        <p>Complaint Management System</p>
                    </div>
                </div>
                
                <div class="user-info">
                    <!-- Mail Button -->
                    <button class="mail-btn" id="mailBtn" title="Messages">
                        <i class="fas fa-envelope"></i>
                        <span class="mail-badge" id="mailBadge" style="display: none;">0</span>
                    </button>

                    <!-- Notification Bar -->
                    <div class="notification-bar">
                        <div class="notification-item" data-type="notifications">
                            <div class="notification-icon"><i class="fas fa-bell"></i></div>
                            <span class="notification-badge pulse" id="notificationBadge">0</span>
                            <div class="notification-tooltip">All Notifications</div>
                        </div>
                    </div>

                    <button class="logout-btn" id="logout">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>

                    <!-- Profile Dropdown -->
                    <div class="profile-dropdown-container">
                        <div style="display: flex; align-items: center; gap: 10px; cursor: pointer;" id="profileSection" onclick="toggleProfileDropdown()">
                            <div class="user-avatar" id="userAvatar">A</div>
                            <div>
                                <div style="font-weight: 600;" id="userName">Admin</div>
                                <div style="font-size: 0.8rem; color: #718096;">Administrator</div>
                            </div>
                            <i class="fas fa-chevron-down" style="font-size: 12px; color: #718096;"></i>
                        </div>
                        
                        <!-- Profile Dropdown Menu -->
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="profile-dropdown-header">
                                <div class="profile-avatar-large" id="profileAvatarLarge" onclick="triggerPhotoUpload()">
                                    <span id="profileInitial">A</span>
                                    <div class="upload-overlay"><i class="fas fa-camera"></i> Change</div>
                                </div>
                                <div class="profile-name" id="profileName">Admin</div>
                                <div class="profile-email" id="profileEmail">admin@servonix.com</div>
                                <div class="profile-role-badge" id="profileRole">Admin</div>
                            </div>
                            <div class="profile-dropdown-menu">
                                <div class="profile-info-item">
                                    <i class="fas fa-clock"></i>
                                    <span>Last login: <span id="lastLoginTime">-</span></span>
                                </div>
                                <div class="profile-info-item" id="assignedDistrictsInfo" style="display: none;">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>District: <span id="assignedDistricts">-</span></span>
                                </div>
                                <div class="profile-info-item" id="assignedRoutesInfo" style="display: none;">
                                    <i class="fas fa-route"></i>
                                    <span>Routes: <span id="assignedRoutes">-</span></span>
                                </div>
                                <div class="profile-menu-item" onclick="triggerPhotoUpload()">
                                    <i class="fas fa-camera"></i>
                                    <span>Change Profile Photo</span>
                                </div>
                                <div class="profile-menu-item danger" onclick="logoutAllDevices()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Logout from all devices</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden file input for photo upload -->
                    <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;">
                </div>
            </div>

            <!-- Controls Bar -->
            <div class="controls-bar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search complaints by ID, name, email, or description...">
                    <i class="fas fa-search"></i>
                </div>
                
                <select id="statusFilter" class="filter-select">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="resolved">Resolved</option>
                </select>

                <select id="categoryFilter" class="filter-select">
                    <option value="">All Categories</option>
                    <option value="delay">Schedule Delay</option>
                    <option value="cleanliness">Cleanliness</option>
                    <option value="staff">Staff Behavior</option>
                    <option value="safety">Safety</option>
                    <option value="other">Other</option>
                </select>
                
                <button class="btn-messages" id="messagesBtn" onclick="showMessagesSection()">
                    <i class="fas fa-envelope"></i> Messages
                    <span class="message-badge" id="messageBadge" style="display: none;">0</span>
                </button>
                
                <button class="refresh-btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </header>

        <!-- Statistics Section -->
        <div class="stats-section">
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-number total" id="totalCount">0</div>
                    <div class="stat-label">Total Complaints</div>
                </div>
                <div class="stat-card pending">
                    <div class="stat-number pending" id="pendingCount">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card in-progress">
                    <div class="stat-number in-progress" id="inProgressCount">0</div>
                    <div class="stat-label">In Progress</div>
                </div>
                <div class="stat-card resolved">
                    <div class="stat-number resolved" id="resolvedCount">0</div>
                    <div class="stat-label">Resolved</div>
                </div>
            </div>
        </div>

        <!-- Messages Section -->
        <div class="messages-container" id="messagesContainer">
            <div class="messages-header">
                <h2 class="messages-title">
                    <i class="fas fa-inbox"></i> Messages to Head
                </h2>
                <button class="btn-compose" onclick="openComposeModal()">
                    <i class="fas fa-plus"></i> Compose Message
                </button>
            </div>

            <div id="messagesContent">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div>Loading messages...</div>
                </div>
            </div>
        </div>

        <!-- Complaints Section -->
        <div class="complaints-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-list"></i> Complaint Management
                </h2>
            </div>

            <div id="messageContainer"></div>
            
            <div id="complaintsContainer" style="overflow-x: auto; overflow-y: visible; max-width: 100%;">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div>Loading complaints...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.IO for real-time updates -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <script>
        // ? SMOOTH LOADING MANAGEMENT
        function showLoading(container, message = 'Loading...') {
            const loadingHTML = `
                <div class="loading-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; gap: 20px;">
                    <div class="spinner" style="width: 50px; height: 50px; border: 4px solid rgba(0, 255, 255, 0.1); border-top: 4px solid #00FFFF; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="color: var(--text-200); font-size: 1rem;">${message}</p>
                </div>
            `;
            if (container) container.innerHTML = loadingHTML;
        }

        function hideLoading(container) {
            const loading = container?.querySelector('.loading-state');
            if (loading) {
                loading.style.opacity = '0';
                setTimeout(() => loading.remove(), 300);
            }
        }

        // Add spinner animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .loading-state {
                transition: opacity 0.3s ease;
            }
        `;
        document.head.appendChild(style);



        //  PERFORMANCE OPTIMIZATIONS
        
        // Debounce search input
        let searchDebounce = null;
        function debounceSearch(func, delay = 500) {
            return function(...args) {
                clearTimeout(searchDebounce);
                searchDebounce = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Retry failed API requests
        async function apiRequestWithRetry(url, method = 'GET', body = null, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await apiRequest(url, method, body);
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    console.log(`[RETRY] Attempt ${i + 1} failed, retrying...`);
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
        }

        // Smooth scroll to top
        function smoothScrollTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Cache management
        let complaintsCache = null;
        let cacheTimestamp = null;
        const CACHE_DURATION = 5000; // 5 seconds

        function getCachedComplaints() {
            if (complaintsCache && cacheTimestamp && (Date.now() - cacheTimestamp < CACHE_DURATION)) {
                return complaintsCache;
            }
            return null;
        }

        function setCachedComplaints(data) {
            complaintsCache = data;
            cacheTimestamp = Date.now();
        }
//  REAL-TIME AUTO-REFRESH SYSTEM
        let refreshInterval = null;
        const REFRESH_RATE = 10000; // 10 seconds

        // Initialize Socket.IO for real-time updates
        let socket = null;
        
        function initializeWebSocket() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('[WebSocket] No token found, skipping connection');
                return;
            }
            
            const socketURL = API_BASE || 'http://127.0.0.1:5000';
            console.log('[WebSocket] Connecting to:', socketURL);
            
            socket = io(socketURL, {
                transports: ['polling', 'websocket'],
                upgrade: true,
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5,
                timeout: 20000
            });
            
            socket.on('connect', () => {
                console.log('[WebSocket] Connected:', socket.id);
                socket.emit('register', { token: token });
            });
            
            socket.on('registered', (data) => {
                console.log('[WebSocket] Registered:', data);
            });
            
            socket.on('complaints_updated', (data) => {
                console.log('[WebSocket] Complaints updated:', data);
                loadComplaints(false);
            });
            
            socket.on('complaint_assigned', (data) => {
                console.log('[WebSocket] Complaint assigned to you:', data);
                loadComplaints(false);
                showNotification('New complaint assigned to you!', 'info');
            });
            
            socket.on('complaint_status_changed', (data) => {
                console.log('[WebSocket] Complaint status changed:', data);
                loadComplaints(false);
            });
            
            socket.on('disconnect', () => {
                console.log('[WebSocket] Disconnected');
            });
            
            socket.on('error', (error) => {
                console.error('[WebSocket] Error:', error);
            });
        }
        
        function showNotification(message, type = 'info') {
            // Simple notification - you can enhance this
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#22c55e' : '#3b82f6'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            
            refreshInterval = setInterval(async () => {
                try {
                    console.log('[AUTO-REFRESH] Fetching latest data...');
                    await loadComplaints(false);
                    console.log('[AUTO-REFRESH]  Data refreshed');
                } catch (error) {
                    console.error('[AUTO-REFRESH] Error:', error);
                }
            }, REFRESH_RATE);
            
            console.log(`[AUTO-REFRESH] Started (every ${REFRESH_RATE/1000}s)`);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Start when page loads
        window.addEventListener('DOMContentLoaded', () => {
            initializeWebSocket();
            startAutoRefresh();
        });
        window.addEventListener('beforeunload', () => {
            if (socket) socket.disconnect();
            stopAutoRefresh();
        });
        
        // Pause when tab hidden, resume when visible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });

        // View Complaint Details Function for Admin Dashboard
        async function viewComplaintDetails(complaintId) {
            console.log('[ADMIN] viewComplaintDetails:', complaintId);
            try {
                // Use the global apiRequest function from auth.js
                const apiRequestFn = window.apiRequest || apiRequest;
                const response = await apiRequestFn(`/api/complaints/${complaintId}`);
                if (response.ok) {
                    const complaint = await response.json();
                    // Show complaint details modal
                    showComplaintModal(complaint);
                } else {
                    showMessage('Failed to load complaint details', 'error');
                }
            } catch (error) {
                console.error('[ADMIN] Error:', error);
                showMessage('Error loading complaint details', 'error');
            }
        }
        // Expose to global scope immediately
        window.viewComplaintDetails = viewComplaintDetails;

        function showComplaintModal(complaint) {
            // Remove existing modal if any
            const existingModal = document.getElementById('complaintDetailModal');
            if (existingModal) existingModal.remove();
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'complaintDetailModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            
            const statusColors = {
                'pending': '#F59E0B',
                'in_progress': '#3B82F6',
                'in-progress': '#3B82F6',
                'resolved': '#10B981',
                'rejected': '#EF4444'
            };
            const statusColor = statusColors[complaint.status] || '#6B7280';
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a0a4a, #2a1a60); padding: 30px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0,0,0,0.6); border: 2px solid rgba(255,215,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid rgba(255,255,255,0.1);">
                        <h3 style="margin: 0; color: #FFD700; font-size: 1.4rem; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-clipboard-list"></i>
                            Complaint #${complaint.id}
                        </h3>
                        <button onclick="document.getElementById('complaintDetailModal').remove()" style="background: transparent; border: 2px solid rgba(255,255,255,0.3); color: white; font-size: 20px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">&times;</button>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: rgba(255,255,255,0.7);">Status</span>
                            <span style="background: ${statusColor}; color: white; padding: 6px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem;">${(complaint.status || 'pending').replace('_', ' ').replace('-', ' ').toUpperCase()}</span>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px;">
                            <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 6px;">User</div>
                            <div style="color: white; font-weight: 500;">${complaint.user_name || complaint.user_email || complaint.email || 'Unknown'}</div>
                            ${(complaint.user_email || complaint.email) ? `<div style="color: #FFD700; font-size: 0.9rem; margin-top: 4px;"><i class="fas fa-envelope" style="margin-right: 6px;"></i>${complaint.user_email || complaint.email}</div>` : ''}
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px;">
                            <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 6px;">Category</div>
                            <div style="color: white; font-weight: 500;">${complaint.complaint_type || complaint.category || 'General'}</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px;">
                                <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 6px;"><i class="fas fa-map-marked-alt" style="margin-right: 6px;"></i>District</div>
                                <div style="color: #00FFFF; font-weight: 600;">${complaint.district_name || complaint.district || 'N/A'}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px;">
                                <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 6px;"><i class="fas fa-route" style="margin-right: 6px;"></i>Route</div>
                                <div style="color: #00FFFF; font-weight: 600;">${complaint.route || complaint.route_number || 'N/A'}</div>
                            </div>
                        </div>
                        
                        ${complaint.bus_number ? `
                        <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px;">
                            <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 6px;"><i class="fas fa-bus" style="margin-right: 6px;"></i>Bus Number</div>
                            <div style="color: #00FFFF; font-weight: 600;">${complaint.bus_number}</div>
                        </div>
                        ` : ''}
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px;">
                            <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 8px;"><i class="fas fa-comment-alt" style="margin-right: 6px;"></i>Description</div>
                            <div style="color: white; line-height: 1.6; white-space: pre-wrap;">${complaint.description || 'No description provided'}</div>
                        </div>
                        
                        ${(complaint.media_files && complaint.media_files.length > 0) || complaint.proof_path ? `
                        <div style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.15), rgba(59, 130, 246, 0.15)); padding: 20px; border-radius: 12px; border: 2px solid rgba(255, 215, 0, 0.3);">
                            <div style="color: #FFD700; font-size: 1rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-photo-video" style="font-size: 1.2rem;"></i>
                                <span>Attached Media (${complaint.media_files ? complaint.media_files.length : 1})</span>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${complaint.media_files ? complaint.media_files.map((file, index) => `
                                    <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 12px; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; transition: all 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.5)'; this.style.borderColor='#FFD700'" onmouseout="this.style.background='rgba(0,0,0,0.3)'; this.style.borderColor='rgba(255,255,255,0.1)'">
                                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                            <div style="background: linear-gradient(135deg, #9333EA, #3B82F6); width: 50px; height: 50px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                ${file.mime_type && file.mime_type.startsWith('image/') ? `
                                                    <i class="fas fa-image" style="color: white; font-size: 24px;"></i>
                                                ` : file.mime_type && file.mime_type.startsWith('video/') ? `
                                                    <i class="fas fa-video" style="color: white; font-size: 24px;"></i>
                                                ` : `
                                                    <i class="fas fa-file-pdf" style="color: white; font-size: 24px;"></i>
                                                `}
                                            </div>
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="color: white; font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${file.file_name || 'Media File ' + (index + 1)}</div>
                                                <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">
                                                    ${file.mime_type || 'Unknown type'} ${file.file_size ? ' ' + (file.file_size / 1024).toFixed(0) + ' KB' : ''}
                                                </div>
                                            </div>
                                        </div>
                                        <button onclick="event.stopPropagation(); openMediaViewer('${file.url || file.file_path}', '${file.file_name}', '${file.mime_type}')" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                                            <i class="fas fa-eye"></i>
                                            <span>View</span>
                                        </button>
                                    </div>
                                `).join('') : complaint.proof_path ? `
                                    <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 12px; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between;">
                                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                            <div style="background: linear-gradient(135deg, #9333EA, #3B82F6); width: 50px; height: 50px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-image" style="color: white; font-size: 24px;"></i>
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="color: white; font-weight: 600; font-size: 0.95rem; margin-bottom: 4px;">Proof Attachment</div>
                                                <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">Image file</div>
                                            </div>
                                        </div>
                                        <button onclick="openMediaViewer('${complaint.proof_path}', 'Proof Attachment', 'image/jpeg')" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;">
                                            <i class="fas fa-eye"></i>
                                            <span>View</span>
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${complaint.admin_response ? `
                        <div style="background: rgba(16,185,129,0.1); padding: 16px; border-radius: 12px; border-left: 4px solid #10B981;">
                            <div style="color: #10B981; font-size: 0.85rem; margin-bottom: 8px; font-weight: 600;"><i class="fas fa-reply" style="margin-right: 6px;"></i>Admin Response</div>
                            <div style="color: white; line-height: 1.6;">${complaint.admin_response}</div>
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; justify-content: space-between; color: rgba(255,255,255,0.5); font-size: 0.85rem; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <span><i class="fas fa-calendar-alt" style="margin-right: 6px;"></i>Created: ${new Date(complaint.created_at).toLocaleString()}</span>
                            ${complaint.resolved_at ? `<span><i class="fas fa-check-circle" style="margin-right: 6px;"></i>Resolved: ${new Date(complaint.resolved_at).toLocaleString()}</span>` : ''}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 25px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.1);">
                        <button onclick="openMessageModal('${complaint.email}', '${(complaint.user_name || complaint.name || 'User').replace(/'/g, "\\'")}'); document.getElementById('complaintDetailModal').remove();" style="flex: 1; background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'"><i class="fas fa-paper-plane" style="margin-right: 8px;"></i>Send Message</button>
                        <button onclick="event.stopPropagation(); showInlineStatusUpdater(${complaint.id}, event); document.getElementById('complaintDetailModal').remove();" style="flex: 1; background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'"><i class="fas fa-exchange-alt" style="margin-right: 8px;"></i>Change Status</button>
                        <button onclick="document.getElementById('complaintDetailModal').remove()" style="background: #6b7280; color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on backdrop click
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        window.showComplaintModal = showComplaintModal;

        // =============== MESSAGING SYSTEM ===============

        // Show messages section
        function showMessagesSection() {
            const messagesContainer = document.getElementById('messagesContainer');
            const complaintsSection = document.querySelector('.complaints-section');
            
            if (messagesContainer.style.display === 'none' || !messagesContainer.style.display) {
                messagesContainer.style.display = 'block';
                complaintsSection.style.display = 'none';
                loadMessages();
            } else {
                messagesContainer.style.display = 'none';
                complaintsSection.style.display = 'block';
            }
        }

        // Load sent messages
        async function loadMessages() {
            const token = localStorage.getItem('token');
            const messagesContent = document.getElementById('messagesContent');
            
            showLoading(messagesContent, 'Loading messages...');
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/messages/admin/sent', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayMessages(data.messages || []);
                } else {
                    messagesContent.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Failed to load messages</h3><p>Please try again later</p></div>';
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                messagesContent.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Connection Error</h3><p>Unable to connect to server</p></div>';
            }
        }

        // Display messages
        function displayMessages(messages) {
            const messagesContent = document.getElementById('messagesContent');
            
            if (messages.length === 0) {
                messagesContent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No messages yet</h3>
                        <p>Click "Compose Message" to send your first message to Head</p>
                    </div>
                `;
                return;
            }

            const messagesList = messages.map(msg => {
                const statusClass = msg.status === 'resolved' ? 'resolved' : (msg.reply_content ? 'read' : 'unread');
                const statusText = msg.status === 'resolved' ? 'Resolved' : (msg.reply_content ? 'Replied' : 'Pending');
                const statusIcon = msg.status === 'resolved' ? 'check-double' : (msg.reply_content ? 'reply' : 'clock');
                
                return `
                    <div class="message-item ${statusClass}" onclick="viewMessage(${msg.id})">
                        <div class="message-row">
                            <div class="message-content">
                                <div class="message-subject">${escapeHtml(msg.subject)}</div>
                                <div class="message-preview">${escapeHtml(msg.message_content)}</div>
                                <div class="message-meta">
                                    <span><i class="fas fa-calendar"></i> ${formatDate(msg.created_at)}</span>
                                    ${msg.complaint_number ? `<span><i class="fas fa-link"></i> Complaint #${msg.complaint_number}</span>` : ''}
                                </div>
                            </div>
                            <div class="message-status ${statusClass}">
                                <i class="fas fa-${statusIcon}"></i> ${statusText}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            messagesContent.innerHTML = `<div class="messages-list">${messagesList}</div>`;
        }

        // Open compose modal
        function openComposeModal() {
            const modal = document.getElementById('composeModal');
            modal.style.display = 'flex';
            
            // Load complaints for linking
            loadComplaintsForLink();
            
            // Setup character counter
            const textarea = document.getElementById('messageContent');
            const charCount = document.getElementById('charCount');
            textarea.addEventListener('input', () => {
                charCount.textContent = textarea.value.length;
            });
        }

        // Close compose modal
        function closeComposeModal() {
            const modal = document.getElementById('composeModal');
            modal.style.display = 'none';
            document.getElementById('composeForm').reset();
            document.getElementById('charCount').textContent = '0';
        }

        // Load complaints for dropdown
        async function loadComplaintsForLink() {
            const token = localStorage.getItem('token');
            const select = document.getElementById('complaintLink');
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/admin/complaints', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const complaints = data.complaints || [];
                    
                    select.innerHTML = '<option value="">-- No complaint linked --</option>' +
                        complaints.filter(c => c.status !== 'resolved').map(c => 
                            `<option value="${c.id}">Complaint #${c.complaint_id} - ${escapeHtml(c.description?.substring(0, 50) || 'No description')}...</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading complaints:', error);
            }
        }

        // Send message
        async function sendMessage(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('token');
            const subject = document.getElementById('messageSubject').value.trim();
            const message = document.getElementById('messageContent').value.trim();
            const complaintId = document.getElementById('complaintLink').value;
            
            if (!subject || !message) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            try {
                const response = await fetch('http://127.0.0.1:5000/api/messages/admin/send', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject,
                        message,
                        complaint_id: complaintId || null
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('Message sent successfully!', 'success');
                    closeComposeModal();
                    loadMessages(); // Reload messages
                } else {
                    showToast(data.error || 'Failed to send message', 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Network error. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Message';
            }
        }

        // View message details
        async function viewMessage(messageId) {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`http://127.0.0.1:5000/api/messages/admin/${messageId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const msg = data.message;
                    
                    // Populate modal
                    document.getElementById('viewMessageSubject').textContent = msg.subject;
                    document.getElementById('viewMessageMeta').innerHTML = `
                        <span><i class="fas fa-user"></i> To: ${msg.head_name}</span>
                        <span><i class="fas fa-calendar"></i> ${formatDate(msg.created_at)}</span>
                        <span class="message-status ${msg.status === 'resolved' ? 'resolved' : (msg.reply_content ? 'read' : 'pending')}">
                            <i class="fas fa-${msg.status === 'resolved' ? 'check-double' : (msg.reply_content ? 'reply' : 'clock')}"></i>
                            ${msg.status === 'resolved' ? 'Resolved' : (msg.reply_content ? 'Replied' : 'Pending')}
                        </span>
                    `;
                    document.getElementById('viewMessageContent').textContent = msg.message_content;
                    
                    // Show complaint info if linked
                    if (msg.complaint_id) {
                        document.getElementById('complaintInfo').style.display = 'block';
                        document.getElementById('complaintDetails').innerHTML = `
                            Complaint #${msg.complaint_number}<br>
                            ${escapeHtml(msg.complaint_description?.substring(0, 100) || '')}...
                        `;
                    } else {
                        document.getElementById('complaintInfo').style.display = 'none';
                    }
                    
                    // Show reply if exists
                    if (msg.reply_content) {
                        document.getElementById('replySection').style.display = 'block';
                        document.getElementById('noReply').style.display = 'none';
                        document.getElementById('replyContent').textContent = msg.reply_content;
                        document.getElementById('replyTime').textContent = formatDate(msg.replied_at);
                    } else {
                        document.getElementById('replySection').style.display = 'none';
                        document.getElementById('noReply').style.display = 'block';
                    }
                    
                    // Show modal
                    document.getElementById('viewMessageModal').style.display = 'flex';
                } else {
                    showToast('Failed to load message details', 'error');
                }
            } catch (error) {
                console.error('Error viewing message:', error);
                showToast('Network error. Please try again.', 'error');
            }
        }

        // Close view message modal
        function closeViewMessageModal() {
            document.getElementById('viewMessageModal').style.display = 'none';
        }

        // Helper: Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Helper: Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Make functions globally available
        window.showMessagesSection = showMessagesSection;
        window.openComposeModal = openComposeModal;
        window.closeComposeModal = closeComposeModal;
        window.sendMessage = sendMessage;
        window.viewMessage = viewMessage;
        window.closeViewMessageModal = closeViewMessageModal;
</script>
    <script src="js/auth.js"></script>
    <script src="js/realtime.js"></script>
    <script src="js/theme-switcher.js"></script>
    <script>
        // Check authentication
        if (!getToken()) {
            window.location.href = 'login.html';
        }

        // API Base URL (only define if not already defined)
        if (typeof API_BASE === 'undefined') {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                var API_BASE = 'http://127.0.0.1:5000';
            } else if (window.location.hostname.includes('github.io')) {
                var API_BASE = 'https://servonix-bus-complaint-management-system.onrender.com';
            } else {
                var API_BASE = '';
            }
        }

        // Global variables
        let allComplaints = [];
        let filteredComplaints = [];
        let expandedReplies = new Set();

        // Logout functionality
        document.getElementById('logout').addEventListener('click', () => {
            clearToken();
            window.location.href = 'login.html';
        });

        // Load admin info
        function loadAdminInfo() {
            const userName = localStorage.getItem('user_name') || 'Admin';
            document.getElementById('userName').textContent = userName;
            document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();
        }

        // Load dynamic profile section
        function loadDynamicProfile() {
            const userName = localStorage.getItem('user_name') || localStorage.getItem('userName') || 'Admin User';
            const userEmail = localStorage.getItem('userEmail') || 'admin@servonix.com';
            const userRole = localStorage.getItem('userRole') || 'Admin';
            
            // Update profile elements
            const profileAvatar = document.getElementById('profileAvatar');
            const profileName = document.getElementById('profileName');
            const profileRole = document.getElementById('profileRole');
            const dynamicProfile = document.getElementById('dynamicProfile');
            
            if (profileAvatar && profileName && profileRole && dynamicProfile) {
                // Set avatar initial
                profileAvatar.textContent = userName.charAt(0).toUpperCase();
                
                // Set name and role
                profileName.textContent = userName;
                profileRole.textContent = userRole;
                
                // Trigger slide-in animation
                setTimeout(() => {
                    dynamicProfile.classList.add('loaded');
                }, 100);
            }
        }

        // Load all complaints
        async function loadComplaints(showIndicator = false) {
            try {
                // Show refresh indicator if requested
                if (showIndicator) {
                    const refreshBtn = document.getElementById('refreshBtn');
                    if (refreshBtn) {
                        const icon = refreshBtn.querySelector('i');
                        if (icon) {
                            icon.classList.add('fa-spin');
                            setTimeout(() => icon.classList.remove('fa-spin'), 1000);
                        }
                    }
                }
                
                const params = new URLSearchParams();
                const searchTerm = document.getElementById('searchInput').value.trim();
                const statusFilter = document.getElementById('statusFilter').value;
                const categoryFilter = document.getElementById('categoryFilter').value;

                if (statusFilter) params.set('status', statusFilter);
                if (categoryFilter) params.set('category', categoryFilter);
                if (searchTerm) params.set('q', searchTerm);

                const response = await apiRequest(`/api/complaints?${params.toString()}`);
                
                if (response.ok) {
                    allComplaints = await response.json();
                    displayComplaints(allComplaints);
                    updateStatistics(allComplaints);
                    
                    // Update last refresh time
                    updateLastRefreshTime();
                } else {
                    document.getElementById('complaintsContainer').innerHTML = 
                        '<div class="message error"><i class="fas fa-exclamation-triangle"></i> Failed to load complaints</div>';
                }
            } catch (error) {
                console.error('[COMPLAINTS] Load error:', error);
                
                document.getElementById('complaintsContainer').innerHTML = 
                    '<div class="message error"><i class="fas fa-wifi"></i> Connection error. Please refresh the page.</div>';
            }
        }

        // Update last refresh timestamp
        function updateLastRefreshTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            let refreshElement = document.getElementById('lastRefreshTime');
            if (!refreshElement) {
                // Create refresh indicator if it doesn't exist
                const headerTop = document.querySelector('.header-top');
                if (headerTop) {
                    refreshElement = document.createElement('div');
                    refreshElement.id = 'lastRefreshTime';
                    refreshElement.style.cssText = 'font-size: 0.75rem; color: var(--text-400); display: flex; align-items: center; gap: 6px;';
                    refreshElement.innerHTML = `<i class="fas fa-sync-alt" style="font-size: 0.7rem;"></i><span></span>`;
                    headerTop.appendChild(refreshElement);
                }
            }
            
            if (refreshElement) {
                const span = refreshElement.querySelector('span');
                if (span) {
                    span.textContent = `Updated: ${timeStr}`;
                    span.title = `Last updated on ${dateStr} at ${timeStr}`;
                }
            }
        }

        // Display complaints
        function displayComplaints(complaints) {
            const container = document.getElementById('complaintsContainer');
            // Ensure complaints is always an array
            complaints = Array.isArray(complaints) ? complaints : (complaints.complaints || []);
            if (complaints.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <div>No complaints found</div>
                        <small>Try adjusting your search filters</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button id="toggleAdminSelectionBtn" onclick="toggleAdminSelectionMode()" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <i class="fas fa-check-square"></i> Select Items
                    </button>
                    <button id="deleteAdminSelectedBtn" onclick="deleteAdminSelectedComplaints()" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: none; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <i class="fas fa-trash"></i> Delete Selected (<span id="adminSelectedCount">0</span>)
                    </button>
                    <button id="printAdminSelectedBtn" onclick="printAdminSelectedComplaints()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: none; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <i class="fas fa-print"></i> Print Selected (<span id="adminPrintCount">0</span>)
                    </button>
                    <button id="cancelAdminSelectionBtn" onclick="cancelAdminSelectionMode()" style="background: linear-gradient(135deg, #6b7280, #4b5563); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: none; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
                <table style="width: 100%; border-collapse: collapse; border-radius: 16px;">
                    <thead>
                        <tr style="border-bottom: 3px solid #FFD700;">
                            <th class="admin-checkbox-column" style="width: 50px; padding: 20px 16px; text-align: center; display: none;"><input type="checkbox" id="adminSelectAll" onchange="toggleAdminSelectAll(this)" style="cursor: pointer; width: 18px; height: 18px;"></th>
                            <th style="padding: 20px 16px; text-align: left; font-weight: 700; color: #00FFFF; font-size: 15px; text-transform: uppercase; letter-spacing: 1px; width: 80px;">ID</th>
                            <th style="padding: 20px 16px; text-align: left; font-weight: 700; color: #00FFFF; font-size: 15px; text-transform: uppercase; letter-spacing: 1px;">User Email</th>
                            <th style="padding: 20px 16px; text-align: left; font-weight: 700; color: #00FFFF; font-size: 15px; text-transform: uppercase; letter-spacing: 1px;">Type of Issue</th>
                            <th style="padding: 20px 16px; text-align: center; font-weight: 700; color: #00FFFF; font-size: 15px; text-transform: uppercase; letter-spacing: 1px;">Status</th>
                            <th style="padding: 20px 16px; text-align: center; font-weight: 700; color: #00FFFF; font-size: 15px; text-transform: uppercase; letter-spacing: 1px;">Media</th>
                            <th style="padding: 20px 16px; text-align: center; font-weight: 700; color: #00FFFF; font-size: 15px; text-transform: uppercase; letter-spacing: 1px;">Date Registered</th>
                            <th style="padding: 20px 16px; text-align: center; font-weight: 700; color: #00FFFF; font-size: 15px; text-transform: uppercase; letter-spacing: 1px;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${complaints.map((complaint, index) => `
                            <tr style="border-bottom: 2px solid rgba(192, 192, 192, 0.1);">
                                <td class="admin-checkbox-column" style="padding: 18px 16px; text-align: center; display: none;"><input type="checkbox" class="admin-complaint-checkbox" data-id="${complaint.id}" onchange="updateAdminDeleteButton()" style="cursor: pointer; width: 18px; height: 18px;"></td>
                                <td style="padding: 18px 16px; color: #FFD700; font-weight: 700; cursor: pointer; user-select: none;" onclick="toggleComplaintCheckbox(${complaint.id})" title="Click to select/unselect">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-hashtag" style="font-size: 12px; opacity: 0.7;"></i>
                                        <span>${complaint.id}</span>
                                    </div>
                                </td>
                                <td style="padding: 18px 16px; color: #C0C0C0; font-weight: 500;">
                                    <div style="display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="quickReply(${complaint.id})" title="Click to send message">
                                        <i class="fas fa-envelope" style="color: #FFD700; font-size: 16px;"></i>
                                        <span style="text-decoration: underline; text-decoration-style: dotted;">${complaint.email || 'Not provided'}</span>
                                    </div>
                                </td>
                                <td style="padding: 18px 16px; color: #C0C0C0; font-weight: 500; text-align: left;">
                                    ${complaint.category}
                                </td>
                                <td style="padding: 18px 16px; color: #C0C0C0; font-weight: 500; text-align: center;">
                                    ${complaint.status ? complaint.status.charAt(0).toUpperCase() + complaint.status.slice(1).replace('-', ' ') : 'Pending'}
                                </td>
                                <td style="padding: 16px; text-align: center;">
                                    ${(complaint.media_files && complaint.media_files.length > 0) || complaint.proof_path ? `
                                        <button onclick="toggleMedia(${complaint.id})" style="background: rgba(18, 0, 56, 0.3); border: 1px solid #2a1a60; padding: 8px 16px; border-radius: 8px; cursor: pointer; color: #FFD700; font-weight: 500; transition: all 0.2s;" 
                                            onmouseover="this.style.background='rgba(26, 10, 74, 0.5)'" 
                                            onmouseout="this.style.background='rgba(18, 0, 56, 0.3)'">
                                            <i class="fas fa-image"></i> View (${complaint.media_files ? complaint.media_files.length : 1})
                                        </button>
                                    ` : '<span style="color: var(--text-400); font-size: 13px;">No media</span>'}
                                </td>
                                <td style="padding: 16px; color: var(--text-200);">
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <span style="font-weight: 500;">${new Date(complaint.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                        <span style="font-size: 12px; color: var(--text-400);">${new Date(complaint.created_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</span>
                                    </div>
                                </td>
                                <td style="padding: 16px; text-align: center;">
                                    <div style="display: flex; gap: 8px; justify-content: center; align-items: center; position: relative;">
                                        <button onclick="viewComplaintDetails(${complaint.id})" title="View Details" style="background: linear-gradient(135deg, #120038, #1a0a4a); border: 2px solid white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; color: white; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" 
                                            onmouseover="this.style.background='linear-gradient(135deg, #1a0a4a, #2a1a60)'; this.style.borderColor='white'" 
                                            onmouseout="this.style.background='linear-gradient(135deg, #120038, #1a0a4a)'; this.style.borderColor='white'">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="quickReply(${complaint.id})" title="Message User" style="background: linear-gradient(135deg, #10B981, #059669); border: 2px solid #10B981; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; color: white; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" 
                                            onmouseover="this.style.background='linear-gradient(135deg, #059669, #047857)'; this.style.borderColor='#059669'" 
                                            onmouseout="this.style.background='linear-gradient(135deg, #10B981, #059669)'; this.style.borderColor='#10B981'">
                                            <i class="fas fa-comment"></i>
                                        </button>
                                        <button onclick="deleteComplaint(${complaint.id})" title="Delete" style="background: linear-gradient(135deg, #EF4444, #DC2626); border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; color: white; font-weight: 500; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" 
                                            onmouseover="this.style.background='linear-gradient(135deg, #F87171, #EF4444)'" 
                                            onmouseout="this.style.background='linear-gradient(135deg, #EF4444, #DC2626)'">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <div style="position: relative;">
                                            <button onclick="toggleComplaintMenu(${complaint.id}, event)" title="More Options" style="background: linear-gradient(135deg, #FFD700, #FFA500); border: 2px solid #FFD700; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; color: #21004B; font-weight: 700; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" 
                                                onmouseover="this.style.background='linear-gradient(135deg, #FFA500, #FF8C00)'; this.style.borderColor='#FFA500'" 
                                                onmouseout="this.style.background='linear-gradient(135deg, #FFD700, #FFA500)'; this.style.borderColor='#FFD700'">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <div id="menu-${complaint.id}" class="complaint-dropdown-menu" style="display: none; position: absolute; right: 0; top: 40px; background: #1a0a4a; border: 2px solid rgba(255, 215, 0, 0.6); border-radius: 12px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.2); min-width: 180px; z-index: 1000; overflow: hidden;">
                                                <button onclick="event.stopPropagation(); showInlineStatusUpdater(${complaint.id}, event); closeAllMenus()" style="width: 100%; padding: 12px 16px; border: none; background: transparent; color: #FFD700; text-align: left; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500;" onmouseover="this.style.background='rgba(255, 215, 0, 0.2)'; this.style.color='#FFFFFF'" onmouseout="this.style.background='transparent'; this.style.color='#FFD700'">
                                                    <i class="fas fa-exchange-alt" style="width: 16px;"></i>
                                                    <span>Change Status</span>
                                                </button>
                                                <button onclick="quickReply(${complaint.id}); event.stopPropagation(); closeAllMenus()" style="width: 100%; padding: 12px 16px; border: none; background: transparent; color: #FFD700; text-align: left; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500;" onmouseover="this.style.background='rgba(255, 215, 0, 0.2)'; this.style.color='#FFFFFF'" onmouseout="this.style.background='transparent'; this.style.color='#FFD700'">
                                                    <i class="fas fa-reply" style="width: 16px;"></i>
                                                    <span>Quick Reply</span>
                                                </button>
                                                <button onclick="sendMessage('${complaint.email}'); event.stopPropagation(); closeAllMenus()" style="width: 100%; padding: 12px 16px; border: none; background: transparent; color: #FFD700; text-align: left; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500;" onmouseover="this.style.background='rgba(255, 215, 0, 0.2)'; this.style.color='#FFFFFF'" onmouseout="this.style.background='transparent'; this.style.color='#FFD700'">
                                                    <i class="fas fa-envelope" style="width: 16px;"></i>
                                                    <span>Send Message</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            ${complaint.showMedia ? `
                            <tr id="media-${complaint.id}">
                                <td colspan="7" style="padding: 0;">
                                    <div style="padding: 20px; background: rgba(79, 70, 229, 0.04); border-top: 1px solid rgba(79, 70, 229, 0.1);">
                                        <h4 style="margin-bottom: 12px; color: var(--text-100); font-size: 14px; font-weight: 600;">
                                            <i class="fas fa-images" style="margin-right: 8px;"></i>Media Files
                                        </h4>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
                                            ${complaint.media_files ? complaint.media_files.map(file => `
                                                <div style="position: relative; border-radius: 8px; overflow: hidden; border: 1px solid rgba(0, 0, 0, 0.1);">
                                                    ${file && file.type && file.type.startsWith('image/') ? `
                                                        <img src="${file.url}" alt="Proof" style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;" onclick="window.open('${file.url}', '_blank')">
                                                    ` : file && file.type && file.type.startsWith('video/') ? `
                                                        <video controls style="width: 100%; height: 150px; object-fit: cover;">
                                                            <source src="${file.url}" type="${file.type}">
                                                        </video>
                                                    ` : `
                                                        <div style="width: 100%; height: 150px; display: flex; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.05);">
                                                            <i class="fas fa-file" style="font-size: 40px; color: #6B7280;"></i>
                                                        </div>
                                                    `}
                                                </div>
                                            `).join('') : complaint.proof_path ? `
                                                <div style="position: relative; border-radius: 8px; overflow: hidden; border: 1px solid rgba(0, 0, 0, 0.1);">
                                                    <img src="${complaint.proof_path}" alt="Proof" style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;" onclick="window.open('${complaint.proof_path}', '_blank')">
                                                </div>
                                            ` : '<div style="padding: 20px; text-align: center; color: #9ca3af;">No media attached</div>'}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            ` : ''}
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Update complaint status

        // Show quick reply form
        function showQuickReply(complaintId) {
            const replyForm = document.getElementById(`quick-reply-${complaintId}`);
            replyForm.style.display = 'block';
            replyForm.querySelector('textarea').focus();
        }

        // Hide quick reply form
        function hideQuickReply(complaintId) {
            const replyForm = document.getElementById(`quick-reply-${complaintId}`);
            replyForm.style.display = 'none';
            replyForm.querySelector('textarea').value = '';
        }

        // Send quick reply
        async function sendQuickReply(event, complaintId) {
            event.preventDefault();
            
            const form = event.target;
            const textarea = form.querySelector('textarea');
            const message = textarea.value.trim();

            if (!message) return;

            try {
                const response = await apiRequest(`/api/complaints/${complaintId}/messages`, 'POST', {
                    message: message
                });

                if (response.ok) {
                    showMessage('Message sent successfully!', 'success');
                    hideQuickReply(complaintId);
                    
                    // Refresh replies if they're expanded
                    if (expandedReplies.has(complaintId)) {
                        loadComplaintReplies(complaintId);
                    }
                } else {
                    showMessage('Failed to send message. Please try again.', 'error');
                }
            } catch (error) {
                showMessage('Connection error. Please try again.', 'error');
            }
        }

        // Toggle replies visibility
        async function toggleReplies(complaintId) {
            const repliesSection = document.getElementById(`replies-${complaintId}`);
            const isExpanded = expandedReplies.has(complaintId);

            if (isExpanded) {
                repliesSection.classList.remove('expanded');
                expandedReplies.delete(complaintId);
            } else {
                repliesSection.classList.add('expanded');
                expandedReplies.add(complaintId);
                await loadComplaintReplies(complaintId);
            }
        }

        // Load complaint replies
        async function loadComplaintReplies(complaintId) {
            const repliesContainer = document.getElementById(`replies-${complaintId}`);
            
            try {
                const response = await apiRequest(`/api/complaints/${complaintId}`);
                
                if (response.ok) {
                    const details = await response.json();
                    displayReplies(complaintId, details.replies || []);
                } else {
                    repliesContainer.innerHTML = '<div class="message error">Failed to load conversation</div>';
                }
            } catch (error) {
                repliesContainer.innerHTML = '<div class="message error">Connection error</div>';
            }
        }

        // Display replies
        function displayReplies(complaintId, replies) {
            const container = document.getElementById(`replies-${complaintId}`);
            
            if (replies.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 30px;">
                        <i class="fas fa-comment-slash"></i>
                        <div>No conversation yet</div>
                        <small>Use Quick Reply to start communicating with the user</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <h4 style="margin-bottom: 15px; color: #374151;">
                    <i class="fas fa-comments"></i> Conversation Thread
                </h4>
                ${replies.map(reply => `
                    <div class="reply-item">
                        <div class="reply-header">
                            <span class="reply-sender">
                                <i class="fas fa-${reply.sender === 'Admin' ? 'user-shield' : 'user'}"></i>
                                ${reply.sender}
                            </span>
                            <span class="reply-time">
                                ${new Date(reply.created_at).toLocaleDateString('en-US', {
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </span>
                        </div>
                        <div class="reply-message">${reply.message}</div>
                    </div>
                `).join('')}
            `;
        }

        // Update statistics
        function updateStatistics(complaints) {
            // Ensure complaints is always an array
            complaints = Array.isArray(complaints) ? complaints : (complaints.complaints || []);
            const total = complaints.length;
            const pending = complaints.filter(c => c.status === 'pending').length;
            const inProgress = complaints.filter(c => c.status === 'in_progress').length;
            const resolved = complaints.filter(c => c.status === 'resolved').length;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('inProgressCount').textContent = inProgress;
            document.getElementById('resolvedCount').textContent = resolved;
        }

        // Show message
        function showMessage(text, type) {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML = `
                <div class="message ${type}" style="position: relative; display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                        <span>${text}</span>
                    </div>
                    <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; font-size: 20px; cursor: pointer; opacity: 0.7; padding: 0 5px; line-height: 1;" title="Close">&times;</button>
                </div>
            `;
        }

        // Show custom confirmation modal
        function showConfirmModal(title, message) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.id = 'dynamicConfirmModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                
                modal.innerHTML = `
                    <div style="background: #2a1a60; padding: 30px; border-radius: 16px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.2);">
                        <h3 style="margin: 0 0 15px 0; color: white; font-size: 1.4rem;">${title}</h3>
                        <p style="margin: 0 0 25px 0; color: rgba(255, 255, 255, 0.9); line-height: 1.6;">${message}</p>
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button id="cancelBtn" style="background: #6b7280; color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">Cancel</button>
                            <button id="confirmBtn" style="background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">Delete</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                const confirmBtn = modal.querySelector('#confirmBtn');
                const cancelBtn = modal.querySelector('#cancelBtn');
                
                confirmBtn.onclick = () => {
                    document.body.removeChild(modal);
                    resolve(true);
                };
                
                cancelBtn.onclick = () => {
                    document.body.removeChild(modal);
                    resolve(false);
                };
                
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                        resolve(false);
                    }
                };
            });
        }
        window.showConfirmModal = showConfirmModal;
        
        // Close confirm modal
        function closeConfirmModal() {
            const modal = document.getElementById('dynamicConfirmModal') || document.getElementById('confirmModal');
            if (modal) {
                modal.remove();
            }
        }
        window.closeConfirmModal = closeConfirmModal;

        // Close assignment banner
        function closeAssignmentBanner() {
            const banner = document.getElementById('assignmentInfoBanner');
            if (!banner) return; // Element removed from HTML
            banner.style.animation = 'slideUp 0.3s ease';
            setTimeout(() => {
                banner.style.display = 'none';
                banner.style.animation = 'slideDown 0.3s ease';
            }, 300);
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', debounce(loadComplaints, 500));
        document.getElementById('statusFilter').addEventListener('change', loadComplaints);
        document.getElementById('categoryFilter').addEventListener('change', loadComplaints);
        document.getElementById('refreshBtn').addEventListener('click', function() {
            // Add spin animation to refresh button
            const icon = this.querySelector('i');
            icon.style.animation = 'spin 0.6s ease';
            setTimeout(() => {
                icon.style.animation = '';
            }, 600);
            loadComplaints();
        });

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Load admin assignments
        async function loadAdminAssignments() {
            try {
                // Use the admin-specific endpoint for own assignments
                const response = await apiRequest('/api/my-assignments');
                if (response.ok) {
                    const assignments = await response.json();
                    
                    if (assignments && assignments.length > 0) {
                        const banner = document.getElementById('assignmentInfoBanner');
                        const details = document.getElementById('assignmentDetails');
                        const stats = document.getElementById('assignmentStats');
                        
                        // Check if elements exist (may have been removed from HTML)
                        if (!banner || !details || !stats) {
                            console.log('Assignment banner elements not found in HTML');
                            return;
                        }
                        
                        // Show unique districts and routes (no buses)
                        const districts = [...new Set(assignments.map(a => a.district_name).filter(Boolean))];
                        const routes = [...new Set(assignments.map(a => a.route_name).filter(Boolean))];
                        
                        details.innerHTML = `You are assigned to <strong>${districts.length} district(s)</strong> and <strong>${routes.length} route(s)</strong>`;
                        
                        stats.innerHTML = `
                            <div style="background: rgba(255, 255, 255, 0.2); padding: 8px 15px; border-radius: 8px; margin-bottom: 5px;">
                                <i class="fas fa-building"></i> <strong>Districts:</strong> ${districts.join(', ') || 'None assigned'}
                            </div>
                            <div style="background: rgba(255, 255, 255, 0.2); padding: 8px 15px; border-radius: 8px;">
                                <i class="fas fa-route"></i> <strong>Routes:</strong> ${routes.join(', ') || 'None assigned'}
                            </div>
                        `;
                        
                        banner.style.display = 'block';
                    }
                } else {
                    console.log('Could not load assignments, status:', response.status);
                }
            } catch (error) {
                console.error('Failed to load admin assignments:', error);
            }
        }

        // Toggle dropdown menu
        function toggleDropdown(complaintId) {
            const dropdown = document.getElementById(`dropdown-${complaintId}`);
            const allDropdowns = document.querySelectorAll('.dropdown-menu');
            
            // Close all other dropdowns
            allDropdowns.forEach(d => {
                if (d !== dropdown) d.classList.remove('show');
            });
            
            dropdown.classList.toggle('show');
        }

        // Toggle media visibility

        // Delete complaint
        // Toggle complaint dropdown menu

        // Close all dropdown menus

        // Quick reply function - show inline message box
        
        // Send quick reply message

        // Show inline status updater
        async function showInlineStatusUpdater(complaintId, event) {
            // Stop event propagation immediately
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            // Find the complaint row
            const rows = document.querySelectorAll('tbody tr');
            let targetRow = null;
            for (let row of rows) {
                if (row.innerHTML.includes(`viewComplaintDetails(${complaintId})`)) {
                    targetRow = row;
                    break;
                }
            }
            
            if (!targetRow) return;
            
            // Check if status updater already exists
            const existingBox = document.getElementById(`status-updater-${complaintId}`);
            if (existingBox) {
                existingBox.remove();
                return;
            }
            
            // Get current status
            const response = await apiRequest(`/api/complaints/${complaintId}`);
            if (!response.ok) return;
            const complaint = await response.json();
            
            // Create status updater row
            const updaterRow = document.createElement('tr');
            updaterRow.id = `status-updater-${complaintId}`;
            updaterRow.innerHTML = `
                <td colspan="7" style="padding: 0; background: #000000;">
                    <div style="padding: 20px; border-top: 2px solid #808080; border-bottom: 2px solid #808080; background: #000000;">
                        <div style="margin-bottom: 12px; color: #00FFFF; font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-exchange-alt" style="margin-right: 8px;"></i>Update Status for Complaint #${complaintId}</span>
                            <button onclick="document.getElementById('status-updater-${complaintId}').remove(); event.stopPropagation()" style="background: transparent; border: 2px solid #808080; color: #fff; cursor: pointer; font-size: 16px; width: 32px; height: 32px; border-radius: 4px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='#1a1a1a'" onmouseout="this.style.background='transparent'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <label style="color: #C0C0C0; font-weight: 500;">Select Status:</label>
                            <select id="new-status-${complaintId}" style="padding: 10px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; background: rgba(255, 255, 255, 0.2); border: 2px solid white; color: white; cursor: pointer; outline: none;">
                                <option value="pending" ${complaint.status === 'pending' ? 'selected' : ''} style="background: #1a0a4a; color: white;">Pending</option>
                                <option value="in_progress" ${complaint.status === 'in_progress' ? 'selected' : ''} style="background: #1a0a4a; color: white;">In Progress</option>
                                <option value="resolved" ${complaint.status === 'resolved' ? 'selected' : ''} style="background: #1a0a4a; color: white;">Resolved</option>
                            </select>
                            <button onclick="updateStatusInline(${complaintId}); event.stopPropagation()" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <i class="fas fa-check" style="margin-right: 8px;"></i>Update Status
                            </button>
                            <button onclick="document.getElementById('status-updater-${complaintId}').remove(); event.stopPropagation()" style="background: linear-gradient(135deg, #6b7280, #4b5563); color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <i class="fas fa-times" style="margin-right: 8px;"></i>Cancel
                            </button>
                        </div>
                    </div>
                </td>
            `;
            
            // Insert after the target row
            targetRow.parentNode.insertBefore(updaterRow, targetRow.nextSibling);
            
            // Prevent immediate closure by setting a protection flag
            updaterRow.setAttribute('data-just-created', 'true');
            setTimeout(() => {
                updaterRow.removeAttribute('data-just-created');
            }, 100);
        }
        window.showInlineStatusUpdater = showInlineStatusUpdater;
        
        // Update status inline
        async function updateStatusInline(complaintId) {
            const selectElement = document.getElementById(`new-status-${complaintId}`);
            if (!selectElement) {
                console.error('Status select element not found');
                return;
            }
            
            const newStatus = selectElement.value;
            const token = localStorage.getItem('token');
            
            if (!token) {
                showMessage('You are not logged in. Please refresh and login again.', 'error');
                return;
            }
            
            try {
                console.log(`Updating complaint ${complaintId} to status: ${newStatus}`);
                
                const response = await fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/complaints/${complaintId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    showMessage('Status updated successfully!', 'success');
                    const updaterElement = document.getElementById(`status-updater-${complaintId}`);
                    if (updaterElement) {
                        updaterElement.remove();
                    }
                    await loadComplaints(); // Real-time refresh
                } else if (response.status === 401) {
                    showMessage('Session expired. Please login again.', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    let errorMsg = 'Failed to update status';
                    try {
                        const errorData = await response.json();
                        if (errorData && errorData.error) errorMsg = errorData.error;
                    } catch (e) {}
                    showMessage(errorMsg, 'error');
                    console.error('Update failed:', errorMsg);
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showMessage('Connection error. Please check your internet connection.', 'error');
            }
        }
        window.updateStatusInline = updateStatusInline;

        // Alias for submitInlineStatus
        async function submitInlineStatus(complaintId) {
            return await updateStatusInline(complaintId);
        }
        window.submitInlineStatus = submitInlineStatus;

        // Send message function

        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            // Don't close menus if clicking inside a menu or opening modal/inline forms
            const clickedElement = event.target;
            const isInsideMenu = clickedElement.closest('.complaint-dropdown-menu');
            const isMenuButton = clickedElement.closest('button[onclick*="toggleComplaintMenu"]');
            const isInsideStatusUpdater = clickedElement.closest('[id^="status-updater-"]');
            const isInsideQuickReply = clickedElement.closest('[id^="quick-reply-"]');
            const isInsideModal = clickedElement.closest('.message-modal-overlay');
            const isStatusButton = clickedElement.closest('button[onclick*="showInlineStatusUpdater"]');
            
            // Check if any status updater was just created (protection period)
            const justCreatedUpdater = document.querySelector('[data-just-created="true"]');
            
            // Only close menus when clicking outside all these areas and no protected elements
            if (!isInsideMenu && !isMenuButton && !isInsideStatusUpdater && !isInsideQuickReply && !isInsideModal && !isStatusButton && !justCreatedUpdater) {
                closeAllMenus();
            }
        });

        
        // Helper function to get API base URL
        function getAPIBase() {
            if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
                return 'http://127.0.0.1:5000';
            } else if (window.location.hostname.includes('github.io')) {
                return 'https://servonix-bus-complaint-management-system.onrender.com';
            } else {
                return `http://${window.location.hostname}:5000`;
            }
        }

        // API Request helper function
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const token = localStorage.getItem('token');
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (body && method !== 'GET') {
                options.body = JSON.stringify(body);
            }
            
            const url = `${getAPIBase()}${endpoint}`;
            return await fetch(url, options);
        }

async function deleteComplaint(complaintId) {
            // Show custom confirmation modal
            const confirmed = await showConfirmModal(
                'Delete Complaint',
                'Are you sure you want to delete this complaint? This action cannot be undone.'
            );
            
            if (!confirmed) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${getAPIBase()}/api/complaints/${complaintId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showMessage('Complaint deleted successfully!', 'success');
                    await loadComplaints(); // Refresh the list with real-time update
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showMessage(errorData.error || 'Failed to delete complaint. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error deleting complaint:', error);
                showMessage('Connection error. Please try again.', 'error');
            }
        }
        window.deleteComplaint = deleteComplaint;

        // Admin selection mode functionality
        let adminSelectionModeActive = false;





        // Toggle checkbox when clicking ID column
        function toggleComplaintCheckbox(complaintId) {
            const checkbox = document.querySelector(`.admin-complaint-checkbox[data-id="${complaintId}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateAdminDeleteButton();
            }
        }
        window.toggleComplaintCheckbox = toggleComplaintCheckbox;



        // Export complaint
        function exportComplaint(complaintId) {
            const complaint = document.querySelector(`[data-id="${complaintId}"]`);
            if (complaint) {
                const complaintData = complaint.innerText;
                const blob = new Blob([complaintData], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `complaint_${complaintId}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        // Save resolution notes
        async function saveResolutionNotes(complaintId) {
            const textarea = document.getElementById(`resolution-text-${complaintId}`);
            const resolutionNotes = textarea.value.trim();
            
            try {
                const response = await apiRequest(`/api/complaints/${complaintId}`, 'PUT', {
                    resolution_notes: resolutionNotes
                });
                
                if (response.ok) {
                    showMessage('Resolution notes saved successfully!', 'success');
                } else {
                    showMessage('Failed to save resolution notes. Please try again.', 'error');
                }
            } catch (error) {
                showMessage('Connection error. Please try again.', 'error');
            }
        }

        // Update status function - show/hide resolution notes based on status
        const originalUpdateStatus = updateStatus;
        async function updateStatus(complaintId) {
            // Validate status
            const validStatuses = ['pending', 'in_progress', 'resolved'];
            const statusSelect = document.getElementById(`status-${complaintId}`);
            const newStatus = statusSelect.value;
            if (!validStatuses.includes(newStatus)) {
                showMessage(' Invalid status. Must be: pending, in_progress, or resolved', 'error');
                return;
            }

            const resolutionNotesDiv = document.getElementById(`resolution-notes-${complaintId}`);
            
            try {
                const response = await apiRequest(`/api/complaints/${complaintId}`, 'PUT', {
                    status: newStatus
                });

                if (response.ok) {
                    showMessage('Status updated successfully!', 'success');
                    
                    // Show resolution notes field if status is resolved
                    if (newStatus === 'resolved') {
                        resolutionNotesDiv.style.display = 'block';
                    }
                    
                    loadComplaints(); // Refresh the list
                } else {
                    showMessage('Failed to update status. Please try again.', 'error');
                }
            } catch (error) {
                showMessage('Connection error. Please try again.', 'error');
            }
        }

        // Update complaint status from modal dropdown

        // Theme Toggle Button Functionality

        // Update complaint status from modal dropdown
        async function updateComplaintStatus(complaintId, newStatus) {
            // Validate status
            const validStatuses = ['pending', 'in_progress', 'resolved'];
            if (!validStatuses.includes(newStatus)) {
                showMessage(' Invalid status. Must be: pending, in_progress, or resolved', 'error');
                return;
            }

            try {
                const response = await apiRequest(`/api/complaints/${complaintId}`, 'PUT', {
                    status: newStatus
                });

                if (response.ok) {
                    showMessage('Status updated successfully!', 'success');
                    await loadComplaints(); // Refresh the list immediately
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showMessage(errorData.error || 'Failed to update status. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showMessage('Connection error. Please try again.', 'error');
            }
        }

        // DUPLICATE FUNCTIONS REMOVED - Using only the first occurrence above
        
        // Quick reply function for admin - with modal UI
        function quickReply(complaintId) {
            console.log('[ADMIN] quickReply:', complaintId);
            
            // Remove existing modal if any
            const existingModal = document.getElementById('quickReplyModal');
            if (existingModal) existingModal.remove();
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'quickReplyModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a0a4a, #2a1a60); padding: 30px; border-radius: 16px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 2px solid rgba(255,215,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #FFD700; font-size: 1.3rem;"><i class="fas fa-reply" style="margin-right: 10px;"></i>Quick Reply - Complaint #${complaintId}</h3>
                        <button onclick="document.getElementById('quickReplyModal').remove()" style="background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; opacity: 0.7;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
                    </div>
                    <textarea id="quickReplyMessage" placeholder="Enter your reply message..." style="width: 100%; height: 150px; padding: 15px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-size: 14px; resize: vertical; outline: none; box-sizing: border-box;" onfocus="this.style.borderColor='#FFD700'" onblur="this.style.borderColor='rgba(255,255,255,0.2)'"></textarea>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="document.getElementById('quickReplyModal').remove()" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">Cancel</button>
                        <button onclick="submitQuickReply(${complaintId})" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'"><i class="fas fa-paper-plane" style="margin-right: 8px;"></i>Send Reply</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('quickReplyMessage').focus();
            
            // Close on backdrop click
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        window.quickReply = quickReply;
        
        // Submit quick reply from modal
        function submitQuickReply(complaintId) {
            const textarea = document.getElementById('quickReplyMessage');
            const message = textarea ? textarea.value.trim() : '';
            
            if (!message) {
                showMessage('Please enter a reply message', 'warning');
                textarea.focus();
                return;
            }
            
            const modal = document.getElementById('quickReplyModal');
            if (modal) modal.remove();
            
            sendQuickReplyMessage(complaintId, message);
        }
        window.submitQuickReply = submitQuickReply;
        
        async function sendQuickReplyMessage(complaintId, message) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showMessage('Authentication required. Please login again.', 'error');
                    return;
                }
                
                const response = await fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/complaints/${complaintId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        message: message
                    })
                });
                
                if (response.ok) {
                    showMessage('Reply sent successfully!', 'success');
                    loadComplaints(); // Refresh the list
                } else {
                    const errorData = await response.json();
                    showMessage(errorData.error || 'Failed to send reply. Please try again.', 'error');
                }
            } catch (error) {
                console.error('[ADMIN] Reply error:', error);
                showMessage('Connection error. Please try again.', 'error');
            }
        }
        window.sendQuickReplyMessage = sendQuickReplyMessage;

        // Make functions globally available
        window.updateStatus = updateStatus;
        window.updateComplaintStatus = updateComplaintStatus;
        window.showQuickReply = showQuickReply;
        window.hideQuickReply = hideQuickReply;
        window.sendQuickReply = sendQuickReply;
        window.toggleReplies = toggleReplies;
        window.saveResolutionNotes = saveResolutionNotes;
        window.quickReply = quickReply;
        window.sendQuickReplyMessage = sendQuickReplyMessage;
        window.showInlineStatusUpdater = showInlineStatusUpdater;
        window.updateStatusInline = updateStatusInline;
        window.submitInlineStatus = submitInlineStatus;
        // viewComplaintDetails is already exposed in its defining script block

        // Initialize dashboard
        loadDynamicProfile(); // Load dynamic profile first
        loadAdminInfo();
        loadAdminAssignments();
        loadComplaints();

        // Auto-refresh every 10 seconds for real-time updates
        setInterval(() => {
            console.log('[AUTO-REFRESH] Updating complaints data...');
            loadComplaints();
        }, 10000);

        // Refresh stats every 5 seconds
        setInterval(() => {
            console.log('[AUTO-REFRESH] Updating statistics...');
            updateStats();
        }, 5000);

        // Function to update statistics
        async function updateStats() {
            try {
                const response = await apiRequest('/api/complaints');
                if (response.ok) {
                    let complaints = await response.json();
                    complaints = Array.isArray(complaints) ? complaints : (complaints.complaints || []);
                    const pending = complaints.filter(c => c.status === 'pending').length;
                    const inProgress = complaints.filter(c => c.status === 'in_progress').length;
                    const resolved = complaints.filter(c => c.status === 'resolved').length;
                    // Update stat cards with animation
                    updateStatCard('pendingCount', pending);
                    updateStatCard('inProgressCount', inProgress);
                    updateStatCard('resolvedCount', resolved);
                    updateStatCard('totalCount', complaints.length);
                }
            } catch (error) {
                console.error('[STATS] Update error:', error);
            }
        }

        // Animate stat card updates
        function updateStatCard(id, newValue) {
            const element = document.getElementById(id);
            if (element && element.textContent !== newValue.toString()) {
                element.style.opacity = '0.5';
                setTimeout(() => {
                    element.textContent = newValue;
                    element.style.opacity = '1';
                }, 150);
            }
        }

        // Show loader on page load/reload
        function showDashboardLoader() {
            const loader = document.getElementById('dashboardLoader');
            loader.style.display = 'flex';
            loader.classList.remove('hidden');
        }

        // Hide dashboard loader after content is loaded
        function hideDashboardLoader() {
            setTimeout(function() {
                const loader = document.getElementById('dashboardLoader');
                loader.classList.add('hidden');
                setTimeout(function() {
                    loader.style.display = 'none';
                }, 500);
            }, 800);
        }

        // Show loader on every page load/reload
        window.addEventListener('load', function() {
            hideDashboardLoader();
        });

        // Show loader when page is about to reload
        window.addEventListener('beforeunload', function() {
            showDashboardLoader();
        });

        // Show loader on page visibility change (tab switch back)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                showDashboardLoader();
                hideDashboardLoader();
            }
        });

        // Make loader function globally available for manual triggers
        window.showDashboardLoader = showDashboardLoader;
        window.hideDashboardLoader = hideDashboardLoader;

        // Media Modal Functions
        function openMediaModal(src, type, filename) {
            const modal = document.getElementById('mediaModal');
            const modalContent = document.getElementById('mediaModalContent');
            const modalTitle = document.getElementById('mediaModalTitle');
            
            modalTitle.textContent = filename || 'Attachment';
            // Guard against unresolved template placeholders like "${src}"
            if (!src || (typeof src === 'string' && src.indexOf('${') !== -1)) {
                modalContent.innerHTML = `
                    <div style="width: 100%; height: 60vh; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 8px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 40px; color: #ef4444;"></i>
                        <div style="color: #ef4444;">Media source unavailable</div>
                    </div>`;
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                return;
            }
            
            if (type === 'image') {
                modalContent.innerHTML = `<img src="${src}" style="max-width: 100%; max-height: 80vh; border-radius: 8px;" alt="${filename}">`;
            } else if (type === 'video') {
                modalContent.innerHTML = `<video controls style="width: 100%; height: 80vh; border-radius: 8px; max-height: 80vh;">
                    <source src="${src}" type="${type || 'video/mp4'}">
                </video>`;
            }
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeMediaModal() {
            const modal = document.getElementById('mediaModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }
        
        window.openMediaModal = openMediaModal;
        window.closeMediaModal = closeMediaModal;

        // Notification Bar for Admin
        class AdminNotificationBar {
            constructor() {
                this.activeDropdown = null;
                this.updateInterval = null;
                this.notifications = [];
                this.init();
            }

            init() {
                document.querySelectorAll('.notification-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleDropdown(item.dataset.type);
                        this.markAsRead();
                    });
                });

                document.addEventListener('click', () => this.closeAllDropdowns());
                document.querySelectorAll('.notification-dropdown').forEach(dropdown => {
                    dropdown.addEventListener('click', (e) => e.stopPropagation());
                });

                this.updateCounts();
                this.updateInterval = setInterval(() => this.updateCounts(), 10000);
            }

            toggleDropdown(type) {
                const dropdown = document.getElementById(`${type}Dropdown`);
                if (this.activeDropdown === type) {
                    this.closeAllDropdowns();
                    return;
                }
                this.closeAllDropdowns();
                dropdown.classList.add('active');
                this.activeDropdown = type;
                this.loadDropdownContent(type);
            }

            closeAllDropdowns() {
                document.querySelectorAll('.notification-dropdown').forEach(d => d.classList.remove('active'));
                this.activeDropdown = null;
            }

            markAsRead() {
                this.updateBadge('notificationBadge', 0);
                localStorage.setItem('lastAdminNotificationRead', Date.now());
            }

            async updateCounts() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) return;

                    let totalCount = 0;
                    this.notifications = [];
                    const lastRead = parseInt(localStorage.getItem('lastAdminNotificationRead')) || 0;

                    const response = await fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/complaints`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const complaints = data.complaints || [];
                        
                        complaints.forEach(complaint => {
                            const complaintTime = new Date(complaint.created_at).getTime();
                            
                            // New complaints assigned to admin
                            if (complaintTime > lastRead && complaint.status === 'pending') {
                                this.notifications.push({
                                    type: 'new_complaint',
                                    title: `New Complaint Assigned #${complaint.id}`,
                                    subtitle: `${complaint.category} - ${complaint.district_name || 'District'}`,
                                    time: complaint.created_at
                                });
                                totalCount++;
                            }
                            
                            // Status updates
                            if (complaint.updated_at) {
                                const updateTime = new Date(complaint.updated_at).getTime();
                                if (updateTime > lastRead && updateTime !== complaintTime) {
                                    this.notifications.push({
                                        type: 'status_update',
                                        title: `Complaint #${complaint.id} Updated`,
                                        subtitle: `Status: ${complaint.status}`,
                                        time: complaint.updated_at
                                    });
                                    totalCount++;
                                }
                            }
                            
                            // New replies/feedback
                            if (complaint.replies && complaint.replies.length > 0) {
                                complaint.replies.forEach(reply => {
                                    const replyTime = new Date(reply.created_at).getTime();
                                    if (replyTime > lastRead) {
                                        this.notifications.push({
                                            type: 'reply',
                                            title: `New Reply on #${complaint.id}`,
                                            subtitle: reply.message?.substring(0, 50) + '...',
                                            time: reply.created_at
                                        });
                                        totalCount++;
                                    }
                                });
                            }
                        });
                    }

                    // Check for new district assignments
                    try {
                        const assignmentResponse = await fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/my-assignments`, {
                            headers: { 'Authorization': 'Bearer ' + token }
                        });
                        if (assignmentResponse.ok) {
                            const assignData = await assignmentResponse.json();
                            // Response is an array directly
                            const assignments = Array.isArray(assignData) ? assignData : (assignData.assignments || []);
                            assignments.forEach(assignment => {
                                const assignTime = new Date(assignment.created_at).getTime();
                                if (assignTime > lastRead) {
                                    this.notifications.push({
                                        type: 'district_assigned',
                                        title: 'New District Assigned',
                                        subtitle: assignment.district_name,
                                        time: assignment.created_at
                                    });
                                    totalCount++;
                                }
                            });
                        }
                    } catch (e) {}
                    
                    this.updateBadge('notificationBadge', totalCount);

                } catch (error) {
                    console.error('Error updating notification counts:', error);
                }
            }

            updateBadge(badgeId, count) {
                const badge = document.getElementById(badgeId);
                if (!badge) return;
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = count > 0 ? 'flex' : 'none';
                if (count > 0 && badgeId === 'notificationBadge') badge.classList.add('pulse');
                else badge.classList.remove('pulse');
            }

            async loadDropdownContent(type) {
                const content = document.getElementById(`${type}Content`);
                const token = localStorage.getItem('token');

                if (type === 'notifications') {
                    if (this.notifications.length === 0) {
                        content.innerHTML = '<div class="dropdown-empty"><i class="fas fa-bell-slash"></i><p>No new notifications</p></div>';
                    } else {
                        content.innerHTML = this.notifications.map(notif => {
                            let icon = 'fa-bell';
                            let color = '#FFD700';
                            
                            if (notif.type === 'new_complaint') {
                                icon = 'fa-exclamation-circle';
                                color = '#f59e0b';
                            } else if (notif.type === 'status_update') {
                                icon = 'fa-sync-alt';
                                color = '#3b82f6';
                            } else if (notif.type === 'reply') {
                                icon = 'fa-comment';
                                color = '#10b981';
                            } else if (notif.type === 'district_assigned') {
                                icon = 'fa-map-marker-alt';
                                color = '#8b5cf6';
                            }
                            
                            return `
                                <div class="dropdown-item">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <i class="fas ${icon}" style="color: ${color}; font-size: 20px;"></i>
                                        <div style="flex: 1;">
                                            <div class="dropdown-item-title">${notif.title}</div>
                                            <div class="dropdown-item-subtitle">${notif.subtitle}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                } else if (type === 'complaints') {
                    try {
                        const response = await fetch(`${window.API_BASE || 'http://127.0.0.1:5000'}/api/complaints`, {
                            headers: { 'Authorization': 'Bearer ' + token }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            const complaints = data.complaints?.slice(0, 5) || [];
                            content.innerHTML = complaints.length === 0 ? 
                                '<div class=\"dropdown-empty\"><i class=\"fas fa-inbox\"></i><p>No complaints assigned</p></div>' :
                                complaints.map(c => `
                                    <div class=\"dropdown-item\">
                                        <div class=\"dropdown-item-title\">#${c.id} - ${c.category}</div>
                                        <div class=\"dropdown-item-subtitle\">
                                            <span class=\"status-badge status-${c.status}\">${c.status}</span>
                                            ${new Date(c.created_at).toLocaleDateString()}
                                        </div>
                                    </div>
                                `).join('');
                        }
                    } catch (error) {
                        content.innerHTML = '<div class=\"dropdown-empty\"><i class=\"fas fa-exclamation-triangle\"></i><p>Error loading data</p></div>';
                    }
                } else if (type === 'activity') {
                    content.innerHTML = `
                        <div class=\"dropdown-item\">
                            <div class=\"dropdown-item-title\">Recent Activity</div>
                            <div class=\"dropdown-item-subtitle\">View your admin actions</div>
                        </div>
                    `;
                } else if (type === 'notifications') {
                    content.innerHTML = '<div class=\"dropdown-item\"><div class=\"dropdown-item-title\">System Active</div><div class=\"dropdown-item-subtitle\">All systems operational</div></div>';
                } else {
                    content.innerHTML = '<div class=\"dropdown-empty\"><i class=\"fas fa-envelope-open\"></i><p>No messages</p></div>';
                }
            }
        }

        const adminNotificationBar = new AdminNotificationBar();

        // Admin Profile Dropdown Functions
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('profileDropdown');
            const container = document.querySelector('.profile-dropdown-container');
            if (dropdown && container && !container.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Trigger photo upload
        function triggerPhotoUpload() {
            document.getElementById('profilePhotoInput').click();
        }

        // Handle photo upload
        document.getElementById('profilePhotoInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Image must be less than 5MB', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                showToast('Uploading photo...', 'info');
                
                const response = await fetch(`${API_BASE}/api/user/profile-picture`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showToast('Profile photo updated!', 'success');
                    // Reload profile to show new photo
                    loadAdminProfile();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to upload photo', 'error');
                }
            } catch (error) {
                console.error('Error uploading photo:', error);
                showToast('Failed to upload photo', 'error');
            }
            
            // Reset input
            e.target.value = '';
        });

        // Show change password modal
        function showChangePasswordModal() {
            // Close profile dropdown
            document.getElementById('profileDropdown').classList.remove('show');
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'changePasswordModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #00FFFF, #00CED1); color: #000;">
                        <h3><i class="fas fa-key"></i> Change Password</h3>
                        <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 25px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-100);">Current Password</label>
                            <input type="password" id="currentPassword" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: var(--bg-800); color: var(--text-100);" placeholder="Enter current password">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-100);">New Password</label>
                            <input type="password" id="newPassword" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: var(--bg-800); color: var(--text-100);" placeholder="Enter new password (min 6 chars)">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-100);">Confirm New Password</label>
                            <input type="password" id="confirmPassword" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: var(--bg-800); color: var(--text-100);" placeholder="Confirm new password">
                        </div>
                        <button onclick="submitPasswordChange()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #00FFFF, #00CED1); color: #000; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px;">
                            <i class="fas fa-check"></i> Update Password
                        </button>
                    </div>
                </div>
            `;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            document.body.appendChild(modal);
        }

        // Submit password change
        async function submitPasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('New password must be at least 6 characters', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('New passwords do not match', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/user/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                if (response.ok) {
                    showToast('Password changed successfully!', 'success');
                    document.getElementById('changePasswordModal').remove();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to change password', 'error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showToast('Failed to change password', 'error');
            }
        }

        // Logout from all devices
        async function logoutAllDevices() {
            if (!confirm('This will log you out from all devices including this one. Continue?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/user/logout-all-devices`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    showToast('Logged out from all devices', 'success');
                    setTimeout(() => {
                        localStorage.clear();
                        window.location.href = 'login.html';
                    }, 1500);
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to logout', 'error');
                }
            } catch (error) {
                console.error('Error logging out:', error);
                showToast('Failed to logout from all devices', 'error');
            }
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            // Remove existing toast if any
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            
            let icon = 'info-circle';
            let bgColor = '#2196F3';
            if (type === 'success') { icon = 'check-circle'; bgColor = '#4CAF50'; }
            else if (type === 'error') { icon = 'exclamation-circle'; bgColor = '#f44336'; }
            else if (type === 'warning') { icon = 'exclamation-triangle'; bgColor = '#ff9800'; }
            
            toast.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 14px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 100000;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 500;
                animation: slideIn 0.3s ease;
                max-width: 350px;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Load admin profile data
        async function loadAdminProfile() {
            try {
                const response = await fetch(`${API_BASE}/api/profile`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const profile = await response.json();
                    
                    // Update profile dropdown
                    const userName = profile.name || localStorage.getItem('userName') || 'Admin';
                    document.getElementById('profileName').textContent = userName;
                    document.getElementById('profileEmail').textContent = profile.email || '';
                    document.getElementById('profileRole').textContent = profile.role || 'Admin';
                    document.getElementById('userName').textContent = userName;
                    
                    // Update avatar with photo or initial
                    const initial = userName.charAt(0).toUpperCase();
                    document.getElementById('profileInitial').textContent = initial;
                    
                    if (profile.profile_pic) {
                        const apiHost = typeof API_BASE !== 'undefined' ? API_BASE : (window.API_BASE || 'http://127.0.0.1:5000');
                        const imgUrl = profile.profile_pic.startsWith('http') 
                            ? profile.profile_pic 
                            : (profile.profile_pic.startsWith('/') ? `${apiHost}${profile.profile_pic}` : `${apiHost}/${profile.profile_pic}`);
                        
                        // Update small avatar
                        document.getElementById('userAvatar').innerHTML = `<img src="${imgUrl}" alt="Profile">`;
                        // Update large avatar in dropdown
                        document.getElementById('profileAvatarLarge').innerHTML = `
                            <img src="${imgUrl}" alt="Profile">
                            <div class="upload-overlay"><i class="fas fa-camera"></i> Change</div>
                        `;
                    } else {
                        document.getElementById('userAvatar').textContent = initial;
                    }
                    
                    // Format and display last login time
                    if (profile.last_active) {
                        const lastLogin = new Date(profile.last_active);
                        const now = new Date();
                        const diffMs = now - lastLogin;
                        const diffMins = Math.floor(diffMs / 60000);
                        const diffHours = Math.floor(diffMs / 3600000);
                        const diffDays = Math.floor(diffMs / 86400000);
                        
                        let timeAgo;
                        if (diffMins < 1) timeAgo = 'Just now';
                        else if (diffMins < 60) timeAgo = `${diffMins} min ago`;
                        else if (diffHours < 24) timeAgo = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                        else if (diffDays < 7) timeAgo = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                        else timeAgo = lastLogin.toLocaleDateString();
                        
                        document.getElementById('lastLoginTime').textContent = timeAgo;
                    }
                    
                    // Display assigned districts and routes for admins
                    if (profile.assigned_districts) {
                        document.getElementById('assignedDistricts').textContent = profile.assigned_districts;
                        document.getElementById('assignedDistrictsInfo').style.display = 'flex';
                    }
                    if (profile.assigned_routes) {
                        document.getElementById('assignedRoutes').textContent = profile.assigned_routes;
                        document.getElementById('assignedRoutesInfo').style.display = 'flex';
                    }
                }
            } catch (error) {
                console.error('Error loading admin profile:', error);
            }
        }

        // Load profile on page load
        loadAdminProfile();

        // Assigned Areas Modal (kept for viewing assigned areas)
        const assignedModal = document.getElementById('assignedModal');
        const closeAssignedModal = document.getElementById('closeAssignedModal');

        closeAssignedModal.addEventListener('click', () => {
            assignedModal.classList.remove('active');
        });

        assignedModal.addEventListener('click', (e) => {
            if (e.target === assignedModal) {
                assignedModal.classList.remove('active');
            }
        });

        async function loadAssignedAreas() {
            const token = localStorage.getItem('token');
            try {
                // Get admin profile data from localStorage or token
                const adminName = localStorage.getItem('userName') || document.getElementById('userName').textContent;
                const adminEmail = localStorage.getItem('userEmail') || 'admin@servonix.com';
                
                // Update admin details
                document.getElementById('adminNameDetail').textContent = adminName;
                document.getElementById('adminEmailDetail').textContent = adminEmail;
                
                const response = await fetch(`${API_BASE}/api/my-assignments`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Calculate counts from array response
                    const districts = [...new Set((data || []).map(a => a.district_name).filter(Boolean))];
                    const routes = [...new Set((data || []).map(a => a.route_name).filter(Boolean))];
                    
                    // Update summary with admin info
                    const summary = `Assigned to ${districts.length} district(s) and ${routes.length} route(s)`;
                    document.getElementById('assignmentSummary').textContent = summary;

                    // Update districts list
                    const districtsList = document.getElementById('districtsList');
                    if (districts.length === 0) {
                        districtsList.innerHTML = `
                            <div class="assigned-empty">
                                <i class="fas fa-inbox"></i>
                                <p>No districts assigned</p>
                            </div>
                        `;
                    } else {
                        districtsList.innerHTML = districts.map((districtName, index) => `
                            <div class="assigned-item" style="animation-delay: ${index * 0.05}s;">
                                <div class="assigned-item-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div class="assigned-item-text">
                                    <strong>${districtName}</strong>
                                </div>
                            </div>
                        `).join('');
                    }

                    // Update routes list
                    const routesList = document.getElementById('routesList');
                    if (routes.length === 0) {
                        routesList.innerHTML = `
                            <div class="assigned-empty">
                                <i class="fas fa-inbox"></i>
                                <p>No routes assigned</p>
                            </div>
                        `;
                    } else {
                        routesList.innerHTML = routes.map(routeName => `
                            <div class="assigned-item">
                                <div class="assigned-item-icon">
                                    <i class="fas fa-route"></i>
                                </div>
                                <div class="assigned-item-text">
                                    <strong>${routeName}</strong>
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    console.log('Could not load assigned areas');
                }
            } catch (error) {
                console.error('Error loading assigned areas:', error);
                alert('Error loading assigned areas');
            }
        }

        // Messaging System
        const mailBtn = document.getElementById('mailBtn');
        const messageModal = document.getElementById('messageModal');
        const closeMessageModal = document.getElementById('closeMessageModal');
        const cancelMessageBtn = document.getElementById('cancelMessageBtn');
        const messageForm = document.getElementById('messageForm');
        const messageReceiver = document.getElementById('messageReceiver');
        const mailBadge = document.getElementById('mailBadge');

        // Open message modal
        if (mailBtn) {
            mailBtn.addEventListener('click', () => {
                openInboxModal();
            });
        }

        // Open inbox modal and load messages
        async function openInboxModal() {
            const inboxModal = document.getElementById('inboxModal');
            const inboxContent = document.getElementById('inboxContent');
            
            inboxModal.style.display = 'flex';
            inboxContent.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i><p>Loading messages...</p></div>';
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/messages/inbox`, {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const messages = data.messages || [];
                    
                    if (messages.length === 0) {
                        inboxContent.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #888;">
                                <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3; margin-bottom: 15px;"></i>
                                <p style="font-size: 1.1rem; font-weight: 500;">No messages yet</p>
                                <p style="font-size: 0.9rem; opacity: 0.7;">Messages from Head Admin will appear here</p>
                            </div>
                        `;
                    } else {
                        let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
                        
                        messages.forEach(msg => {
                            const isUnread = !msg.is_read;
                            const date = new Date(msg.created_at).toLocaleString();
                            
                            html += `
                                <div style="background: ${isUnread ? 'linear-gradient(135deg, #120038, #1a0a4a)' : 'rgba(26, 10, 74, 0.5)'}; border-left: 4px solid ${isUnread ? '#FFD700' : 'rgba(42, 26, 96, 0.8)'}; padding: 15px; border-radius: 8px; transition: all 0.3s;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div>
                                            <strong style="color: white; font-size: 1rem;">
                                                <i class="fas fa-user-shield" style="color: #FFD700; margin-right: 6px;"></i>
                                                ${msg.sender_name}
                                            </strong>
                                            ${isUnread ? '<span style="background: #FFD700; color: #120038; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-weight: 700;">NEW</span>' : ''}
                                        </div>
                                        <small style="color: #C0C0C0; font-size: 0.85rem;">${date}</small>
                                    </div>
                                    <div style="font-weight: 600; color: #FFD700; margin-bottom: 8px;">${msg.subject}</div>
                                    <div style="color: white; line-height: 1.6; white-space: pre-wrap;">${msg.body}</div>
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid rgba(42, 26, 96, 0.5);">
                                        <button onclick="markAsRead(${msg.id})" class="btn btn-sm btn-primary" style="padding: 4px 12px; font-size: 0.85rem;">
                                            <i class="fas fa-check"></i> ${isUnread ? 'Mark as Read' : 'Read'}
                                        </button>
                                        <button onclick="replyToMessage(${msg.sender_id}, '${msg.sender_name.replace(/'/g, "\\'")}', '${msg.subject.replace(/'/g, "\\'")}')\" class="btn btn-sm btn-secondary" style="padding: 4px 12px; font-size: 0.85rem; margin-left: 8px;">
                                            <i class="fas fa-reply"></i> Reply
                                        </button>
                                        <button onclick="deleteMessage(${msg.id})" class="btn btn-sm btn-danger" style="padding: 4px 12px; font-size: 0.85rem; margin-left: 8px;">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        inboxContent.innerHTML = html;
                        
                        // Reset badge
                        mailBadge.style.display = 'none';
                        mailBadge.textContent = '0';
                    }
                } else {
                    inboxContent.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;"><i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Failed to load messages</p></div>';
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                inboxContent.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;"><i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Error loading messages</p></div>';
            }
        }

        // Mark message as read
        async function markAsRead(messageId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/messages/${messageId}/read`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.ok) {
                    openInboxModal(); // Reload inbox
                }
            } catch (error) {
                console.error('Error marking message as read:', error);
            }
        }
        window.markAsRead = markAsRead;

        // Delete message
        async function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/messages/${messageId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.ok) {
                    openInboxModal(); // Reload inbox
                } else {
                    alert('Failed to delete message');
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Error deleting message');
            }
        }
        window.deleteMessage = deleteMessage;

        // Reply to message
        function replyToMessage(senderId, senderName, originalSubject) {
            document.getElementById('inboxModal').style.display = 'none';
            
            const messageModal = document.getElementById('messageModal');
            const messageReceiver = document.getElementById('messageReceiver');
            const messageSubject = document.getElementById('messageSubject');
            const messageBody = document.getElementById('messageBody');
            
            // Load head user
            loadRecipients();
            
            // Set subject
            messageSubject.value = 'Re: ' + originalSubject;
            messageBody.value = '';
            messageBody.focus();
            
            messageModal.classList.add('active');
        }
        window.replyToMessage = replyToMessage;

        // Close inbox modal
        const closeInboxModal = document.getElementById('closeInboxModal');
        if (closeInboxModal) {
            closeInboxModal.addEventListener('click', () => {
                document.getElementById('inboxModal').style.display = 'none';
            });
        }

        document.getElementById('inboxModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'inboxModal') {
                e.target.style.display = 'none';
            }
        });

        // Close message modal
        if (closeMessageModal) {
            closeMessageModal.addEventListener('click', () => {
                messageModal.classList.remove('active');
                messageForm.reset();
                closeAllMenus();
            });
        }

        if (cancelMessageBtn) {
            cancelMessageBtn.addEventListener('click', () => {
                messageModal.classList.remove('active');
                messageForm.reset();
                closeAllMenus();
            });
        }

        messageModal.addEventListener('click', (e) => {
            if (e.target === messageModal) {
                messageModal.classList.remove('active');
                messageForm.reset();
            }
        });

        // Load recipients (head user)
        async function loadRecipients() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/users/head`, {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    messageReceiver.innerHTML = '<option value="">Select recipient...</option>';
                    if (data.user) {
                        const option = document.createElement('option');
                        option.value = data.user.id;
                        option.textContent = `${data.user.name} (Head Admin)`;
                        messageReceiver.appendChild(option);
                    }
                } else {
                    console.error('Failed to load recipients');
                }
            } catch (error) {
                console.error('Error loading recipients:', error);
            }
        }

        // Send message
        if (messageForm) {
            messageForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const receiverId = document.getElementById('messageReceiver').value;
                const subject = document.getElementById('messageSubject').value.trim();
                const body = document.getElementById('messageBody').value.trim();

                if (!receiverId || !subject || !body) {
                    alert('Please fill in all fields');
                    return;
                }

                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/api/messages/send`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({
                            receiver_id: parseInt(receiverId),
                            subject: subject,
                            body: body
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert('Message sent successfully!');
                        messageModal.classList.remove('active');
                        messageForm.reset();
                        closeAllMenus();
                    } else {
                        alert(data.error || 'Failed to send message');
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Failed to send message. Please try again.');
                }
            });
        }

        // Check for new messages
        async function checkMessages() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/messages/inbox`, {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const unreadCount = data.unread_count || 0;
                    
                    if (unreadCount > 0) {
                        mailBadge.textContent = unreadCount;
                        mailBadge.style.display = 'flex';
                        mailBadge.classList.add('pulse');
                    } else {
                        mailBadge.style.display = 'none';
                        mailBadge.classList.remove('pulse');
                    }
                }
            } catch (error) {
                console.error('Error checking messages:', error);
            }
        }

        // Check messages on load and periodically
        checkMessages();
        setInterval(checkMessages, 5000); // Check every 5 seconds

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            const body = document.body;
            const themeIcon = themeToggle.querySelector('i');
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                body.classList.add('dark-theme');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            }
            themeToggle.addEventListener('click', () => {
                body.classList.toggle('dark-theme');
                if (body.classList.contains('dark-theme')) {
                    localStorage.setItem('theme', 'dark');
                    themeIcon.classList.remove('fa-moon');
                    themeIcon.classList.add('fa-sun');
                } else {
                    localStorage.setItem('theme', 'light');
                    themeIcon.classList.remove('fa-sun');
                    themeIcon.classList.add('fa-moon');
                }
            });
        }
    </script>

    <!-- Media Modal -->
    <div id="mediaModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; flex-direction: column; padding: 20px;">
        <div style="position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 15px;">
            <h3 id="mediaModalTitle" style="color: white; font-size: 1.1rem; font-weight: 600;"></h3>
            <button onclick="closeMediaModal()" style="background: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: #333; transition: all 0.3s;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="mediaModalContent" style="max-width: 90%; max-height: 90%; display: flex; align-items: center; justify-content: center;"></div>
    </div>

    <!-- Notification Dropdowns -->
    <div class="notification-dropdown" id="notificationsDropdown">
        <div class="dropdown-header"><h3><i class="fas fa-bell"></i> Notifications</h3></div>
        <div class="dropdown-content" id="notificationsContent"></div>
    </div>
    <div class="notification-dropdown" id="complaintsDropdown">
        <div class="dropdown-header"><h3><i class="fas fa-file-alt"></i> Assigned Complaints</h3></div>
        <div class="dropdown-content" id="complaintsContent"></div>
    </div>
    <div class="notification-dropdown" id="messagesDropdown">
        <div class="dropdown-header"><h3><i class="fas fa-envelope"></i> Messages</h3></div>
        <div class="dropdown-content" id="messagesContent"></div>
    </div>
    <div class="notification-dropdown" id="activityDropdown">
        <div class="dropdown-header"><h3><i class="fas fa-chart-line"></i> Admin Activity</h3></div>
        <div class="dropdown-content" id="activityContent"></div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <i class="fas fa-exclamation-triangle"></i>
                <h3 id="confirmModalTitle">Confirm Action</h3>
            </div>
            <div class="confirm-modal-body">
                <p id="confirmModalMessage">Are you sure you want to proceed?</p>
            </div>
            <div class="confirm-modal-actions">
                <button class="confirm-modal-btn cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="confirm-modal-btn confirm" id="confirmModalBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Functions -->
    <script>
        // ============================================
        // ADMIN DASHBOARD - ALL MISSING FUNCTIONS
        // ============================================
        
        function toggleAdminSelectionMode() {
            console.log('[ADMIN] toggleAdminSelectionMode');
            const checkboxes = document.querySelectorAll('.admin-checkbox-column');
            const isHidden = checkboxes[0]?.style.display === 'none';
            checkboxes.forEach(cb => cb.style.display = isHidden ? 'table-cell' : 'none');
        }
        
        function cancelAdminSelectionMode() {
            console.log('[ADMIN] cancelAdminSelectionMode');
            toggleAdminSelectionMode();
        }
        
        function toggleSelectionMode() {
            console.log('[ADMIN] toggleSelectionMode');
            toggleAdminSelectionMode();
        }
        
        function cancelSelectionMode() {
            console.log('[ADMIN] cancelSelectionMode');
            toggleAdminSelectionMode();
        }
        
        function toggleAdminSelectAll() {
            const selectAll = document.getElementById('adminSelectAll');
            const checkboxes = document.querySelectorAll('.admin-complaint-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll?.checked || false);
            updateAdminDeleteButton();
        }
        
        function updateAdminDeleteButton() {
            const checked = document.querySelectorAll('.admin-complaint-checkbox:checked');
            const deleteBtn = document.getElementById('deleteAdminSelectedBtn');
            const printBtn = document.getElementById('printAdminSelectedBtn');
            const count = checked.length;
            
            if (deleteBtn) {
                if (count > 0) {
                    deleteBtn.style.display = 'inline-block';
                    deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Delete (${count})`;
                } else {
                    deleteBtn.style.display = 'none';
                }
            }
            
            if (printBtn) {
                if (count > 0) {
                    printBtn.style.display = 'inline-block';
                    printBtn.innerHTML = `<i class="fas fa-print"></i> Print (${count})`;
                } else {
                    printBtn.style.display = 'none';
                }
            }
        }
        
        async function deleteAdminSelectedComplaints() {
            console.log('[ADMIN] deleteAdminSelectedComplaints');
            const checked = Array.from(document.querySelectorAll('.admin-complaint-checkbox:checked'));
            const ids = checked.map(cb => cb.dataset.id);
            
            if (ids.length === 0) {
                showMessage('No complaints selected', 'warning');
                return;
            }
            
            if (!confirm(`Delete ${ids.length} complaint(s)?`)) return;
            
            try {
                for (const id of ids) {
                    await apiRequest(`/api/complaints/${id}`, 'DELETE');
                }
                showMessage(`${ids.length} complaint(s) deleted`, 'success');
                loadComplaints();
            } catch (error) {
                console.error('[ADMIN] Error:', error);
                showMessage('Failed to delete complaints', 'error');
            }
        }
        
        function printAdminSelectedComplaints() {
            console.log('[ADMIN] printAdminSelectedComplaints - Exporting PDF');
            
            const printBtn = document.getElementById('printAdminSelectedBtn');
            if (printBtn) {
                const originalText = printBtn.innerHTML;
                printBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                printBtn.disabled = true;
            }
            
            const token = localStorage.getItem('token');
            
            // Download PDF from backend
            fetch(`${API_BASE}/api/admin/export/complaints-pdf`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to generate PDF');
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `complaints_${new Date().getTime()}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showMessage('PDF downloaded successfully!', 'success');
            })
            .catch(error => {
                console.error('PDF generation error:', error);
                showMessage('Failed to generate PDF', 'error');
            })
            .finally(() => {
                if (printBtn) {
                    const checked = document.querySelectorAll('.admin-complaint-checkbox:checked');
                    printBtn.innerHTML = `<i class="fas fa-print"></i> Print (${checked.length})`;
                    printBtn.disabled = false;
                }
            });
        }
        
        // Print All Complaints PDF
        function printAllAdminComplaints() {
            console.log('[ADMIN] printAllAdminComplaints - Exporting PDF');
            
            const token = localStorage.getItem('token');
            
            fetch(`${API_BASE}/api/admin/export/complaints-pdf`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to generate PDF');
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `all_complaints_${new Date().getTime()}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showMessage('PDF downloaded successfully!', 'success');
            })
            .catch(error => {
                console.error('PDF error:', error);
                showMessage('Failed to generate PDF', 'error');
            });
        }
        
        // Print Users PDF
        function printUsersList() {
            console.log('[ADMIN] printUsersList - Exporting PDF');
            
            const token = localStorage.getItem('token');
            
            fetch(`${API_BASE}/api/admin/export/users-pdf`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to generate PDF');
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `users_report_${new Date().getTime()}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showMessage('Users PDF downloaded!', 'success');
            })
            .catch(error => {
                console.error('PDF error:', error);
                showMessage('Failed to generate PDF', 'error');
            });
        }
        
        async function deleteSelectedComplaints() {
            console.log('[ADMIN] deleteSelectedComplaints');
            deleteAdminSelectedComplaints();
        }
        
        function toggleComplaintMenu(complaintId, event) {
            console.log('[ADMIN] toggleComplaintMenu:', complaintId);
            event?.stopPropagation();
            closeAllMenus();
            const menu = document.getElementById(`menu-${complaintId}`);
            if (menu) menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }
        
        function closeAllMenus() {
            document.querySelectorAll('.complaint-dropdown-menu, .dropdown-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        }
        
        function toggleMedia(complaintId) {
            console.log('[ADMIN] toggleMedia:', complaintId);
            const mediaRow = document.getElementById(`media-${complaintId}`);
            if (mediaRow) {
                mediaRow.style.display = mediaRow.style.display === 'none' ? 'table-row' : 'none';
            }
        }
        
        function openMessageModal(email, userName) {
            console.log('[ADMIN] openMessageModal to:', email);
            
            // Remove existing modal if any
            const existingModal = document.getElementById('messageModal');
            if (existingModal) existingModal.remove();
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'messageModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10001;';
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a0a4a, #2a1a60); padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 25px 80px rgba(0,0,0,0.6); border: 2px solid rgba(255,215,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid rgba(255,255,255,0.1);">
                        <h3 style="margin: 0; color: #FFD700; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-paper-plane"></i>
                            Send Message
                        </h3>
                        <button onclick="document.getElementById('messageModal').remove()" style="background: transparent; border: 2px solid rgba(255,255,255,0.3); color: white; font-size: 20px; cursor: pointer; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-bottom: 8px;">To:</div>
                        <div style="background: rgba(255,255,255,0.05); padding: 12px 16px; border-radius: 10px; color: white; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-user" style="color: #FFD700;"></i>
                            <div>
                                <div style="font-weight: 600;">${userName}</div>
                                <div style="font-size: 0.85rem; color: #00FFFF;">${email}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="color: rgba(255,255,255,0.7); font-size: 0.9rem; display: block; margin-bottom: 8px;">Message:</label>
                        <textarea id="messageTextarea" placeholder="Type your message here..." style="width: 100%; min-height: 150px; padding: 15px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(255,255,255,0.05); color: white; font-size: 14px; font-family: inherit; resize: vertical;" onkeydown="if(event.key === 'Escape') document.getElementById('messageModal').remove()" autofocus></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="sendMessageFromModal('${email}')" style="flex: 1; background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 14px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-paper-plane"></i>
                            <span>Send</span>
                        </button>
                        <button onclick="document.getElementById('messageModal').remove()" style="background: #6b7280; color: white; border: none; padding: 14px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus the textarea
            setTimeout(() => {
                const textarea = document.getElementById('messageTextarea');
                if (textarea) textarea.focus();
            }, 100);
            
            // Close on backdrop click
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        
        async function sendMessageFromModal(email) {
            const textarea = document.getElementById('messageTextarea');
            const message = textarea ? textarea.value.trim() : '';
            
            if (!message) {
                showMessage('Please enter a message', 'error');
                return;
            }
            
            try {
                const response = await apiRequest('/api/messages/send', {
                    method: 'POST',
                    body: JSON.stringify({
                        recipient_email: email,
                        subject: 'Message from SERVONIX Admin',
                        message: message
                    })
                });
                
                if (response.ok) {
                    showMessage('Message sent successfully!', 'success');
                    document.getElementById('messageModal').remove();
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to send message', 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showMessage('Failed to send message. Please try again.', 'error');
            }
        }
        
        function sendMessage(email) {
            openMessageModal(email, 'User');
        }
        
        function openMediaViewer(fileUrl, fileName, mimeType) {
            // Remove existing modal
            const existingModal = document.getElementById('mediaViewerModal');
            if (existingModal) existingModal.remove();
            
            const isImage = mimeType && mimeType.startsWith('image/');
            const isVideo = mimeType && mimeType.startsWith('video/');
            const isPDF = mimeType && (mimeType === 'application/pdf' || mimeType.includes('pdf'));
            
            let mediaContent = '';
            if (isImage) {
                mediaContent = `<img src="${fileUrl}" style="max-width: 100%; max-height: 80vh; object-fit: contain; border-radius: 8px;" alt="${fileName}">`;
            } else if (isVideo) {
                mediaContent = `<video controls style="max-width: 100%; max-height: 80vh; border-radius: 8px;"><source src="${fileUrl}" type="${mimeType}">Your browser does not support video playback.</video>`;
            } else if (isPDF) {
                mediaContent = `<iframe src="${fileUrl}" style="width: 100%; height: 80vh; border: none; border-radius: 8px;"></iframe>`;
            } else {
                mediaContent = `<div style="text-align: center; padding: 40px;"><i class="fas fa-file" style="font-size: 4rem; color: #9333EA; margin-bottom: 20px;"></i><p style="color: white; font-size: 1.2rem;">${fileName}</p><a href="${fileUrl}" download style="display: inline-block; margin-top: 20px; background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600;"><i class="fas fa-download"></i> Download File</a></div>`;
            }
            
            const modal = document.createElement('div');
            modal.id = 'mediaViewerModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 20000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="document.getElementById('mediaViewerModal').remove()">
                    <div style="max-width: 1200px; width: 100%; position: relative;" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 10px;">
                            <div style="color: white; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-${isImage ? 'image' : isVideo ? 'video' : 'file'}" style="color: #FFD700;"></i>
                                <span>${fileName}</span>
                            </div>
                            <button onclick="document.getElementById('mediaViewerModal').remove()" style="background: rgba(255,255,255,0.1); border: 2px solid #FFD700; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#FFD700'; this.style.color='#1a0a4a'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.color='white'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="background: rgba(26, 10, 74, 0.5); padding: 20px; border-radius: 12px; border: 2px solid rgba(255, 215, 0, 0.3); text-align: center;">
                            ${mediaContent}
                        </div>
                        <div style="display: flex; justify-content: center; gap: 12px; margin-top: 20px;">
                            <a href="${fileUrl}" download style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; text-decoration: none; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <i class="fas fa-download"></i>
                                <span>Download</span>
                            </a>
                            <button onclick="window.open('${fileUrl}', '_blank')" style="background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <i class="fas fa-external-link-alt"></i>
                                <span>Open in New Tab</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeComplaintModal() {
            const modal = document.getElementById('complaintModal');
            if (modal) modal.classList.remove('active');
        }
        
        function closeMediaModal() {
            const modal = document.getElementById('mediaModal');
            if (modal) modal.style.display = 'none';
        }
        
        window.toggleAdminSelectionMode = toggleAdminSelectionMode;
        window.cancelAdminSelectionMode = cancelAdminSelectionMode;
        window.toggleSelectionMode = toggleSelectionMode;
        window.cancelSelectionMode = cancelSelectionMode;
        window.toggleAdminSelectAll = toggleAdminSelectAll;
        window.updateAdminDeleteButton = updateAdminDeleteButton;
        window.deleteAdminSelectedComplaints = deleteAdminSelectedComplaints;
        window.printAdminSelectedComplaints = printAdminSelectedComplaints;
        window.printAllAdminComplaints = printAllAdminComplaints;
        window.printUsersList = printUsersList;
        window.printAdminSelectedComplaints = printAdminSelectedComplaints;
        window.deleteSelectedComplaints = deleteSelectedComplaints;
        window.toggleComplaintMenu = toggleComplaintMenu;
        window.closeAllMenus = closeAllMenus;
        window.toggleMedia = toggleMedia;
        window.sendMessage = sendMessage;
        window.openMessageModal = openMessageModal;
        window.sendMessageFromModal = sendMessageFromModal;
        window.openMediaViewer = openMediaViewer;
        window.closeComplaintModal = closeComplaintModal;
        window.closeMediaModal = closeMediaModal;
        // quickReply, sendQuickReplyMessage, showInlineStatusUpdater, submitInlineStatus, viewComplaintDetails 
        // are already exposed in their defining script blocks
    </script>

    <style>
        /* Theme toggle button for admin dashboard */
        .theme-toggle-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: 2px solid rgba(79, 70, 229, 0.3);
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle-btn i {
            font-size: 1.4rem;
            color: #FFD700;
            transition: all 0.3s ease;
        }

        body.dark-mode .theme-toggle-btn {
            background: rgba(58, 58, 58, 0.95);
            border-color: rgba(192, 192, 192, 0.3);
        }

        body.dark-mode .theme-toggle-btn i {
            color: #C0C0C0;
        }

        body.dark-mode .theme-toggle-btn i {
            color: #C0C0C0;
        }
    </style>

    <!-- Compose Message Modal -->
    <div id="composeModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); border-radius: var(--radius-lg); padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border: 2px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-paper-plane"></i> Compose Message to Head
                </h3>
                <button onclick="closeComposeModal()" style="background: none; border: none; color: var(--text-400); font-size: 24px; cursor: pointer;">&times;</button>
            </div>

            <form id="composeForm" onsubmit="sendMessage(event)">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-100);">Subject *</label>
                    <input type="text" id="messageSubject" required maxlength="200" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border); background: rgba(255,255,255,0.05); color: var(--text-100); font-size: 14px;"
                           placeholder="Enter message subject">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-100);">Message *</label>
                    <textarea id="messageContent" required maxlength="5000" rows="8"
                              style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border); background: rgba(255,255,255,0.05); color: var(--text-100); font-size: 14px; resize: vertical;"
                              placeholder="Type your message here..."></textarea>
                    <div style="text-align: right; font-size: 12px; color: var(--text-400); margin-top: 5px;">
                        <span id="charCount">0</span>/5000 characters
                    </div>
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-100);">
                        <i class="fas fa-link"></i> Link Complaint (Optional)
                    </label>
                    <select id="complaintLink" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border); background: rgba(255,255,255,0.05); color: var(--text-100); font-size: 14px;">
                        <option value="">-- No complaint linked --</option>
                    </select>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" onclick="closeComposeModal()" style="padding: 12px 24px; border-radius: 8px; border: 2px solid var(--border); background: transparent; color: var(--text-100); cursor: pointer; font-weight: 600;">
                        Cancel
                    </button>
                    <button type="submit" style="padding: 12px 24px; border-radius: 8px; border: none; background: var(--primary); color: var(--bg-900); cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-paper-plane"></i> Send Message
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Message Modal -->
    <div id="viewMessageModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); border-radius: var(--radius-lg); padding: 30px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; border: 2px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px;">
                <div>
                    <h3 id="viewMessageSubject" style="font-size: 22px; font-weight: 700; margin-bottom: 10px; color: var(--text-100);"></h3>
                    <div id="viewMessageMeta" style="font-size: 13px; color: var(--text-400); display: flex; gap: 20px; flex-wrap: wrap;"></div>
                </div>
                <button onclick="closeViewMessageModal()" style="background: none; border: none; color: var(--text-400); font-size: 24px; cursor: pointer;">&times;</button>
            </div>

            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--primary);">
                <div style="font-size: 13px; color: var(--text-400); margin-bottom: 10px;">Your Message:</div>
                <div id="viewMessageContent" style="color: var(--text-100); line-height: 1.6; white-space: pre-wrap;"></div>
            </div>

            <div id="complaintInfo" style="display: none; background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #FFD700;">
                <div style="font-size: 13px; color: var(--text-400); margin-bottom: 8px;">
                    <i class="fas fa-link"></i> Linked Complaint:
                </div>
                <div id="complaintDetails" style="color: var(--text-100); font-size: 14px;"></div>
            </div>

            <div id="replySection" style="display: none;">
                <div style="background: rgba(22, 199, 130, 0.1); padding: 20px; border-radius: 12px; border-left: 4px solid #16c782;">
                    <div style="font-size: 13px; color: var(--text-400); margin-bottom: 10px; display: flex; justify-content: space-between;">
                        <span><i class="fas fa-reply"></i> Head's Reply:</span>
                        <span id="replyTime"></span>
                    </div>
                    <div id="replyContent" style="color: var(--text-100); line-height: 1.6; white-space: pre-wrap;"></div>
                </div>
            </div>

            <div id="noReply" style="text-align: center; padding: 30px; color: var(--text-400); font-style: italic;">
                <i class="fas fa-clock"></i> Waiting for Head's response...
            </div>

            <div style="text-align: right; margin-top: 20px;">
                <button onclick="closeViewMessageModal()" style="padding: 12px 24px; border-radius: 8px; border: 2px solid var(--border); background: transparent; color: var(--text-100); cursor: pointer; font-weight: 600;">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Theme Toggle Button (Fixed Bottom Right) -->
    <button class="theme-toggle-btn" id="themeToggle" title="Toggle Dark/Light Mode">
        <i class="fas fa-moon"></i>
    </button>

    <!-- Media Handler for graceful 404 fallbacks -->
    <script src="js/media-handler.js"></script>

</body>
</html>

